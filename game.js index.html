<script>
(() => {
  // ===== Extra Game State =====
  let coins = 20;
  const quests = [
    {id:1, text:"Catch 5 Simitaurs (Reward: 50 coins)", goal:5, progress:0, reward:50, type:"simitaur", completed:false},
    {id:2, text:"Catch 1 Exotic Simitaur (Reward: 100 coins)", goal:1, progress:0, reward:100, type:"Exotic", completed:false}
  ];

  // ===== HUD Additions =====
  const hud = document.getElementById('hud');
  const coinBox = document.createElement('div');
  coinBox.id = 'coinBox';
  coinBox.style.cssText = "background:#ffd166;color:#222;font-weight:bold;padding:6px 12px;border-radius:16px;align-self:center;";
  coinBox.textContent = "ðŸ’° " + coins;
  hud.prepend(coinBox);

  const shopBtn = document.createElement('button');
  shopBtn.id = 'btnShop';
  shopBtn.className = 'pill';
  shopBtn.textContent = 'Shop';
  hud.appendChild(shopBtn);

  const questBtn = document.createElement('button');
  questBtn.id = 'btnQuest';
  questBtn.className = 'pill';
  questBtn.textContent = 'Quests';
  hud.appendChild(questBtn);

  // ===== Overlay Panels (not full-screen) =====
  function makeOverlay(id, title, innerId){
    const panel = document.createElement('div');
    panel.id = id;
    panel.style.cssText = `
      position:fixed;top:50px;left:50%;transform:translateX(-50%);
      background:#16261a;border:2px solid #ffd166;border-radius:12px;
      box-shadow:0 0 25px rgba(0,0,0,0.6);padding:14px 18px;z-index:9999;
      min-width:320px;max-width:90%;display:none;color:#fff;
    `;
    panel.innerHTML = `
      <h2 style="margin-top:0;color:#ffd166">${title}</h2>
      <div id="${innerId}" style="max-height:60vh;overflow:auto"></div>
      <div style="text-align:center;margin-top:10px"><button class="btn" onclick="document.getElementById('${id}').style.display='none'">Close</button></div>
    `;
    document.body.appendChild(panel);
    return panel;
  }

  const shopPanel = makeOverlay('shopPanel','Marketplace','simdexList');
  const questPanel = makeOverlay('questPanel','Quests','questList');

  // ===== Functions =====
  function updateCoins(amount){
    coins += amount;
    document.getElementById('coinBox').textContent = "ðŸ’° " + coins;
  }

  function renderShop(){
    shopPanel.style.display = 'block';
    const list = document.getElementById('simdexList');
    list.innerHTML = '';
    if(window.Simitaur?.player?.sims?.length){
      window.Simitaur.player.sims.forEach(sim=>{
        const div = document.createElement('div');
        div.style.marginBottom = '10px';
        div.innerHTML = `<b>${sim.type.name}</b> â€” HP: ${sim.hp}/${sim.maxHp}<br>`;
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = 'Heal (5 coins)';
        btn.onclick = ()=> healSim(sim);
        div.appendChild(btn);
        list.appendChild(div);
      });
    } else {
      list.innerHTML = '<p style="opacity:.8">No Sims in your team.</p>';
    }
  }

  function healSim(sim){
    if(coins < 5) return alert("Not enough coins!");
    if(sim.hp >= sim.maxHp) return alert(sim.type.name + " is already at full HP!");
    coins -= 5;
    sim.hp = sim.maxHp;
    updateCoins(0);
    renderShop();
  }

  function renderQuests(){
    questPanel.style.display = 'block';
    const list = document.getElementById('questList');
    list.innerHTML = '';
    quests.forEach(q=>{
      const div = document.createElement('div');
      div.style.marginBottom = '12px';
      div.innerHTML = `<b>${q.text}</b><br>Progress: ${q.progress}/${q.goal}<br>`;
      if(!q.completed && q.progress >= q.goal){
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = 'Claim Reward';
        btn.onclick = ()=>{
          updateCoins(q.reward);
          q.completed = true;
          renderQuests();
        };
        div.appendChild(btn);
      } else if(q.completed){
        div.innerHTML += `<i>Completed âœ…</i>`;
      }
      list.appendChild(div);
    });
  }

  // ===== Wire Buttons =====
  shopBtn.onclick = renderShop;
  questBtn.onclick = renderQuests;

  // ===== Hook into SimDex updates =====
  const oldBuildDex = window.Simitaur ? window.Simitaur.buildDex : null;
  if(oldBuildDex){
    window.Simitaur.buildDex = function(){
      oldBuildDex();
      // update quest progress for "catch" type
      const keys = Object.keys(window.Simitaur.simdex||{});
      quests.forEach(q=>{
        if(q.type.toLowerCase()==='simitaur') q.progress = keys.length;
        if(q.type.toLowerCase()==='exotic'){
          q.progress = keys.filter(k=>window.Simitaur.simdex[k].rarity==='Exotic').length;
        }
      });
    };
  }

  // initial coin display
  updateCoins(0);
})();
</script>
