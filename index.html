<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Simitaur Adventure — Quests • Coins • Shop • Mini-Map</title>
<style>
  :root{
    --bg:#0e1610; --panel:rgba(6,8,6,.92);
    --card:#16261a; --accent:#ffd166; --btn:#2f6e3a; --btn-h:#3f8e4d;
    --danger:#ff5b5b; --ink:#d8ffe5; --ring:#2f5b3f;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#fff}
  .wrap{max-width:1100px;margin:10px auto;padding:8px}
  canvas#game{
    display:block;margin:10px auto;border:3px solid #274f34;background:#87d594;
    image-rendering:pixelated;image-rendering:crisp-edges;touch-action:none
  }
  /* HUD */
  #hud{position:fixed;top:10px;left:10px;right:10px;display:flex;gap:8px;z-index:60;flex-wrap:wrap;align-items:center}
  .pill{background:var(--btn);border:none;color:#fff;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer;box-shadow:0 3px 0 #204c28}
  .pill:active{transform:translateY(1px)}
  .pill.secondary{background:#24422b}
  .stat{display:flex;align-items:center;gap:8px;background:#14251a;border:1px solid var(--ring);border-radius:999px;padding:6px 10px;font-weight:800}
  .stat img{width:18px;height:18px}
  #coinGain{position:fixed;top:12px;right:16px;font-weight:900;color:#ffe79a;text-shadow:0 2px 0 #7a5b00,0 0 10px rgba(255,215,0,.6);pointer-events:none;z-index:70;opacity:0;transition:transform .5s ease,opacity .5s ease}
  /* DPad */
  #dpad{
    position:fixed;left:12px;bottom:12px;display:grid;
    grid-template-columns:56px 56px;grid-template-rows:56px 56px 56px;gap:8px;z-index:60
  }
  #dpad button{width:56px;height:56px;border-radius:12px;border:none;background:#254b2d;color:white;font-weight:900;box-shadow:0 3px 0 #173221;font-size:20px;user-select:none}
  #dpad .ghost{opacity:.7}
  /* Panels / Modals */
  .panel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--panel);backdrop-filter:blur(3px);z-index:80}
  .panel.show{display:flex}
  .box{background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:16px 20px;box-shadow:0 12px 36px rgba(0,0,0,.6);max-width:94vw;color:var(--ink)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button.btn{background:var(--btn);border:none;border-radius:8px;padding:8px 12px;color:#fff;font-weight:700;cursor:pointer}
  button.btn:hover{background:var(--btn-h)}
  .danger{background:var(--danger)}
  .hp{width:240px;height:16px;background:#102016;border-radius:8px;overflow:hidden;border:1px solid #000}
  .fill{height:100%;background:#ff6b6b;width:100%;transition:width .18s linear}
  .label{font-weight:800;margin-bottom:4px}
  /* SimDex */
  #dexGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;max-height:60vh;overflow:auto}
  .dexCard{display:flex;gap:10px;align-items:center;background:#203425;border:2px solid #2f5b3f;border-radius:12px;padding:10px;cursor:pointer;position:relative}
  .dexCard img{width:64px;height:64px;object-fit:cover;border-radius:8px;background:#0b150e}
  .rarity-Common{border-color:rgba(120,180,255,0.15)}
  .rarity-Uncommon{border-color:#a0a7ad}
  .rarity-Rare{border-color:#a56cff;box-shadow:0 0 12px rgba(165,108,255,.12)}
  .rarity-Legendary{border-color:gold;animation:legendGlow 1.6s infinite}
  @keyframes legendGlow{0%{box-shadow:0 0 6px gold}50%{box-shadow:0 0 18px gold}100%{box-shadow:0 0 6px gold}}
  .rarity-Mythic{border-color:#7b56ff;animation:mythGlow 1.6s infinite}
  @keyframes mythGlow{0%{box-shadow:0 0 6px #7b56ff}50%{box-shadow:0 0 14px #45b6ff}100%{box-shadow:0 0 6px #7b56ff}}
  .rarity-Exotic{border:3px solid transparent;animation:exoticRainbow 2s linear infinite}
  @keyframes exoticRainbow{
    0%{border-color:#ff0000}14%{border-color:#ff7f00}28%{border-color:#ffff00}42%{border-color:#00ff00}
    56%{border-color:#0000ff}70%{border-color:#4b0082}84%{border-color:#8f00ff}100%{border-color:#ff0000}
  }
  .muted{opacity:.8}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#233b29;border:1px solid #2e5a3b;border-radius:6px;padding:2px 6px}
  .note{font-size:12px;opacity:.8}
  /* Draggable windows (Shop/Settings/Quests) */
  .float{position:fixed;top:80px;left:60px;z-index:85;background:var(--card);border:1px solid var(--ring);border-radius:14px;box-shadow:0 12px 36px rgba(0,0,0,.6);display:none;min-width:320px;max-width:90vw}
  .float.show{display:block}
  .float .titlebar{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #2f5b3f;cursor:move;border-radius:14px 14px 0 0;background:#1a2b20}
  .float .content{padding:12px;max-height:60vh;overflow:auto}
  .closeX{background:#254b2d;border:1px solid #2f5b3f;color:#fff;border-radius:8px;padding:4px 8px;cursor:pointer}
  /* Shop list */
  .healRow{display:flex;justify-content:space-between;align-items:center;padding:8px;border:1px solid #2f5b3f;border-radius:10px;margin-bottom:8px}
  .bar{height:8px;background:#0c160f;border:1px solid #000;border-radius:999px;overflow:hidden}
  .bar > i{display:block;height:100%;background:#24d17b;width:50%;transition:width .25s ease}
  /* Mini-map */
  #minimapWrap{position:fixed;right:12px;bottom:12px;z-index:65;display:flex;flex-direction:column;gap:6px;align-items:flex-end}
  #minimap{width:160px;height:160px;border:2px solid #274f34;background:#0b140c;image-rendering:pixelated}
  #btnMini{background:#1d3524;border:1px solid #2c563b;border-radius:8px;color:#eafff0;padding:6px 10px;cursor:pointer}
  /* Small screens */
  @media (max-width:860px){
    canvas#game{width:94vw;height:auto}
    #dpad{left:50%;transform:translateX(-50%);grid-template-columns:64px 64px;grid-template-rows:64px 64px 64px}
    #dpad button{width:64px;height:64px;border-radius:14px;font-size:22px}
    #hud{left:8px;right:8px;justify-content:center}
  }
</style>
</head>
<body>
<div class="wrap">
  <canvas id="game" width="640" height="640"></canvas>
</div>

<!-- HUD -->
<div id="hud" style="display:none">
  <div class="stat" title="Coins"><svg width="18" height="18" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#ffd166"/><circle cx="12" cy="12" r="6" fill="#d8a800"/></svg><span id="coinLabel">0</span></div>
  <button id="btnSettings" class="pill">Settings</button>
  <button id="btnDex" class="pill">SimDex</button>
  <button id="btnShop" class="pill">Shop</button>
  <button id="btnQuests" class="pill">Quests</button>
  <button id="btnMusic" class="pill">Music: On</button>
  <button id="btnSignOut" class="pill secondary">Sign Out</button>
</div>
<div id="coinGain">+5</div>

<!-- Dpad -->
<div id="dpad" style="display:none">
  <button id="padUp" class="ghost">▲</button>
  <button id="padLeft">◀</button>
  <button id="padRight">▶</button>
  <button id="padDown" class="ghost">▼</button>
</div>

<!-- MENU -->
<div id="menu" class="panel show">
  <div class="box" style="text-align:center;max-width:520px">
    <h1 style="margin:6px 0 2px">Simitaur Adventure</h1>
    <p class="muted" style="margin:0 0 10px">Explore, catch, and battle Simitaurs. Upload sprites in <b>Settings</b>. Catching grants coins. Heal in the Shop.</p>
    <div id="signin-area">
      <input id="playerName" placeholder="Player name" style="padding:10px;width:86%;margin:6px;border-radius:8px;border:1px solid #274f34;background:#0f1b13;color:#eafff0"><br>
      <input id="playerPass" placeholder="Password" type="password" style="padding:10px;width:86%;margin:6px;border-radius:8px;border:1px solid #274f34;background:#0f1b13;color:#eafff0"><br>
      <label style="display:flex;align-items:center;justify-content:center;margin-top:4px"><input id="rememberMe" type="checkbox" style="margin-right:8px"> Remember Me</label>
      <div class="row" style="justify-content:center;margin-top:12px">
        <button id="btnSignIn" class="btn">Sign In</button>
        <button id="btnGuest" class="btn">Play as Guest</button>
      </div>
    </div>
    <div id="menu-main" style="display:none;margin-top:10px" class="row">
      <button id="btnStart" class="btn" style="padding:10px 16px">Start Game</button>
      <button id="btnOpenSettings" class="btn">Settings</button>
      <button id="btnOpenDexPanel" class="btn">SimDex</button>
    </div>
    <p class="note">Controls: <span class="kbd">Arrow Keys / WASD</span> or on-screen D-Pad • Walk onto sims to interact</p>
  </div>
</div>

<!-- Settings (draggable) -->
<div id="settingsWin" class="float" style="top:96px;left:80px">
  <div class="titlebar"><b>Settings & Uploads</b><button class="closeX" data-close="#settingsWin">Close</button></div>
  <div class="content">
    <div class="row" style="gap:14px">
      <label>Player Sprite<input id="filePlayer" type="file" accept="image/*" style="display:block;margin-top:6px"></label>
      <label>Charcoal (NPC) Sprite<input id="fileNPC" type="file" accept="image/*" style="display:block;margin-top:6px"></label>
      <label>SimNet (catch image)<input id="fileNet" type="file" accept="image/*" style="display:block;margin-top:6px"></label>
    </div>
    <div style="height:8px"></div>
    <div class="row" style="gap:14px;flex-wrap:wrap">
      <label>Sim Sprite Slot 1<input class="fileSim" data-id="0" type="file" accept="image/*" style="display:block;margin-top:6px"></label>
      <label>Sim Sprite Slot 2<input class="fileSim" data-id="1" type="file" accept="image/*" style="display:block;margin-top:6px"></label>
      <label>Sim Sprite Slot 3<input class="fileSim" data-id="2" type="file" accept="image/*" style="display:block;margin-top:6px"></label>
      <label>Sim Sprite Slot 4<input class="fileSim" data-id="3" type="file" accept="image/*" style="display:block;margin-top:6px"></label>
      <label>Sim Sprite Slot 5<input class="fileSim" data-id="4" type="file" accept="image/*" style="display:block;margin-top:6px"></label>
      <label>Sim Sprite Slot 6<input class="fileSim" data-id="5" type="file" accept="image/*" style="display:block;margin-top:6px"></label>
    </div>
    <div class="row" style="justify-content:space-between;margin-top:12px;align-items:center">
      <div>
        <label style="display:flex;gap:8px;align-items:center"><input id="toggleMusic" type="checkbox" checked> Music</label>
        <label style="display:flex;gap:8px;align-items:center;margin-top:6px"><input id="toggleSfx" type="checkbox" checked> Sound Effects</label>
        <div class="note" style="margin-top:6px">Tip: upload square-ish images. "Remember Me" saves your team, SimDex, coins & settings.</div>
      </div>
    </div>
  </div>
</div>

<!-- SimDex (modal) -->
<div id="dex" class="panel">
  <div class="box" style="max-width:980px">
    <h2 style="margin-top:0">Your SimDex</h2>
    <div id="dexGrid"></div>
    <div style="text-align:center;margin-top:10px"><button id="btnCloseDex" class="btn">Close</button></div>
  </div>
</div>

<!-- Shop (draggable) -->
<div id="shopWin" class="float" style="top:140px;left:120px">
  <div class="titlebar"><b>Shop — Heals & Items</b><button class="closeX" data-close="#shopWin">Close</button></div>
  <div class="content">
    <div id="shopCoins" class="note" style="margin-bottom:10px">Coins: 0</div>
    <div id="healList"></div>
    <div style="height:8px"></div>
    <div style="text-align:center">
      <button id="btnHealAny" class="btn">Heal any Sim (10)</button>
    </div>
  </div>
</div>

<!-- Quests (draggable) -->
<div id="questWin" class="float" style="top:180px;left:160px">
  <div class="titlebar"><b>Quests</b><button class="closeX" data-close="#questWin">Close</button></div>
  <div class="content">
    <div id="questList"></div>
  </div>
</div>

<!-- Encounter panel -->
<div id="encounterPanel" class="panel">
  <div class="box">
    <h2 id="encounterTitle" style="margin-top:0">Encounter</h2>
    <div class="row" style="justify-content:center">
      <button id="btnFight" class="btn">Battle</button>
      <button id="btnCatchSim" class="btn">Catch (SimNet)</button>
      <button id="btnRun" class="btn danger">Run</button>
    </div>
  </div>
</div>

<!-- Choose Sim for battle -->
<div id="chooseSimPanel" class="panel">
  <div class="box" style="max-width:620px">
    <h2 style="margin-top:0">Choose a Sim to battle</h2>
    <div id="chooseSimList" class="row" style="justify-content:center"></div>
    <div style="text-align:center;margin-top:8px"><button id="btnCancelChoose" class="btn">Cancel</button></div>
  </div>
</div>

<!-- Choose Sim to heal from SimDex -->
<div id="chooseHealPanel" class="panel">
  <div class="box" style="max-width:620px">
    <h2 style="margin-top:0">Choose a Sim to Heal (10 coins)</h2>
    <div id="chooseHealList" class="row" style="justify-content:center;gap:8px;flex-wrap:wrap"></div>
    <div style="text-align:center;margin-top:8px"><button id="btnCancelHeal" class="btn">Cancel</button></div>
  </div>
</div>

<!-- Battle panel -->
<div id="battlePanel" class="panel">
  <div class="box">
    <h2 id="battleTitle" style="margin-top:0">Battle</h2>
    <div class="row" style="justify-content:center;gap:26px">
      <div style="text-align:center">
        <div id="playerLabel" class="label">You</div>
        <div class="hp"><div id="hpYou" class="fill"></div></div>
      </div>
      <div style="text-align:center">
        <div id="enemyLabel" class="label">Enemy</div>
        <div class="hp"><div id="hpEnemy" class="fill"></div></div>
      </div>
    </div>
    <div id="battleButtons" class="row" style="justify-content:center;margin-top:10px"></div>
    <div style="text-align:center;margin-top:10px"><button id="btnRunBattle" class="btn danger">Run</button></div>
  </div>
</div>

<!-- Mini-map -->
<div id="minimapWrap">
  <canvas id="minimap" width="160" height="160"></canvas>
  <button id="btnMini">Hide Mini-Map</button>
</div>

<script>
/* ===========================================================
   Simitaur Adventure — Full working build
   - visible sims only, smooth camera, draggable windows
   - shop heal can heal a SimDex entry for 10 coins
   =========================================================== */

(() => {
  // ----- Canvas & world settings -----
  const cvs = document.getElementById('game'), ctx = cvs.getContext('2d');
  const mini = document.getElementById('minimap'), mctx = mini.getContext('2d');
  const TILE = 64, VIEW_W = 10, VIEW_H = 10;
  const MAP_W = 100, MAP_H = 100;

  // ----- State -----
  let mode = 'menu'; // menu, world, battle
  const player = {
    x: Math.floor(MAP_W/2), y: Math.floor(MAP_H/2),
    hp:100, maxHp:100, img: null, sims: [], xp:0, name:'', pass:''
  };
  const npc = { x: Math.floor(MAP_W/2) + 3, y: Math.floor(MAP_H/2), img: null, name: 'Charcoal' };
  let netImage = null;

  // Economy / Quests
  let coins = 0;
  const quests = [
    { id:'q1', name:'Catch 5 Simitaurs', goal:5, progress:0, reward:25, done:false },
    { id:'q2', name:'Catch 1 Exotic', goal:1, progress:0, reward:50, done:false },
  ];

  // World sims
  let sims = [];            // visible wild sims positions
  let simdex = {};          // caught index {id: {name,rarity,hp,maxHp,size,weight,src}}
  let currentEncounter = null; // sim object
  let battlePlayerSim = null, battleEnemySim = null;

  // Audio toggles
  let musicOn = true, sfxOn = true;

  // ----- Types & rarities -----
  const types = [
    { id:0, name:'Frostaur', img:null, src:'', baseRarityWeights:[60,25,10,3,1,1] },
    { id:1, name:'Rockaur',  img:null, src:'', baseRarityWeights:[40,30,18,8,3,1] },
    { id:2, name:'Leafaur',  img:null, src:'', baseRarityWeights:[30,30,20,12,6,2] },
    { id:3, name:'Stormaur', img:null, src:'', baseRarityWeights:[36,28,20,10,5,1] },
    { id:4, name:'Flametaur',img:null, src:'', baseRarityWeights:[42,30,16,8,3,1] },
    { id:5, name:'Aquataur', img:null, src:'', baseRarityWeights:[34,30,20,10,5,1] }
  ];
  const RARITIES = ['Common','Uncommon','Rare','Legendary','Mythic','Exotic'];

  // ----- Audio (procedural; self-contained) -----
  const AC = window.AudioContext || window.webkitAudioContext;
  const audio = new AC();
  let musicToken = 0;
  function ensureAudio(){ if(audio.state === 'suspended') audio.resume(); }
  function tone(freq, dur=0.12, type='square', vol=0.06){
    if(!sfxOn) return;
    const t0 = audio.currentTime;
    const o = audio.createOscillator(), g = audio.createGain();
    o.type = type; o.frequency.value = freq; g.gain.value = vol;
    o.connect(g); g.connect(audio.destination);
    o.start(t0);
    const a=0.004, r=0.03;
    g.gain.setValueAtTime(0, t0);
    g.gain.linearRampToValueAtTime(vol, t0+a);
    g.gain.linearRampToValueAtTime(0.0001, t0+dur-r);
    o.stop(t0+dur);
  }
  const sfx = {
    step(){ tone(220+Math.random()*20, .06, 'triangle', .04); },
    atk(){ tone(740, .09, 'square', .07); tone(620, .06, 'square', .06); },
    battleStart(){ tone(330,.08,'square',.07); setTimeout(()=>tone(660,.12,'square',.07),80); },
    catch(){ tone(520,.18,'square',.07); setTimeout(()=>tone(880,.12,'square',.06),140); },
    win(){ tone(880,.14,'sawtooth',.08); setTimeout(()=>tone(660,.12,'square',.05),120); },
    escape(){ tone(180,.12,'triangle',.05); },
    coin(){ tone(1400,.08,'triangle',.05); },
    heal(){ tone(520,.06,'sine',.05); setTimeout(()=>tone(620,.06,'sine',.05),70); setTimeout(()=>tone(740,.06,'sine',.05),140); }
  };
  function startMusic(){
    if(!musicOn) return;
    ensureAudio();
    const token = ++musicToken;
    const key = [196,220,247,262,294,330,349,392];
    const tempo = 112;
    const spb = 60/tempo;
    let step = 0;
    (function loop(){
      if(!musicOn || token !== musicToken) return;
      const t0 = audio.currentTime + 0.02;
      scheduleBass([98,98,110,123,98,110,130,147][step%8], t0, spb);
      const chord = [[key[0],key[2],key[4]],[key[1],key[3],key[5]],[key[2],key[4],key[6]],[key[3],key[5],key[7]]][(Math.floor(step/2))%4];
      scheduleArp(chord, t0, spb); schedulePerc(t0+spb*0.5);
      step++; setTimeout(loop, spb*1000*2);
    })();
  }
  function scheduleBass(freq,t0,spb){ const o=audio.createOscillator(), g=audio.createGain(); o.type='square'; o.frequency.value=freq; g.gain.value=0.06; o.connect(g); g.connect(audio.destination); const a=0.005; g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(0.08,t0+a); g.gain.linearRampToValueAtTime(0.03,t0+0.08); g.gain.linearRampToValueAtTime(0.0001,t0+spb*2-0.06); o.start(t0); o.stop(t0+spb*2); }
  function scheduleArp(notes,t0,spb){ [0, spb*0.5, spb*1.0, spb*1.5].forEach((off,i)=>{ const o=audio.createOscillator(), g=audio.createGain(); o.type='triangle'; o.frequency.value = notes[i%notes.length]; g.gain.value=0.05; o.connect(g); g.connect(audio.destination); g.gain.setValueAtTime(0,t0+off); g.gain.linearRampToValueAtTime(0.06,t0+off+0.005); g.gain.linearRampToValueAtTime(0.0001,t0+off+spb*0.45-0.03); o.start(t0+off); o.stop(t0+off+spb*0.5); }); }
  function schedulePerc(t){ const n=audio.createBufferSource(); const len=2200; const buf=audio.createBuffer(1,len,audio.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<len;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/len,2); n.buffer=buf; const g=audio.createGain(); g.gain.value=0.06; n.connect(g); g.connect(audio.destination); n.start(t); }

  // ----- Save / Load -----
  const SAVE_KEY = 'simitaur_save_v4';
  function saveGame(){
    try{
      const store = {
        player:{ name:player.name, pass:player.pass,
          sims: player.sims.map(s=>({typeId:s.type.id,hp:s.hp,maxHp:s.maxHp,attacks:s.attacks,rarity:s.rarity,size:s.size,weight:s.weight})) },
        simdex,
        typesMeta: types.map(t=>({id:t.id,src:t.src||''})),
        npcSrc: npc.img?.src || '',
        playerSrc: player.img?.src || '',
        netSrc: netImage?.src || '',
        coins,
        quests
      };
      localStorage.setItem(SAVE_KEY, JSON.stringify(store));
    }catch(e){ console.warn('save failed', e); }
  }
  function loadGame(){
    try{
      const raw = localStorage.getItem(SAVE_KEY); if(!raw) return false;
      const obj = JSON.parse(raw);
      if(obj.player?.name){
        player.name = obj.player.name; player.pass = obj.player.pass || '';
        player.sims = (obj.player.sims||[]).map(d=>({type: types.find(t=>t.id===d.typeId)||types[0], hp:d.hp, maxHp:d.maxHp, attacks:d.attacks||[{name:'Punch',dmg:10}], rarity:d.rarity, size:d.size, weight:d.weight}));
        simdex = obj.simdex || {};
        (obj.typesMeta||[]).forEach(m=>{ const t = types.find(x=>x.id===m.id); if(t && m.src){ t.src=m.src; const img=new Image(); img.src=m.src; t.img=img; }});
        if(obj.npcSrc){ npc.img=new Image(); npc.img.src=obj.npcSrc; }
        if(obj.playerSrc){ player.img=new Image(); player.img.src=obj.playerSrc; }
        if(obj.netSrc){ netImage=new Image(); netImage.src=obj.netSrc; }
        coins = obj.coins ?? 0;
        if(Array.isArray(obj.quests)) obj.quests.forEach(q=>{ const loc=quests.find(x=>x.id===q.id); if(loc) Object.assign(loc,q); });
        return true;
      }
    }catch(e){ console.warn('load fail', e); return false; }
    return false;
  }
  if(loadGame()){
    document.getElementById('playerName').value = player.name;
    document.getElementById('menu-main').style.display = 'flex';
    document.getElementById('signin-area').style.display = 'none';
    document.getElementById('rememberMe').checked = true;
  }

  // ----- Utility -----
  function weightedRarity(weights){ const sum=weights.reduce((a,b)=>a+b,0); let r=Math.random()*sum; for(let i=0;i<weights.length;i++){ if(r<weights[i]) return i; r-=weights[i]; } return weights.length-1; }
  const flora = new Set(); for(let i=0;i<2200;i++){ flora.add((Math.floor(Math.random()*MAP_W)<<16)+Math.floor(Math.random()*MAP_H)); }
  function spawnSims(){
    sims = [];
    const count = 350;
    for(let i=0;i<count;i++){
      let x=Math.floor(Math.random()*MAP_W), y=Math.floor(Math.random()*MAP_H);
      if((x===player.x&&y===player.y)||(x===npc.x&&y===npc.y)){ i--; continue; }
      const t = types[Math.floor(Math.random()*types.length)];
      const idx = weightedRarity(t.baseRarityWeights.slice());
      const rarity = RARITIES[idx];
      const hp = 24 + Math.floor(Math.random()*60);
      const size = 1 + Math.floor(Math.random()*3);
      const weight = 1 + Math.floor(Math.random()*5);
      const attacksPool = [{name:'Tackle',dmg:6+Math.floor(Math.random()*8)},{name:'Bite',dmg:6+Math.floor(Math.random()*10)},{name:'Swipe',dmg:7+Math.floor(Math.random()*9)},{name:'Headbutt',dmg:8+Math.floor(Math.random()*8)}];
      const attacks = [attacksPool[Math.floor(Math.random()*attacksPool.length)], attacksPool[Math.floor(Math.random()*attacksPool.length)]];
      sims.push({x,y,type:t,hp,maxHp:hp,attacks,rarity,size,weight});
    }
  }
  spawnSims();

  // ----- Camera -----
  let camX = player.x, camY = player.y;

  // ----- Drawing -----
  let sparklePhase = 0;
  function draw(){
    camX += (player.x - camX) * 0.15;
    camY += (player.y - camY) * 0.15;
    const worldLeft = Math.floor(camX - VIEW_W/2);
    const worldTop  = Math.floor(camY - VIEW_H/2);
    ctx.clearRect(0,0,cvs.width,cvs.height);
    // tiles
    for(let ty=0; ty<VIEW_H; ty++){
      for(let tx=0; tx<VIEW_W; tx++){
        const gx = worldLeft + tx, gy = worldTop + ty;
        ctx.fillStyle = ((gx+gy)&1) ? '#7cc57a' : '#67b86a';
        const px = (gx - camX + VIEW_W/2) * TILE;
        const py = (gy - camY + VIEW_H/2) * TILE;
        ctx.fillRect(px, py, TILE, TILE);
        const k=(gx<<16)+gy;
        if(flora.has(k) && Math.random()<0.06){
          ctx.fillStyle='#eafde8'; ctx.fillRect(px+6,py+8,3,3);
          ctx.fillStyle='#ff6b6b'; ctx.fillRect(px+10,py+12,3,3);
        }
      }
    }
    // NPC
    const nx = npc.x - camX + VIEW_W/2, ny = npc.y - camY + VIEW_H/2;
    if(nx>-1 && nx<VIEW_W+1 && ny>-1 && ny<VIEW_H+1){
      const sx = nx*TILE, sy = ny*TILE;
      if(npc.img) ctx.drawImage(npc.img, sx, sy, TILE, TILE); else { ctx.fillStyle='#f4a261'; ctx.fillRect(sx, sy, TILE, TILE); }
      ctx.fillStyle='rgba(0,0,0,0.45)'; ctx.fillRect(sx, sy-18, TILE, 18);
      ctx.fillStyle='#ffd166'; ctx.font='12px monospace'; ctx.fillText(npc.name, sx+6, sy-6);
    }
    // sims
    sims.forEach(s=>{
      const sx = s.x - camX + VIEW_W/2, sy = s.y - camY + VIEW_H/2;
      if(sx>=-1 && sx<VIEW_W+1 && sy>=-1 && sy<VIEW_H+1){
        const dx = sx*TILE, dy=sy*TILE;
        if(s.type.img) ctx.drawImage(s.type.img, dx, dy, TILE, TILE);
        else {
          const cols=['#ff595e','#8ac926','#1982c4','#ffd166','#6c5ce7','#00cec9']; ctx.fillStyle=cols[s.type.id%cols.length]; ctx.fillRect(dx,dy,TILE,TILE);
        }
        drawRarityFX(s, sx, sy);
      }
    });
    // player
    const px = (player.x - camX + VIEW_W/2)*TILE, py = (player.y - camY + VIEW_H/2)*TILE;
    if(player.img) ctx.drawImage(player.img, px, py, TILE, TILE); else { ctx.fillStyle='#1d3557'; ctx.fillRect(px, py, TILE, TILE); }
    sparklePhase += 0.08;
  }
  function drawRarityFX(s, sx, sy){
    const x=sx*TILE, y=sy*TILE; ctx.save();
    const p=sparklePhase + s.x*0.5 + s.y*0.3;
    const sparkle=(color,count=2)=>{ for(let i=0;i<count;i++){ const ox=Math.floor((Math.sin(p*3+i*1.7)*0.5+0.5)*(TILE-18))+8; const oy=Math.floor((Math.cos(p*2+i*2.3)*0.5+0.5)*(TILE-18))+8; ctx.fillStyle=color; ctx.globalAlpha=0.6+0.4*Math.sin(p*4+i); ctx.fillRect(x+ox,y+oy,5,5);} ctx.globalAlpha=1; };
    switch(s.rarity){
      case 'Common': sparkle('#53a9ff',2); ctx.strokeStyle='rgba(120,180,255,0.35)'; ctx.lineWidth=2; ctx.strokeRect(x+3,y+3,TILE-6,TILE-6); break;
      case 'Uncommon': sparkle('#a0a7ad',3); ctx.strokeStyle='#a0a7ad'; ctx.lineWidth=2; ctx.strokeRect(x+3,y+3,TILE-6,TILE-6); break;
      case 'Rare': sparkle('#a56cff',3); ctx.strokeStyle='#a56cff'; ctx.lineWidth=3; ctx.strokeRect(x+2,y+2,TILE-4,TILE-4); break;
      case 'Legendary': sparkle('#ffd166',3); ctx.strokeStyle=`rgba(255,215,0,${0.4 + Math.abs(Math.sin(p))*0.5})`; ctx.lineWidth=3; ctx.strokeRect(x+2,y+2,TILE-4,TILE-4); break;
      case 'Mythic': sparkle('#66ccff',2); sparkle('#b388ff',2); ctx.strokeStyle='rebeccapurple'; ctx.lineWidth=3; ctx.strokeRect(x+2,y+2,TILE-4,TILE-4); break;
      case 'Exotic': const colors=['#ff0000','#ff7f00','#ffff00','#00ff00','#0000ff','#4b0082','#8f00ff']; const c=colors[Math.floor((p*10)%colors.length)]; sparkle(c,4); ctx.strokeStyle=c; ctx.lineWidth=4; ctx.strokeRect(x+2,y+2,TILE-4,TILE-4); break;
    }
    ctx.restore();
  }

  // ----- Movement and input -----
  function move(dx,dy){
    if(mode === 'battle') return;
    ensureAudio();
    const nx = Math.max(0, Math.min(MAP_W-1, player.x + dx));
    const ny = Math.max(0, Math.min(MAP_H-1, player.y + dy));
    if(nx === player.x && ny === player.y) return;
    player.x = nx; player.y = ny;
    sfx.step();
    checkTileInteraction();
    draw(); drawMini();
  }
  function wirePad(id,dx,dy){
    const el = document.getElementById(id);
    let intv;
    const down = (e)=>{ e?.preventDefault(); move(dx,dy); intv=setInterval(()=>move(dx,dy), 160); };
    const up = ()=>{ clearInterval(intv); };
    el.addEventListener('mousedown', down); el.addEventListener('touchstart', down, {passive:false});
    el.addEventListener('mouseup', up); el.addEventListener('touchend', up);
    el.addEventListener('mouseleave', up); el.addEventListener('click', e=>e.preventDefault());
  }
  wirePad('padUp',0,-1); wirePad('padDown',0,1); wirePad('padLeft',-1,0); wirePad('padRight',1,0);
  window.addEventListener('keydown', e=>{ const k=e.key.toLowerCase(); if(k==='arrowup'||k==='w') move(0,-1); if(k==='arrowdown'||k==='s') move(0,1); if(k==='arrowleft'||k==='a') move(-1,0); if(k==='arrowright'||k==='d') move(1,0); });

  // ----- UI wiring: sign in, menu, settings, windows -----
  function panel(id, show){ document.querySelectorAll('.panel').forEach(p=>p.classList.remove('show')); if(show) document.getElementById(id).classList.add('show'); }
  function wire(id, fn){ const el=document.getElementById(id); el.addEventListener('click', fn); el.addEventListener('touchstart', e=>{ e.preventDefault(); fn(); }, {passive:false}); }
  function showWin(sel){ document.querySelector(sel).classList.add('show'); }
  function hideWin(sel){ document.querySelector(sel).classList.remove('show'); }
  document.querySelectorAll('.closeX').forEach(btn=>btn.addEventListener('click', ()=>{ hideWin(btn.dataset.close); }));

  wire('btnSignIn', ()=>{ const n=document.getElementById('playerName').value.trim(); const p=document.getElementById('playerPass').value; if(!n||!p) return alert('Enter name and password'); player.name=n; player.pass=p; if(document.getElementById('rememberMe').checked) saveGame(); document.getElementById('signin-area').style.display='none'; document.getElementById('menu-main').style.display='flex'; });
  wire('btnGuest', ()=>{ player.name='Guest'; document.getElementById('signin-area').style.display='none'; document.getElementById('menu-main').style.display='flex'; });
  wire('btnStart', ()=>{ mode='world'; panel('menu', false); document.getElementById('hud').style.display='flex'; document.getElementById('dpad').style.display = isTouch() ? 'grid' : 'none'; draw(); drawMini(); if(musicOn) startMusic(); updateCoinsUI(); buildShop(); buildQuests(); });
  wire('btnOpenSettings', ()=>showWin('#settingsWin'));
  wire('btnSettings', ()=>showWin('#settingsWin'));
  wire('btnDex', ()=>{ buildDex(); panel('dex', true); });
  wire('btnOpenDexPanel', ()=>{ buildDex(); panel('dex', true); });
  wire('btnCloseDex', ()=>panel('dex', false));
  wire('btnShop', ()=>{ buildShop(); showWin('#shopWin'); });
  wire('btnQuests', ()=>{ buildQuests(); showWin('#questWin'); });
  wire('btnMusic', ()=>{ musicOn=!musicOn; document.getElementById('btnMusic').textContent='Music: '+(musicOn?'On':'Off'); document.getElementById('toggleMusic').checked=musicOn; if(musicOn) startMusic(); else musicToken++; });

  wire('btnSignOut', ()=>{ localStorage.removeItem(SAVE_KEY); location.reload(); });

  // uploads
  function loadImgFromInput(el, cb){ const f=el.files?.[0]; if(!f) return; const url=URL.createObjectURL(f); const img=new Image(); img.onload=()=>{ cb(img,url); draw(); drawMini(); }; img.src=url; }
  document.getElementById('filePlayer').addEventListener('change', e=> loadImgFromInput(e.target,(img,url)=>{ player.img=img; if(document.getElementById('rememberMe').checked) saveGame(); }));
  document.getElementById('fileNPC').addEventListener('change', e=> loadImgFromInput(e.target,(img,url)=>{ npc.img=img; if(document.getElementById('rememberMe').checked) saveGame(); }));
  document.getElementById('fileNet').addEventListener('change', e=> loadImgFromInput(e.target,(img,url)=>{ netImage=img; if(document.getElementById('rememberMe').checked) saveGame(); }));
  document.querySelectorAll('.fileSim').forEach(inp=>{ inp.addEventListener('change', e=>{ const id=Number(inp.dataset.id); loadImgFromInput(e.target,(img,url)=>{ types[id].img=img; types[id].src=url; if(document.getElementById('rememberMe').checked) saveGame(); }); }); });

  document.getElementById('toggleMusic').addEventListener('change', e=>{ musicOn=e.target.checked; document.getElementById('btnMusic').textContent='Music: '+(musicOn?'On':'Off'); if(musicOn) startMusic(); else musicToken++; });
  document.getElementById('toggleSfx').addEventListener('change', e=> sfxOn=e.target.checked);

  // ----- SimDex -----
  function buildDex(){
    const grid=document.getElementById('dexGrid'); grid.innerHTML='';
    const keys=Object.keys(simdex);
    if(!keys.length){ grid.innerHTML='<p style="opacity:.8">No Simitaurs caught yet.</p>'; return; }
    keys.forEach(k=>{
      const d=simdex[k];
      const el=document.createElement('div'); el.className='dexCard rarity-'+(d.rarity||'Common');
      const img=document.createElement('div'); img.style.width='64px'; img.style.height='64px'; img.style.borderRadius='8px';
      img.style.background = '#203425'; img.style.display='flex'; img.style.alignItems='center'; img.style.justifyContent='center'; img.style.fontSize='12px';
      img.textContent = d.name[0] || '?';
      const info=document.createElement('div');
      info.innerHTML=`<b>${d.name}</b><br>Rarity: ${d.rarity}<br>HP: ${d.hp}/${d.maxHp}`;
      el.appendChild(img); el.appendChild(info);
      el.addEventListener('click', ()=> alert(`${d.name}\nRarity: ${d.rarity}\nHP: ${d.hp}/${d.maxHp}\nSize: ${d.size}\nWeight: ${d.weight}`));
      grid.appendChild(el);
    });
  }

  // ----- Encounters -----
  function checkTileInteraction(){
    const wild = sims.find(s=> s.x===player.x && s.y===player.y);
    if(wild){
      currentEncounter = wild;
      panel('encounterPanel', true);
      document.getElementById('encounterTitle').textContent = `A wild ${wild.type.name} (${wild.rarity}) appears!`;
      return;
    }
    currentEncounter = null;
  }
  wire('btnRun', ()=>{ currentEncounter=null; panel('encounterPanel', false); sfx.escape(); });

  // Fight: pick sim -> battle
  wire('btnFight', ()=>{
    panel('encounterPanel', false);
    openChooseSim((chosen)=>{
      if(!chosen){ currentEncounter=null; return; }
      battlePlayerSim = chosen;
      const e = currentEncounter || randomNpcSim();
      startBattleWithChosen(battlePlayerSim, e);
    });
  });

  // Catch button
  wire('btnCatchSim', ()=>{ if(currentEncounter) runCatchSequence(currentEncounter); });

  function randomNpcSim(){
    const t=types[Math.floor(Math.random()*types.length)];
    const hp=40+Math.floor(Math.random()*60);
    const attacks=[{name:'Smash',dmg:8+Math.floor(Math.random()*6)},{name:'Roar',dmg:10+Math.floor(Math.random()*6)}];
    return { type:t, hp, maxHp:hp, attacks, rarity:'Rare', size:2, weight:3, x:player.x, y:player.y };
  }

  // Capture odds
  function captureChanceByRarity(r){
    switch(r){
      case 'Common': return 78;
      case 'Uncommon': return 58;
      case 'Rare': return 38;
      case 'Legendary': return 20;
      case 'Mythic': return 12;
      case 'Exotic': return 6;
      default: return 50;
    }
  }

  // Catch sequence with swoop
  function runCatchSequence(sim){
    panel('encounterPanel', false);
    const dur = 900; const start = performance.now();
    const cx = cvs.width/2, cy = cvs.height/2;
    function anim(now){
      const t=Math.min(1,(now-start)/dur);
      draw();
      ctx.save(); ctx.globalAlpha=0.9;
      const nx=lerp(-120,cx,easeOutQuad(t)), ny=lerp(-120,cy-40,easeInOutCubic(t));
      const scale=0.6+1.3*t;
      if(netImage){ ctx.drawImage(netImage, nx-48*scale, ny-48*scale, 96*scale, 96*scale); }
      else { ctx.strokeStyle='#fff'; ctx.lineWidth=4; ctx.beginPath(); ctx.ellipse(nx, ny, 36*scale, 22*scale, Math.PI*0.1, 0, Math.PI*2); ctx.stroke(); }
      ctx.restore();
      if(t<1) requestAnimationFrame(anim); else finishCatch();
    }
    requestAnimationFrame(anim);

    function finishCatch(){
      sfx.catch();
      const chance = captureChanceByRarity(sim.rarity);
      if(Math.random()*100 < chance){
        const id = sim.type.name + '-' + Date.now();
        simdex[id] = { name: sim.type.name, rarity: sim.rarity, hp: sim.hp, maxHp: sim.maxHp, size: sim.size, weight: sim.weight, src: sim.type.src || '' };
        const idx = sims.indexOf(sim); if(idx>=0) sims.splice(idx,1);
        player.sims.push({ type: sim.type, hp: sim.hp, maxHp: sim.maxHp, attacks: sim.attacks, rarity: sim.rarity, size: sim.size, weight: sim.weight });
        awardCoins(sim.rarity==='Exotic'?50:5);
        progressQuest('q1',1);
        if(sim.rarity==='Exotic') progressQuest('q2',1);
        maybeSave();
        buildDex(); buildShop(); buildQuests(); drawMini();
        alert(`Caught ${sim.type.name} (${sim.rarity})!`);
      } else {
        alert(`${sim.type.name} escaped!`);
      }
      currentEncounter = null;
    }
  }

  // Battle system
  function startBattleWithChosen(playerSim, enemySource){
    battleEnemySim = { ...enemySource, hp: enemySource.hp, maxHp: enemySource.maxHp, attacks: (enemySource.attacks||[]).slice() };
    if(!playerSim){
      if(player.sims.length === 0){
        player.sims.push({ type: types[0], hp:40, maxHp:40, attacks:[{name:'Punch',dmg:10}], rarity:'Common', size:1, weight:1 });
      }
      playerSim = player.sims[0];
    }
    battlePlayerSim = playerSim;
    panel('battlePanel', true);
    populateBattleUI();
    mode='battle';
    sfx.battleStart();
  }
  function populateBattleUI(){
    document.getElementById('battleTitle').textContent = `Battle vs ${battleEnemySim.type ? battleEnemySim.type.name : 'Enemy'}`;
    document.getElementById('playerLabel').textContent = player.name || 'You';
    document.getElementById('enemyLabel').textContent = battleEnemySim.type ? battleEnemySim.type.name : 'Enemy';
    updateHPbars();
    const div=document.getElementById('battleButtons'); div.innerHTML='';
    (battlePlayerSim.attacks || []).forEach(a=>{ const b=document.createElement('button'); b.className='btn'; b.textContent=a.name; b.addEventListener('click', ()=> playerUseAttack(a)); b.addEventListener('touchstart', e=>{ e.preventDefault(); playerUseAttack(a); }); div.appendChild(b); });
    document.getElementById('btnRunBattle').onclick = ()=>{ panel('battlePanel', false); mode='world'; battleEnemySim=null; battlePlayerSim=null; sfx.escape(); };
  }
  function updateHPbars(){ if(battlePlayerSim) document.getElementById('hpYou').style.width=Math.max(0,(battlePlayerSim.hp/battlePlayerSim.maxHp*100))+'%'; if(battleEnemySim) document.getElementById('hpEnemy').style.width=Math.max(0,(battleEnemySim.hp/battleEnemySim.maxHp*100))+'%'; }
  function playerUseAttack(a){
    if(!battleEnemySim || !battlePlayerSim) return;
    ensureAudio(); sfx.atk();
    const base=a.dmg || (8+Math.floor(Math.random()*6)); const dmg=Math.max(1, base + Math.floor((Math.random()-0.5)*4));
    battleEnemySim.hp=Math.max(0,battleEnemySim.hp-dmg); updateHPbars();
    if(battleEnemySim.hp<=0){ setTimeout(()=>{ sfx.win(); onBattleWin(); }, 260); return; }
    setTimeout(()=> enemyTurn(), 400);
  }
  function enemyTurn(){
    if(!battleEnemySim || !battlePlayerSim) return;
    const atk=(battleEnemySim.attacks && battleEnemySim.attacks.length)? battleEnemySim.attacks[Math.floor(Math.random()*battleEnemySim.attacks.length)] : {name:'Tackle',dmg:6};
    ensureAudio(); sfx.atk();
    const dmg=Math.max(1, atk.dmg + Math.floor((Math.random()-0.5)*4));
    battlePlayerSim.hp=Math.max(0,battlePlayerSim.hp-dmg); updateHPbars();
    if(battlePlayerSim.hp<=0){ setTimeout(()=> onBattleLose(), 260); }
  }
  function onBattleWin(){
    panel('battlePanel', false);
    if(currentEncounter){
      // claim sim (auto-catch on win)
      const s=currentEncounter;
      simdex[s.type.name + '-' + Date.now()] = { name:s.type.name, rarity:s.rarity, hp:s.hp, maxHp:s.maxHp, size:s.size, weight:s.weight, src:s.type.src||'' };
      const idx=sims.indexOf(s); if(idx>=0) sims.splice(idx,1);
      player.sims.push({ type:s.type, hp:s.hp, maxHp:s.maxHp, attacks:s.attacks, rarity:s.rarity, size:s.size, weight:s.weight });
      awardCoins(s.rarity==='Exotic'?50:5);
      progressQuest('q1',1); if(s.rarity==='Exotic') progressQuest('q2',1);
      maybeSave();
      buildDex(); buildShop(); buildQuests(); drawMini();
      alert(`Victory! Claimed ${s.type.name} and added to SimDex + team.`);
      currentEncounter=null;
    } else {
      alert('You won! (NPC spar)');
    }
    battleEnemySim=null; battlePlayerSim=null; mode='world';
  }
  function onBattleLose(){
    panel('battlePanel', false);
    alert('You lost. Your Sim recovers to half HP.');
    if(player.sims[0]) player.sims[0].hp=Math.max(1, Math.floor(player.sims[0].maxHp*0.5));
    battleEnemySim=null; battlePlayerSim=null; mode='world';
  }

  // Choose sim for battle
  function openChooseSim(cb){
    const list=document.getElementById('chooseSimList'); list.innerHTML='';
    if(player.sims.length===0){ alert('No sims in your team!'); cb(null); return; }
    player.sims.forEach((s,i)=>{ const el=document.createElement('button'); el.className='btn'; el.textContent=`${s.type.name} (HP:${s.hp}/${s.maxHp})`; el.addEventListener('click', ()=>{ document.getElementById('chooseSimPanel').classList.remove('show'); cb(s); }); list.appendChild(el); });
    document.getElementById('btnCancelChoose').onclick=()=>{ document.getElementById('chooseSimPanel').classList.remove('show'); cb(null); };
    panel('chooseSimPanel', true);
  }

  // ----- Coins + animations -----
  function updateCoinsUI(){ document.getElementById('coinLabel').textContent = coins; document.getElementById('shopCoins').textContent = 'Coins: '+coins; }
  function awardCoins(n){
    coins += n; updateCoinsUI(); sfx.coin();
    const cg=document.getElementById('coinGain'); cg.textContent = (n>0?'+':'') + n; cg.style.opacity='1'; cg.style.transform='translateY(0)'; cg.getBoundingClientRect(); cg.style.transform='translateY(-20px)'; cg.style.opacity='0';
  }

  // ----- Quests -----
  function progressQuest(id, amt){
    const q=quests.find(x=>x.id===id); if(!q || q.done) return;
    q.progress = Math.min(q.goal, q.progress + amt);
    if(q.progress>=q.goal && !q.done){ q.done=true; awardCoins(q.reward); }
  }
  function buildQuests(){
    const ql=document.getElementById('questList'); ql.innerHTML='';
    quests.forEach(q=>{
      const row=document.createElement('div'); row.className='healRow';
      const left=document.createElement('div'); left.innerHTML=`<b>${q.name}</b><br><span class="note">${q.progress}/${q.goal} • Reward: ${q.reward} coins</span>`;
      const bar=document.createElement('div'); bar.className='bar'; const i=document.createElement('i'); i.style.width=(q.progress/q.goal*100)+'%'; bar.appendChild(i);
      const status=document.createElement('div'); status.textContent=q.done?'Done':'Active';
      row.appendChild(left); row.appendChild(bar); row.appendChild(status);
      ql.appendChild(row);
    });
  }

  // ----- Shop (heals) -----
  function buildShop(){
    const root=document.getElementById('healList'); root.innerHTML='';
    if(player.sims.length===0){ root.innerHTML='<p class="note">No sims in team yet. Catch some first!</p>'; return; }
    player.sims.forEach((s,idx)=>{
      const row=document.createElement('div'); row.className='healRow';
      const d=document.createElement('div'); d.innerHTML=`<b>${s.type.name}</b><br><span class="note">HP ${s.hp}/${s.maxHp} • ${s.rarity}</span>`;
      const bar=document.createElement('div'); bar.className='bar'; const i=document.createElement('i'); i.style.width=(s.hp/s.maxHp*100)+'%'; bar.appendChild(i);
      const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Full Heal (10)';
      btn.onclick=()=>{
        if(coins<10) return alert('Not enough coins!');
        coins-=10; s.hp=s.maxHp; sfx.heal(); updateCoinsUI(); i.style.width='100%'; pulse(btn); maybeSave(); buildShop();
      };
      row.appendChild(d); row.appendChild(bar); row.appendChild(btn);
      root.appendChild(row);
    });
  }
  function pulse(el){ el.animate([{transform:'scale(1)'},{transform:'scale(1.06)'},{transform:'scale(1)'}],{duration:260}); }

  // Heal any Sim (SimDex) flow
  document.getElementById('btnHealAny').addEventListener('click', ()=>{
    const keys = Object.keys(simdex);
    if(keys.length === 0) return alert('Your SimDex is empty — catch some Simitaurs first.');
    openChooseHeal((id)=>{
      if(!id) return;
      if(coins < 10) return alert('Not enough coins!');
      coins -= 10; updateCoinsUI(); sfx.heal(); pulse(document.getElementById('btnHealAny'));
      // heal simdex entry
      const d = simdex[id];
      if(d){ d.hp = d.maxHp; }
      // if sim is also in player.sims, heal them too
      player.sims.forEach(s=>{ if(s.type.name === d.name && s.maxHp === d.maxHp){ s.hp = s.maxHp; } });
      maybeSave(); buildDex(); buildShop();
      alert(`${d.name} healed to full!`);
    });
  });

  function openChooseHeal(cb){
    const list=document.getElementById('chooseHealList'); list.innerHTML='';
    const keys = Object.keys(simdex);
    if(!keys.length){ alert('No entries in SimDex'); cb(null); return; }
    keys.forEach(k=>{
      const d = simdex[k];
      const btn = document.createElement('button'); btn.className='btn'; btn.style.minWidth='160px';
      btn.innerHTML = `<div style="text-align:left"><b>${d.name}</b><div class="note">HP ${d.hp}/${d.maxHp} • ${d.rarity}</div></div>`;
      btn.addEventListener('click', ()=>{ document.getElementById('chooseHealPanel').classList.remove('show'); cb(k); });
      list.appendChild(btn);
    });
    document.getElementById('btnCancelHeal').onclick = ()=>{ document.getElementById('chooseHealPanel').classList.remove('show'); cb(null); };
    panel('chooseHealPanel', true);
  }

  // ----- Minimap -----
  let miniVisible = true;
  document.getElementById('btnMini').addEventListener('click', ()=>{
    miniVisible = !miniVisible;
    document.getElementById('minimap').style.display = miniVisible?'block':'none';
    document.getElementById('btnMini').textContent = miniVisible?'Hide Mini-Map':'Show Mini-Map';
  });
  function drawMini(){
    if(!miniVisible) return;
    const w=mini.width, h=mini.height;
    mctx.fillStyle='#0b140c'; mctx.fillRect(0,0,w,h);
    // grid background
    for(let y=0;y<h;y+=8){ for(let x=0;x<w;x+=8){ mctx.fillStyle= ((x+y)/8)&1 ? '#0f1c13' : '#0d1812'; mctx.fillRect(x,y,8,8); } }
    // sims (exclude caught — only world sims)
    sims.forEach(s=>{
      const x=Math.floor(s.x/MAP_W*w), y=Math.floor(s.y/MAP_H*h);
      if(s.rarity==='Exotic') { mctx.fillStyle='#ff7ab6'; mctx.fillRect(x-1,y-1,3,3); }
      else { mctx.fillStyle='#4fd1c5'; mctx.fillRect(x,y,2,2); }
    });
    // npc
    { const x=Math.floor(npc.x/MAP_W*w), y=Math.floor(npc.y/MAP_H*h); mctx.fillStyle='#ffd166'; mctx.fillRect(x-1,y-1,3,3); }
    // player
    { const x=Math.floor(player.x/MAP_W*w), y=Math.floor(player.y/MAP_H*h); mctx.fillStyle='#00ff85'; mctx.fillRect(x-2,y-2,5,5); }
    mctx.strokeStyle='#274f34'; mctx.strokeRect(0,0,w,h);
  }

  // ----- Render loop -----
  (function renderLoop(){ if(mode==='world'){ draw(); } requestAnimationFrame(renderLoop); })();

  // ----- Helpers -----
  function isTouch(){ return /Mobi|Android|iPhone|iPad|iPod|Tablet/i.test(navigator.userAgent); }
  cvs.addEventListener('click', (ev)=>{ const rect=cvs.getBoundingClientRect(); const cx=ev.clientX-rect.left, cy=ev.clientY-rect.top; const wx=Math.floor(camX - VIEW_W/2 + (cx/TILE)), wy=Math.floor(camY - VIEW_H/2 + (cy/TILE)); const dx=Math.sign(wx-player.x), dy=Math.sign(wy-player.y); if(Math.abs(wx-player.x)+Math.abs(wy-player.y)>0) move(dx,dy); });

  // draggable windows
  makeDraggable('#settingsWin'); makeDraggable('#shopWin'); makeDraggable('#questWin');
  function makeDraggable(sel){
    const win=document.querySelector(sel); const bar=win.querySelector('.titlebar');
    let grab=false, sx=0, sy=0, ox=0, oy=0;
    bar.addEventListener('mousedown',e=>{ grab=true; sx=e.clientX; sy=e.clientY; const r=win.getBoundingClientRect(); ox=r.left; oy=r.top; });
    window.addEventListener('mousemove',e=>{ if(!grab) return; const nx=ox+(e.clientX-sx), ny=oy+(e.clientY-sy); win.style.left=Math.max(6,Math.min(window.innerWidth-win.offsetWidth-6,nx))+'px'; win.style.top=Math.max(6,Math.min(window.innerHeight-win.offsetHeight-6,ny))+'px'; });
    window.addEventListener('mouseup',()=>grab=false);
    // touch
    bar.addEventListener('touchstart',e=>{ const t=e.touches[0]; grab=true; sx=t.clientX; sy=t.clientY; const r=win.getBoundingClientRect(); ox=r.left; oy=r.top; },{passive:false});
    window.addEventListener('touchmove',e=>{ if(!grab) return; const t=e.touches[0]; const nx=ox+(t.clientX-sx), ny=oy+(t.clientY-sy); win.style.left=Math.max(6,Math.min(window.innerWidth-win.offsetWidth-6,nx))+'px'; win.style.top=Math.max(6,Math.min(window.innerHeight-win.offsetHeight-6,ny))+'px'; },{passive:false});
    window.addEventListener('touchend',()=>grab=false);
  }

  // easing
  function lerp(a,b,t){ return a + (b-a)*t; }
  function easeOutQuad(t){ return t*(2-t); }
  function easeInOutCubic(t){ return t<0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2; }
  function maybeSave(){ if(document.getElementById('rememberMe')?.checked) saveGame(); }

  // ----- UI boot -----
  function refreshAll(){ updateCoinsUI(); buildShop(); buildQuests(); draw(); drawMini(); }
  refreshAll();

})();
</script>
</body>
</html>

