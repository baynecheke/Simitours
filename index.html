<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <title>Simitaur RPG ‚Äî Adventure & Multiplayer</title>
    
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- FIREBASE SDKs (Required for the multiplayer/save code to work) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
      :root{
        --bg:#071018; 
        --panel:rgba(6,8,6,.88);
        --card:#0f1b1a; 
        --accent:#c9a34a; 
        --btn:#2b475d; 
        --btn-h:#375f7a;
        --danger:#d85757;
        --ink:#f7f3e9; 
        --ring:#3b5a6b;
      }
      html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", system-ui, Arial;background:linear-gradient(180deg,#041018 0%, #072029 100%);color:var(--ink);overflow:hidden;}
      
      /* HUD & Layout */
      .wrap{max-width:1100px;margin:12px auto;padding:10px; position:relative;}
      
      canvas#game{
        display:block;margin:8px auto;border-radius:14px;border:4px solid rgba(255,255,255,0.04);
        background:linear-gradient(180deg,#7cc57a 0%, #5ea86a 100%);box-shadow:0 20px 40px rgba(2,6,10,0.6);
        image-rendering:pixelated;touch-action:none;
        max-width: 100%;
      }

      /* Top HUD */
      #hud{position:fixed;top:18px;left:18px;right:18px;display:flex;gap:10px;z-index:60;flex-wrap:wrap;align-items:center; pointer-events: none;}
      #hud > * { pointer-events: auto; }
      
      .pill{background:linear-gradient(180deg,var(--btn),var(--btn-h));border:none;color:var(--ink);border-radius:999px;padding:9px 14px;font-weight:800;cursor:pointer;box-shadow:0 6px 0 rgba(0,0,0,0.48);transition:transform .08s;}
      .pill:active{transform:translateY(2px);box-shadow:0 3px 0 rgba(0,0,0,0.6)}
      
      .stat{display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));border:1px solid var(--ring);border-radius:999px;padding:8px 12px;font-weight:800;backdrop-filter:blur(4px)}
      
      /* XP Bar in HUD */
      #xpContainer {
          flex: 1; min-width: 140px; max-width: 260px;
          background: rgba(0,0,0,0.6); border-radius: 99px; height: 18px; 
          position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
      }
      #xpBar { height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); width: 0%; transition: width 0.3s ease; }
      #xpText { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; text-shadow: 0 1px 2px black; }

      /* Modals */
      .panel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);backdrop-filter:blur(4px);z-index:80}
      .panel.show{display:flex}
      .box{background:linear-gradient(180deg,var(--card), rgba(10,12,10,0.98));border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:22px;box-shadow:0 20px 50px rgba(0,0,0,.8);max-width:94vw;color:var(--ink)}
      
      button.btn{background:linear-gradient(180deg,var(--btn),var(--btn-h));border:none;border-radius:8px;padding:10px 16px;color:var(--ink);font-weight:bold;cursor:pointer;box-shadow:0 4px 0 rgba(0,0,0,0.4);}
      button.btn:active{transform:translateY(2px);box-shadow:0 2px 0 rgba(0,0,0,0.4);}
      .danger{background:linear-gradient(180deg,#c94b4b,#a83b3b)}

      /* Loading Screen */
      #loadingScreen {
        position: fixed; inset: 0; background: #071018; color: #f7f3e9;
        display: flex; align-items: center; justify-content: center; flex-direction: column;
        z-index: 9999; transition: opacity 0.5s;
      }
      .loadingCircle {
        width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.2);
        border-top-color: #c9a34a; border-radius: 50%; animation: spin 1s linear infinite;
        margin-top: 20px;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* Full Screen Shop */
      #shopFull{position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.92);backdrop-filter:blur(8px);}
      #shopFull.show{display:flex;animation:fadeIn .2s ease}
      .shopShell{width:90%;max-width:900px;background:#131c21;border:1px solid rgba(255,255,255,0.1);border-radius:16px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,.8);display:flex;flex-direction:column;max-height:85vh;}
      .shopHeader{padding:16px 24px;background:rgba(255,255,255,.03);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.05);}
      .shopGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;padding:24px;overflow-y:auto;}
      .itemCard{background:rgba(255,255,255,.04);border-radius:12px;padding:14px;text-align:center;transition:all .2s;border:1px solid transparent;}
      .itemCard:hover{transform:translateY(-4px);background:rgba(255,255,255,.08);border-color:var(--accent);}
      .itemCard img{width:64px;height:64px;object-fit:contain;margin-bottom:10px;filter:drop-shadow(0 4px 6px rgba(0,0,0,0.5));}

      /* Minimap */
      #minimapWrap{position:fixed;right:18px;bottom:18px;z-index:65;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
      #minimap{width:140px;height:140px;border-radius:8px;border:2px solid rgba(255,255,255,0.1);background:#000;}

      /* DPad */
      #dpad{position:fixed;left:18px;bottom:18px;display:grid;grid-template-columns:56px 56px;grid-template-rows:56px 56px 56px;gap:10px;z-index:60}
      #dpad button{border-radius:12px;background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);font-size:24px;}
      
      @media (max-width:860px){
        canvas#game{width:96vw;height:auto;}
        #dpad{left:50%;transform:translateX(-50%);}
        #hud{justify-content:center;}
      }
    </style>
</head>
<body>

<!-- Loading Screen -->
<div id="loadingScreen">
    <h1>Simitaur RPG</h1>
    <div class="note">Loading World & Multiplayer...</div>
    <div class="loadingCircle"></div>
</div>

<div class="wrap">
  <canvas id="game" width="640" height="640"></canvas>
</div>

<!-- HUD -->
<div id="hud" style="display:none">
  <div class="stat" title="Coins">
      <span style="color:#ffd166">ü™ô</span><span id="coinLabel">0</span>
  </div>
  <div class="stat" title="Sapphires">
      <span style="color:#4fd1c5">üíé</span><span id="sapphireLabel">0</span>
  </div>
  
  <!-- Integrated XP Bar -->
  <div id="xpContainer" title="Experience">
      <div id="xpBar"></div>
      <div id="xpText">Lvl 1</div>
  </div>

  <button id="btnShop" class="pill">Shop</button>
  <button id="btnDex" class="pill">SimDex</button>
  <button id="btnQuests" class="pill">Quests</button>
  <button id="btnSettings" class="pill">‚öôÔ∏è</button>
</div>

<!-- Dpad -->
<div id="dpad" style="display:none">
  <button id="padUp" style="grid-column:1/3; width:100%">‚ñ≤</button>
  <button id="padLeft">‚óÄ</button>
  <button id="padRight">‚ñ∂</button>
  <button id="padDown" style="grid-column:1/3; width:100%">‚ñº</button>
</div>

<!-- MENU -->
<div id="menu" class="panel show">
  <div class="box" style="text-align:center;max-width:520px">
    <h1 style="margin:6px 0 10px; color:var(--accent)">Simitaur RPG</h1>
    <p class="muted" style="margin:0 0 15px; font-size:14px; opacity:0.8;">
        Explore, catch Simitaurs, and see other players in real-time.<br>
        Create a name to sync your progress.
    </p>
    <div id="signin-area">
      <input id="playerName" placeholder="Player Name" style="padding:12px;width:80%;margin:6px;border-radius:8px;border:1px solid #3b5a6b;background:#0f1b13;color:white;font-weight:bold;"><br>
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:center;">
        <button id="btnSignIn" class="btn">Play</button>
      </div>
    </div>
    <div id="menu-main" style="display:none;margin-top:10px; justify-content:center; gap:10px;">
      <button id="btnStart" class="btn">Enter World</button>
    </div>
  </div>
</div>

<!-- Full Screen Shop -->
<div id="shopFull">
  <div class="shopShell">
    <div class="shopHeader">
      <div style="font-size:20px;font-weight:900; color:var(--accent)">üõí Marketplace</div>
      <button class="btn danger" onclick="document.getElementById('shopFull').classList.remove('show')">Close</button>
    </div>
    <div class="shopGrid" id="shopGrid"></div>
  </div>
</div>

<!-- SimDex (modal) -->
<div id="dex" class="panel">
  <div class="box" style="width:90%; max-height:80vh; display:flex; flex-direction:column;">
    <h2 style="margin-top:0; text-align:center;">SimDex</h2>
    <div id="dexGrid" style="flex:1; overflow-y:auto; display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:10px;"></div>
    <button class="btn" style="margin-top:10px" onclick="document.getElementById('dex').classList.remove('show')">Close</button>
  </div>
</div>

<!-- Encounter panel -->
<div id="encounterPanel" class="panel">
  <div class="box" style="text-align:center;">
    <h2 id="encounterTitle" style="color:#ff6b6b">Wild Encounter!</h2>
    <div class="row" style="justify-content:center; gap:10px; margin-top:20px;">
      <button id="btnFight" class="btn">‚öîÔ∏è Battle</button>
      <button id="btnCatchSim" class="btn">üï∏Ô∏è Catch</button>
      <button id="btnRun" class="btn danger">Run</button>
    </div>
  </div>
</div>

<!-- Battle panel -->
<div id="battlePanel" class="panel">
  <div class="box" style="width:400px; max-width:90vw">
    <h2 id="battleTitle" style="text-align:center; margin-top:0">Battle</h2>
    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin:20px 0;">
        <div style="text-align:center">
            <div>You</div>
            <div style="width:100px; height:10px; background:#333; border-radius:4px;"><div id="hpYou" style="width:100%; height:100%; background:#4caf50; border-radius:4px; transition:width 0.2s"></div></div>
        </div>
        <div style="font-size:24px">VS</div>
        <div style="text-align:center">
            <div id="enemyLabel">Enemy</div>
            <div style="width:100px; height:10px; background:#333; border-radius:4px;"><div id="hpEnemy" style="width:100%; height:100%; background:#f44336; border-radius:4px; transition:width 0.2s"></div></div>
        </div>
    </div>
    <div id="battleButtons" style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;"></div>
    <button id="btnRunBattle" class="btn danger" style="width:100%; margin-top:10px;">Flee</button>
  </div>
</div>

<!-- Mini-map -->
<div id="minimapWrap" style="display:none">
  <canvas id="minimap" width="140" height="140"></canvas>
</div>

<script>
/**
 * SIMITAUR RPG - Unified Engine
 * Merges procedural generation, battle logic, and Firebase multiplayer
 */

// --- 1. CONFIGURATION & FIREBASE ---
const firebaseConfig = {
    apiKey: "AIzaSyCxyW86qYBD41T_6PdM0mMtg233sQfCbAM",
    authDomain: "simitaurs.firebaseapp.com",
    databaseURL: "https://simitaurs-default-rtdb.firebaseio.com",
    projectId: "simitaurs",
    storageBucket: "simitaurs.firebasestorage.app",
    messagingSenderId: "415340567485",
    appId: "1:415340567485:web:99538c93559940f7c890d4",
    measurementId: "G-T6K30LZTLK"
};

let db = null;
let auth = null;

try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    auth = firebase.auth();
    console.log("Firebase Initialized");
} catch(e) {
    console.error("Firebase failed to init:", e);
    alert("Offline Mode: Multiplayer features unavailable.");
}

// --- 2. GAME STATE ---
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d');
const mini = document.getElementById('minimap');
const mctx = mini.getContext('2d');

const TILE = 64; 
const VIEW_W = 10; 
const VIEW_H = 10;
const MAP_W = 1000; 
const MAP_H = 1000;

// Player Object (Merged)
const player = {
    x: Math.floor(MAP_W/2), 
    y: Math.floor(MAP_H/2),
    name: '',
    hp: 100, maxHp: 100,
    xp: 0, level: 1,
    sims: [],
    img: null,
    online: false
};

let coins = 100;
let sapphires = 0;
let mode = 'menu'; // menu, world, battle
let camX = player.x, camY = player.y;

// Multiplayer State
let otherPlayers = {}; 
let lastPosUpdate = 0;

// World Data
let sims = []; // Wild sims on map
let simdex = {}; // Caught collection
const types = [
    { id:0, name:'Frostaur', color:'#00cec9', rarityWeights:[60,25,10,3,1,1] },
    { id:1, name:'Rockaur',  color:'#636e72', rarityWeights:[40,30,18,8,3,1] },
    { id:2, name:'Leafaur',  color:'#00b894', rarityWeights:[30,30,20,12,6,2] },
    { id:3, name:'Stormaur', color:'#6c5ce7', rarityWeights:[36,28,20,10,5,1] },
    { id:4, name:'Flametaur',color:'#d63031', rarityWeights:[42,30,16,8,3,1] },
    { id:5, name:'Aquataur', color:'#0984e3', rarityWeights:[34,30,20,10,5,1] },
    { id:6, name:'Shadeaur', color:'#2d3436', rarityWeights:[50,28,12,6,3,1] }
];
const RARITIES = ['Common','Uncommon','Rare','Legendary','Mythic','Exotic'];

// --- 3. AUDIO SYSTEM ---
const AC = window.AudioContext || window.webkitAudioContext;
const audio = new AC();
let sfxOn = true;

function tone(freq, dur=0.1, type='square'){
    if(!sfxOn) return;
    const o = audio.createOscillator();
    const g = audio.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.setValueAtTime(0.1, audio.currentTime);
    g.gain.linearRampToValueAtTime(0, audio.currentTime + dur);
    o.connect(g); g.connect(audio.destination);
    o.start(); o.stop(audio.currentTime + dur);
}

const sfx = {
    step: () => tone(150 + Math.random()*50, 0.05, 'triangle'),
    coin: () => tone(1200, 0.1, 'sine'),
    win: () => { tone(440,0.1); setTimeout(()=>tone(554,0.1),100); setTimeout(()=>tone(659,0.2),200); },
    catch: () => { tone(800,0.1,'sawtooth'); setTimeout(()=>tone(600,0.2,'sawtooth'),100); }
};

// --- 4. GAMEPLAY LOGIC ---

// XP & Leveling
function xpNeeded(lvl) { return 100 + (lvl-1)*50; }
function gainXP(amt) {
    player.xp += amt;
    const need = xpNeeded(player.level);
    if(player.xp >= need) {
        player.xp -= need;
        player.level++;
        sfx.win();
        alert(`‚≠ê LEVEL UP! You are now Level ${player.level}`);
        saveProfile();
    }
    updateHUD();
}

function updateHUD(){
    document.getElementById('coinLabel').textContent = coins;
    document.getElementById('sapphireLabel').textContent = sapphires;
    
    const need = xpNeeded(player.level);
    const pct = Math.floor((player.xp / need)*100);
    document.getElementById('xpBar').style.width = pct + '%';
    document.getElementById('xpText').textContent = `Lvl ${player.level} (${player.xp}/${need})`;
}

// Spawning
function spawnSims() {
    sims = [];
    for(let i=0; i<400; i++){
        sims.push({
            x: Math.floor(Math.random()*MAP_W),
            y: Math.floor(Math.random()*MAP_H),
            type: types[Math.floor(Math.random()*types.length)],
            rarity: RARITIES[weightedRarity([50,25,15,5,3,2])]
        });
    }
}
function weightedRarity(weights){
    const sum = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*sum;
    for(let i=0; i<weights.length; i++){
        if(r < weights[i]) return i;
        r -= weights[i];
    }
    return 0;
}

// Drawing
function draw(){
    // Smooth Camera
    camX += (player.x - camX) * 0.2;
    camY += (player.y - camY) * 0.2;

    const startCol = Math.floor(camX - VIEW_W/2);
    const startRow = Math.floor(camY - VIEW_H/2);
    const offX = -((camX - VIEW_W/2) % 1) * TILE;
    const offY = -((camY - VIEW_H/2) % 1) * TILE;

    ctx.clearRect(0,0,cvs.width,cvs.height);

    // 1. Draw Map Tiles
    for(let y=0; y<=VIEW_H; y++){
        for(let x=0; x<=VIEW_W; x++){
            const wx = startCol + x;
            const wy = startRow + y;
            // Checkboard pattern
            ctx.fillStyle = ((wx+wy)%2===0) ? '#5ea86a' : '#7cc57a';
            ctx.fillRect(x*TILE + offX, y*TILE + offY, TILE, TILE);
        }
    }

    // 2. Draw Wild Sims
    sims.forEach(s => {
        const sx = (s.x - camX + VIEW_W/2) * TILE;
        const sy = (s.y - camY + VIEW_H/2) * TILE;
        if(sx > -TILE && sx < cvs.width && sy > -TILE && sy < cvs.height) {
            ctx.fillStyle = s.type.color;
            ctx.beginPath(); ctx.arc(sx+32, sy+32, 20, 0, Math.PI*2); ctx.fill();
            if(s.rarity === 'Exotic') {
                ctx.strokeStyle = '#fff'; ctx.lineWidth=2; ctx.stroke();
            }
        }
    });

    // 3. Draw Multiplayer Users
    for(let id in otherPlayers) {
        const p = otherPlayers[id];
        const sx = (p.x - camX + VIEW_W/2) * TILE;
        const sy = (p.y - camY + VIEW_H/2) * TILE;
        if(sx > -TILE && sx < cvs.width && sy > -TILE && sy < cvs.height) {
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath(); ctx.ellipse(sx+32, sy+56, 16, 8, 0, 0, Math.PI*2); ctx.fill();
            // Body
            ctx.fillStyle = '#ff7675'; // Reddish for others
            ctx.fillRect(sx+12, sy+12, 40, 40);
            // Name
            ctx.fillStyle = 'white';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(id, sx+32, sy-5);
        }
    }

    // 4. Draw Player (Center)
    const cx = cvs.width/2 - 32;
    const cy = cvs.height/2 - 32;
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath(); ctx.ellipse(cx+32, cy+56, 16, 8, 0, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#0984e3';
    ctx.fillRect(cx+12, cy+12, 40, 40);
    // Eyes
    ctx.fillStyle = 'white';
    ctx.fillRect(cx+18, cy+20, 8, 8);
    ctx.fillRect(cx+38, cy+20, 8, 8);

    requestAnimationFrame(draw);
}

// Movement & Logic
function move(dx, dy) {
    if(mode !== 'world') return;
    
    player.x = Math.max(0, Math.min(MAP_W-1, player.x + dx));
    player.y = Math.max(0, Math.min(MAP_H-1, player.y + dy));
    sfx.step();
    
    // Check Encounter
    const encounter = sims.find(s => s.x === player.x && s.y === player.y);
    if(encounter) {
        startEncounter(encounter);
    }

    // Sync to Firebase (Throttled)
    if(player.name && db) {
        const now = Date.now();
        if(now - lastPosUpdate > 200) {
            db.ref("players/" + player.name).update({
                x: player.x, 
                y: player.y,
                ts: now
            });
            lastPosUpdate = now;
        }
    }

    drawMinimap();
}

function startEncounter(sim) {
    mode = 'battle';
    document.getElementById('encounterPanel').classList.add('show');
    document.getElementById('encounterTitle').textContent = `Wild ${sim.type.name} (${sim.rarity})`;
    
    document.getElementById('btnFight').onclick = () => {
        document.getElementById('encounterPanel').classList.remove('show');
        startBattle(sim);
    };
    document.getElementById('btnCatchSim').onclick = () => attemptCatch(sim);
    document.getElementById('btnRun').onclick = () => {
        mode = 'world';
        document.getElementById('encounterPanel').classList.remove('show');
    };
}

function attemptCatch(sim) {
    // Simple catch logic
    const roll = Math.random();
    let chance = 0.6;
    if(sim.rarity === 'Legendary') chance = 0.3;
    
    if(roll < chance) {
        sfx.catch();
        alert(`Caught ${sim.type.name}!`);
        simdex[Date.now()] = sim;
        // Remove from map
        sims = sims.filter(s => s !== sim);
        gainXP(25);
        document.getElementById('encounterPanel').classList.remove('show');
        mode = 'world';
    } else {
        alert("It broke free!");
    }
}

function startBattle(sim) {
    document.getElementById('battlePanel').classList.add('show');
    document.getElementById('enemyLabel').textContent = sim.type.name;
    document.getElementById('hpEnemy').style.width = '100%';
    
    // Generate simple battle buttons
    const bDiv = document.getElementById('battleButtons');
    bDiv.innerHTML = '';
    ['Tackle', 'Scratch'].forEach(move => {
        let btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = move;
        btn.onclick = () => {
            // Player hit
            let dmg = 30 + Math.random()*20;
            let ehp = parseFloat(document.getElementById('hpEnemy').style.width) - dmg;
            document.getElementById('hpEnemy').style.width = Math.max(0, ehp) + '%';
            
            if(ehp <= 0) {
                setTimeout(() => {
                    alert("You Won!");
                    document.getElementById('battlePanel').classList.remove('show');
                    mode = 'world';
                    gainXP(50);
                    coins += 10;
                    sims = sims.filter(s => s !== sim);
                    updateHUD();
                }, 500);
            }
        };
        bDiv.appendChild(btn);
    });

    document.getElementById('btnRunBattle').onclick = () => {
        document.getElementById('battlePanel').classList.remove('show');
        mode = 'world';
    }
}

function drawMinimap() {
    mctx.fillStyle = '#000'; mctx.fillRect(0,0,140,140);
    // Draw player
    const mx = (player.x / MAP_W) * 140;
    const my = (player.y / MAP_H) * 140;
    mctx.fillStyle = '#0f0'; mctx.fillRect(mx-1, my-1, 3, 3);
}

// --- 5. SHOP SYSTEM (Unified) ---
const shopItems = [
    {id:"heal", name:"Full Heal", price:20, icon:"üíä", action:()=>{ 
        player.hp = player.maxHp; 
        alert("Party Healed!"); 
    }},
    {id:"shard", name:"Upgrade Shard", price:150, icon:"‚ö°", action:()=>{ 
        alert("Simitaur Power Up! (+5 ATK)");
    }},
    {id:"xp", name:"XP Boost", price:50, icon:"üìò", action:()=>{ 
        gainXP(100); 
    }},
    {id:"suit", name:"Gold Suit", price:500, icon:"üëë", action:()=>{ 
        alert("Unlocked Cosmetic!");
    }}
];

function buildShop() {
    const grid = document.getElementById('shopGrid');
    grid.innerHTML = '';
    shopItems.forEach(item => {
        const el = document.createElement('div');
        el.className = 'itemCard';
        el.innerHTML = `
            <div style="font-size:32px">${item.icon}</div>
            <div style="font-weight:bold; margin:5px 0">${item.name}</div>
            <div style="color:#ffd166; font-size:14px">${item.price} ü™ô</div>
        `;
        el.onclick = () => {
            if(coins >= item.price) {
                coins -= item.price;
                updateHUD();
                sfx.coin();
                item.action();
                saveProfile();
            } else {
                alert("Not enough coins!");
            }
        };
        grid.appendChild(el);
    });
}

// --- 6. SAVE/LOAD & FIREBASE SYNC ---
function saveProfile() {
    if(!player.name || !db) return;
    db.ref("profiles/" + player.name).set({
        xp: player.xp,
        level: player.level,
        coins: coins,
        sapphires: sapphires
    });
}

function loadProfile(name) {
    if(!db) return;
    db.ref("profiles/" + name).once('value').then(snap => {
        const d = snap.val();
        if(d) {
            player.xp = d.xp || 0;
            player.level = d.level || 1;
            coins = d.coins || 100;
            sapphires = d.sapphires || 0;
            updateHUD();
        }
    });
}

// Listen for other players
function initMultiplayerListener() {
    if(!db) return;
    const playersRef = db.ref("players");
    playersRef.on("value", (snap) => {
        const all = snap.val() || {};
        otherPlayers = {};
        for(let key in all) {
            if(key !== player.name) {
                otherPlayers[key] = all[key];
            }
        }
    });
    
    // Remove self on disconnect
    window.addEventListener("beforeunload", () => {
        if(player.name) db.ref("players/"+player.name).remove();
    });
}

// --- 7. INITIALIZATION & EVENTS ---

// Input
window.addEventListener('keydown', e => {
    if(e.key === 'ArrowUp' || e.key === 'w') move(0,-1);
    if(e.key === 'ArrowDown' || e.key === 's') move(0,1);
    if(e.key === 'ArrowLeft' || e.key === 'a') move(-1,0);
    if(e.key === 'ArrowRight' || e.key === 'd') move(1,0);
});

// Touch Input
document.getElementById('padUp').onclick = () => move(0,-1);
document.getElementById('padDown').onclick = () => move(0,1);
document.getElementById('padLeft').onclick = () => move(-1,0);
document.getElementById('padRight').onclick = () => move(1,0);

// UI Buttons
document.getElementById('btnSignIn').onclick = () => {
    const name = document.getElementById('playerName').value.trim();
    if(!name) return alert("Please enter a name");
    player.name = name;
    
    loadProfile(name);
    initMultiplayerListener();
    
    document.getElementById('signin-area').style.display = 'none';
    document.getElementById('menu-main').style.display = 'flex';
};

document.getElementById('btnStart').onclick = () => {
    document.getElementById('menu').classList.remove('show');
    document.getElementById('hud').style.display = 'flex';
    document.getElementById('minimapWrap').style.display = 'flex';
    if(window.innerWidth < 800) document.getElementById('dpad').style.display = 'grid';
    mode = 'world';
    audio.resume();
    spawnSims();
    draw(); // Start Loop
};

document.getElementById('btnShop').onclick = () => {
    buildShop();
    document.getElementById('shopFull').classList.add('show');
};

// Boot
window.onload = () => {
    const loader = document.getElementById('loadingScreen');
    setTimeout(() => {
        loader.style.opacity = 0;
        setTimeout(() => loader.remove(), 500);
    }, 1500);
    updateHUD();
};

</script>
</body>
</html>
