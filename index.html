<!doctype html> <html lang="en"> <head> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width,initial-scale=1"/> <title>Simitaur Adventure — Full</title> <style>   :root{     --bg:#0e1610; --panel:rgba(6,8,6,.9);     --card:#16261a; --accent:#ffd166; --btn:#2f6e3a; --btn-h:#3f8e4d;     --danger:#ff5b5b;   }   html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#fff}   .wrap{max-width:1100px;margin:12px auto;padding:8px}   /* 8 x 10 viewport (W x H) */   canvas#game{display:block;margin:10px auto;border:3px solid #274f34;background:#87d594;image-rendering:pixelated;touch-action:none;width:512px;height:640px}   /* HUD */   #hud{position:fixed;top:12px;right:12px;display:flex;gap:8px;z-index:60}   .pill{background:var(--btn);border:none;color:#fff;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer;box-shadow:0 3px 0 #204c28}   .pill:active{transform:translateY(1px)}   /* DPad */   #dpad{position:fixed;left:12px;bottom:12px;display:grid;grid-template-columns:48px 48px;grid-template-rows:48px 48px 48px;gap:6px;z-index:60}   #dpad button{width:48px;height:48px;border-radius:10px;border:none;background:#254b2d;color:white;font-weight:700;box-shadow:0 3px 0 #173221}   /* Panels */   .panel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:var(--panel);backdrop-filter:blur(3px);z-index:80}   .panel.show{display:flex}   .box{background:var(--card);border:1px solid #2f5b3f;border-radius:12px;padding:16px 20px;box-shadow:0 12px 36px rgba(0,0,0,.6);max-width:94vw}   .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}   button.btn{background:var(--btn);border:none;border-radius:8px;padding:8px 12px;color:#fff;font-weight:700;cursor:pointer}   button.btn:hover{background:var(--btn-h)}   .danger{background:var(--danger)}   .hp{width:220px;height:14px;background:#111;border-radius:6px;overflow:hidden;border:1px solid #000}   .fill{height:100%;background:#ff6b6b;width:100%;transition:width .18s linear}   /* dex */   #dexGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;max-height:60vh;overflow:auto}   .dexCard{display:flex;gap:8px;align-items:center;background:#203425;border:1px solid #2f5b3f;border-radius:10px;padding:8px;cursor:pointer;position:relative;padding-right:12px}   .dexCard img{width:56px;height:56px;object-fit:cover;border-radius:6px}   .rarity-Common{border:2px solid rgba(38,145,255,0.3);box-shadow:0 0 8px rgba(38,145,255,.12)}   .rarity-Uncommon{border:2px solid #999;box-shadow:0 0 8px rgba(160,160,160,.15)}   .rarity-Rare{border:2px solid #7e57c2;box-shadow:0 0 10px rgba(126,87,194,.15)}   .rarity-Legendary{border:2px solid gold;animation:legendGlow 1.6s infinite}   @keyframes legendGlow{0%{box-shadow:0 0 6px gold}50%{box-shadow:0 0 18px gold}100%{box-shadow:0 0 6px gold}}   .rarity-Mythic{border:2px solid #6a5acd;animation:mythGlow 1.8s infinite}   @keyframes mythGlow{0%{box-shadow:0 0 6px #6a5acd}50%{box-shadow:0 0 14px #4aa3ff}100%{box-shadow:0 0 6px #6a5acd}}   .rarity-Exotic{border:3px solid transparent;animation:exoticRainbow 2s linear infinite}   @keyframes exoticRainbow{0%{border-color:#ff0000}14%{border-color:#ff7f00}28%{border-color:#ffff00}42%{border-color:#00ff00}56%{border-color:#0000ff}70%{border-color:#4b0082}84%{border-color:#8f00ff}100%{border-color:#ff0000}}   /* small */   @media (max-width:800px){ canvas#game{width:92vw;height:115vw} #dpad{left:50%;transform:translateX(-50%)} #hud{right:8px;left:8px;justify-content:center} } </style> </head> <body> <div class="wrap">   <!-- 8x10 viewport canvas (512x640 @ TILE 64) -->   <canvas id="game" width="512" height="640"></canvas> </div> <!-- HUD --> <div id="hud" style="display:none">   <button id="btnSettings" class="pill">Settings</button>   <button id="btnDex" class="pill">SimDex</button>   <button id="btnMusic" class="pill">Music: On</button> </div> <!-- Dpad --> <div id="dpad" style="display:none">   <button id="padUp">▲</button>   <button id="padLeft">◀</button>   <button id="padRight">▶</button>   <button id="padDown">▼</button> </div> <!-- MENU / SIGNIN --> <div id="menu" class="panel show">   <div class="box" style="text-align:center;max-width:420px">     <h1>Simitaur Adventure</h1>     <p style="opacity:.9;margin-bottom:12px">Explore, catch, and battle Simitaurs. Upload sprites in Settings.</p>     <div id="signin-area">       <input id="playerName" placeholder="Player name" style="padding:8px;width:80%;margin-bottom:8px"><br>       <input id="playerPass" placeholder="Password" type="password" style="padding:8px;width:80%"><br>       <label style="display:flex;align-items:center;justify-content:center;margin-top:8px"><input id="rememberMe" type="checkbox" style="margin-right:8px"> Remember Me</label>       <div class="row" style="justify-content:center;margin-top:12px">         <button id="btnSignIn" class="btn">Sign In</button>         <button id="btnGuest" class="btn">Play as Guest</button>       </div>     </div>     <div id="menu-main" style="display:none;margin-top:10px" class="row">       <button id="btnStart" class="btn" style="padding:10px 16px">Start Game</button>       <button id="btnOpenSettings" class="btn">Settings</button>       <button id="btnOpenDexPanel" class="btn">SimDex</button>     </div>   </div> </div> <!-- Settings --> <div id="settings" class="panel">   <div class="box" style="min-width:320px">     <h2>Settings & Uploads</h2>     <p>Drop your own sprites. They’ll show in world, battles, and SimDex.</p>     <div class="grid" style="display:grid;grid-template-columns:1fr;gap:8px">       <label>Player Sprite<input id="filePlayer" type="file" accept="image/*"></label>       <label>Charcoal (NPC) Sprite<input id="fileNPC" type="file" accept="image/*"></label>       <label>SimNet (catch image)<input id="fileNet" type="file" accept="image/*"></label>       <label>Frostaur Sprite (Type 1)<input class="fileSim" data-id="0" type="file" accept="image/*"></label>       <label>Rockaur Sprite (Type 2)<input class="fileSim" data-id="1" type="file" accept="image/*"></label>       <label>Leafaur Sprite (Type 3)<input class="fileSim" data-id="2" type="file" accept="image/*"></label>     </div>     <div style="text-align:right;margin-top:12px"><button id="btnCloseSettings" class="btn">Close</button></div>   </div> </div> <!-- SimDex --> <div id="dex" class="panel">   <div class="box" style="max-width:920px">     <h2>Your SimDex</h2>     <div id="dexGrid"></div>     <div style="text-align:center;margin-top:10px"><button id="btnCloseDex" class="btn">Close</button></div>   </div> </div> <!-- Encounter panel --> <div id="encounterPanel" class="panel">   <div class="box">     <h2 id="encounterTitle">Encounter</h2>     <div class="row" style="justify-content:center">       <button id="btnTalk" class="btn">Talk</button>       <button id="btnFight" class="btn">Battle</button>       <button id="btnCatchSim" class="btn">Catch (SimNet)</button>       <button id="btnRun" class="btn danger">Run</button>     </div>   </div> </div> <!-- Choose Sim for battle --> <div id="chooseSimPanel" class="panel">   <div class="box" style="max-width:520px">     <h2>Choose a Sim to battle</h2>     <div id="chooseSimList" class="row" style="justify-content:center"></div>     <div style="text-align:center;margin-top:8px"><button id="btnCancelChoose" class="btn">Cancel</button></div>   </div> </div> <!-- Battle panel --> <div id="battlePanel" class="panel">   <div class="box">     <h2 id="battleTitle">Battle</h2>     <div class="row" style="justify-content:center;gap:20px">       <div style="text-align:center">         <div id="playerLabel" style="font-weight:700">You</div>         <div class="hp"><div id="hpYou" class="fill"></div></div>       </div>       <div style="text-align:center">         <div id="enemyLabel" style="font-weight:700">Enemy</div>         <div class="hp"><div id="hpEnemy" class="fill"></div></div>       </div>     </div>     <div id="battleButtons" class="row" style="justify-content:center;margin-top:8px"></div>     <div style="text-align:center;margin-top:10px"><button id="btnRunBattle" class="btn danger">Run</button></div>   </div> </div> <script> /* ========= Full integrated game ========= */ (() => {   // Canvas & world   const cvs = document.getElementById('game'), ctx = cvs.getContext('2d');   const TILE = 64, VIEW_W = 8, VIEW_H = 10, MAP_W = 100, MAP_H = 100;   cvs.width = VIEW_W * TILE; cvs.height = VIEW_H * TILE;   // State   let mode = 'menu'; // menu, world, battle, encounter   let player = { x: Math.floor(MAP_W/2), y: Math.floor(MAP_H/2), hp: 100, maxHp: 100, img: null, sims: [], xp:0, name:'', pass:'' };   let npc = { x: Math.floor(MAP_W/2)+3, y: Math.floor(MAP_H/2), img: null };   const types = [     { id:0, name:'Frostaur', img:null, src:'', baseRarityWeights:[60,25,10,3,1,1] },     { id:1, name:'Rockaur',  img:null, src:'', baseRarityWeights:[40,30,18,8,3,1] },     { id:2, name:'Leafaur',  img:null, src:'', baseRarityWeights:[30,30,20,12,6,2] }   ];   let sims = []; // wild on map   let simdex = {}; // caught index   let currentEncounter = null; // 'npc' or sim object   let battlePlayerSim = null, battleEnemySim = null;   let netImage = null;   // -------- 8-bit Audio (WebAudio) --------   const AC = window.AudioContext || window.webkitAudioContext;   const audio = new AC();   let musicOn = true, musicToken = 0;   function ensureAudio(){ if(audio.state==='suspended') audio.resume(); }   function tone(freq, dur=0.14, type='square', vol=0.045){     const o = audio.createOscillator(), g = audio.createGain();     o.type = type; o.frequency.value = freq; g.gain.value = vol;     o.connect(g); g.connect(audio.destination);     o.start(); o.stop(audio.currentTime + dur);   }   // SFX   function sfxStep(){ tone(185, .06, 'triangle', .03); }   function sfxAtk(){ tone(760, .10, 'square', .06); tone(520,.08,'square',.04); }   function sfxCatch(){ tone(660, .18, 'square', .07); setTimeout(()=>tone(880,.16,'square',.06),120); }   function sfxWin(){ tone(880, .12, 'sawtooth', .06); setTimeout(()=>tone(660,.12,'square',.05),120); setTimeout(()=>tone(990,.14,'triangle',.05),240); }   // Music: simple chip melody arpeggio loop   function startMusic(){     const token = ++musicToken;     const bass = [98,98,123,98, 87,87,110,87]; // low pulse     const lead = [392,440,494,523,494,440,392,330];     let i=0, j=0;     (function loop(){       if(!musicOn || token !== musicToken) return;       // bass pulse       tone(bass[i%bass.length], .22, 'triangle', .02);       // lead melody       tone(lead[j%lead.length], .20, 'square', .03);       i++; j++;       setTimeout(loop, 360);     })();   }   // simple save/load   const SAVE_KEY = 'simitaur_save_v2';   function saveGame(){     try{       const store = { player:{ name: player.name, pass: player.pass, sims: player.sims.map(s=>({ typeId:s.type.id, hp:s.hp, maxHp:s.maxHp, attacks:s.attacks, rarity:s.rarity, size:s.size, weight:s.weight, src: s.type.src || '' }))}, simdex };       localStorage.setItem(SAVE_KEY, JSON.stringify(store));     }catch(e){ console.warn('save failed', e); }   }   function loadGame(){     try{       const raw = localStorage.getItem(SAVE_KEY); if(!raw) return false;       const obj = JSON.parse(raw); if(!obj?.player?.name) return false;       player.name = obj.player.name; player.pass = obj.player.pass || '';       player.sims = (obj.player.sims || []).map(d => ({ type: types.find(t=>t.id===d.typeId)||types[0], hp:d.hp, maxHp:d.maxHp, attacks:d.attacks||[{name:'Punch',dmg:10}], rarity:d.rarity, size:d.size, weight:d.weight }));       simdex = obj.simdex || {};       return true;     }catch(e){ console.warn('load fail', e); return false; }   }   if(loadGame()){     document.getElementById('playerName').value = player.name;     document.getElementById('menu-main').style.display = 'flex';     document.getElementById('signin-area').style.display = 'none';     document.getElementById('rememberMe').checked = true;   }   // Rarities   const RARITIES = ['Common','Uncommon','Rare','Legendary','Mythic','Exotic'];   function weightedRarity(weights){     const sum = weights.reduce((a,b)=>a+b,0);     let r = Math.random()*sum;     for(let i=0;i<weights.length;i++){ if(r < weights[i]) return i; r -= weights[i]; }     return weights.length-1;   }   function spawnSims(){     sims.length = 0;     for(let y=0;y<MAP_H;y++){       for(let x=0;x<MAP_W;x++){         if(Math.random() < 0.018 && !(x===player.x && y===player.y)){           const t = types[Math.floor(Math.random()*types.length)];           const idx = weightedRarity(t.baseRarityWeights.slice());           const rarity = RARITIES[idx];           const hp = 20 + Math.floor(Math.random()*60);           const size = 1 + Math.floor(Math.random()*3);           const weight = 1 + Math.floor(Math.random()*5);           const attacks = [             {name:'Tackle',dmg:5+Math.floor(Math.random()*7)},             {name:'Bite',dmg:6+Math.floor(Math.random()*10)},             {name:'Focus Punch',dmg:10+Math.floor(Math.random()*6)}           ];           sims.push({ x,y, type: t, hp, maxHp: hp, attacks, rarity, size, weight });         }       }     }   }   spawnSims();   // draw loop variables (sparkle anim phase)   let sparklePhase = 0;   // Tile palette   const grassA = '#81d58f', grassB = '#74cc86', path = '#6fc17f';   function draw(){     // world background tiles (checker)     for(let y=0;y<VIEW_H;y++){       for(let x=0;x<VIEW_W;x++){         const gx = player.x - Math.floor(VIEW_W/2) + x;         const gy = player.y - Math.floor(VIEW_H/2) + y;         const c = ((gx+gy)&1) ? grassA : grassB;         ctx.fillStyle = c;         ctx.fillRect(x*TILE, y*TILE, TILE, TILE);       }     }     const vx0 = player.x - Math.floor(VIEW_W/2);     const vy0 = player.y - Math.floor(VIEW_H/2);     // NPC Charcoal     const nx = npc.x - vx0, ny = npc.y - vy0;     if(nx>=0 && nx<VIEW_W && ny>=0 && ny<VIEW_H){       if(npc.img) ctx.drawImage(npc.img, nx*TILE, ny*TILE, TILE, TILE);       else { ctx.fillStyle='#f4a261'; ctx.fillRect(nx*TILE, ny*TILE, TILE, TILE); }     }     // Wild Sims + rarity effects     sims.forEach(s=>{       const sx = s.x - vx0, sy = s.y - vy0;       if(sx>=0 && sx<VIEW_W && sy>=0 && sy<VIEW_H){         if(s.type.img) ctx.drawImage(s.type.img, sx*TILE, sy*TILE, TILE, TILE);         else { const cols=['#ff595e','#8ac926','#1982c4']; ctx.fillStyle=cols[s.type.id%cols.length]; ctx.fillRect(sx*TILE, sy*TILE, TILE, TILE); }         // rarity visuals as requested         if(s.rarity==='Exotic'){           const phase=(sparklePhase+s.x+s.y)*0.12;           const colors=['#ff0000','#ff7f00','#ffff00','#00ff00','#0000ff','#4b0082','#8f00ff'];           const c = colors[Math.floor((phase*10)%colors.length)];           ctx.strokeStyle=c; ctx.lineWidth=3; ctx.strokeRect(sx*TILE+2, sy*TILE+2, TILE-4, TILE-4);         } else if(s.rarity==='Mythic'){           // blue + purple shimmer           const t = 0.5+0.5*Math.sin(sparklePhase*1.5 + s.x);           const c = `rgba(${Math.floor(80+100*t)},${Math.floor(100+80*t)},255,0.9)`;           ctx.strokeStyle=c; ctx.lineWidth=3; ctx.strokeRect(sx*TILE+2, sy*TILE+2, TILE-4, TILE-4);         } else if(s.rarity==='Legendary'){           const alpha=0.4 + Math.abs(Math.sin(sparklePhase + s.x))*0.6;           ctx.strokeStyle=`rgba(255,215,0,${alpha})`; ctx.lineWidth=3; ctx.strokeRect(sx*TILE+2, sy*TILE+2, TILE-4, TILE-4);         } else if(s.rarity==='Rare'){           // purple sparkles           ctx.fillStyle=`rgba(126,87,194,${0.35+0.2*Math.sin(sparklePhase + s.x)})`;           ctx.fillRect(sx*TILE + TILE/2 - 4, sy*TILE + 6, 8, 8);         } else if(s.rarity==='Uncommon'){           // grey sparkles           ctx.fillStyle=`rgba(180,180,180,${0.3+0.2*Math.sin(sparklePhase + s.y)})`;           ctx.fillRect(sx*TILE + 10, sy*TILE + 18, 6, 6);         } else if(s.rarity==='Common'){           // blue sparkles           ctx.fillStyle=`rgba(38,145,255,${0.3+0.2*Math.cos(sparklePhase + s.y)})`;           ctx.fillRect(sx*TILE + TILE-16, sy*TILE + 8, 6, 6);         }       }     });     // Player at screen center     const px = Math.floor(VIEW_W/2)*TILE, py = Math.floor(VIEW_H/2)*TILE;     if(player.img) ctx.drawImage(player.img, px, py, TILE, TILE);     else { ctx.fillStyle='#1d3557'; ctx.fillRect(px, py, TILE, TILE); }     sparklePhase += 0.08;   }   // Movement (one tile per step)   function move(dx,dy){     if(mode !== 'world') return;     ensureAudio();     const nx = Math.max(0, Math.min(MAP_W-1, player.x + dx));     const ny = Math.max(0, Math.min(MAP_H-1, player.y + dy));     if(nx===player.x && ny===player.y) return;     player.x = nx; player.y = ny;     sfxStep();     checkTileInteraction();     draw();   }   // D-pad   [['padUp',0,-1],['padDown',0,1],['padLeft',-1,0],['padRight',1,0]].forEach(([id,dx,dy])=>{     const el=document.getElementById(id);     let tId;     el.addEventListener('click', ()=>move(dx,dy));     el.addEventListener('touchstart', e=>{ e.preventDefault(); move(dx,dy); tId=setInterval(()=>move(dx,dy),140); });     el.addEventListener('touchend', e=>{ clearInterval(tId); });     el.addEventListener('mousedown', ()=>{ move(dx,dy); });   });   // Keyboard   window.addEventListener('keydown', e=>{     if(mode !== 'world') return;     if(e.key==='ArrowUp'||e.key==='w') move(0,-1);     if(e.key==='ArrowDown'||e.key==='s') move(0,1);     if(e.key==='ArrowLeft'||e.key==='a') move(-1,0);     if(e.key==='ArrowRight'||e.key==='d') move(1,0);   });   // -------- Menu & Sign in --------   function show(el, on){ document.getElementById(el).classList[on?'add':'remove']('show'); }   document.getElementById('btnSignIn').addEventListener('click', ()=>{     const n = document.getElementById('playerName').value.trim();     const p = document.getElementById('playerPass').value;     if(!n || !p) return alert('Enter name and password');     player.name = n; player.pass = p;     if(document.getElementById('rememberMe').checked) saveGame();     document.getElementById('signin-area').style.display = 'none';     document.getElementById('menu-main').style.display = 'flex';   });   document.getElementById('btnGuest').addEventListener('click', ()=>{     player.name = 'Guest';     document.getElementById('signin-area').style.display = 'none';     document.getElementById('menu-main').style.display = 'flex';   });   document.getElementById('btnStart').addEventListener('click', ()=>{     mode = 'world';     show('menu', false);     document.getElementById('hud').style.display = 'flex';     document.getElementById('dpad').style.display = 'grid';     draw();     startMusic();   });   // -------- Settings uploads --------   function loadImgFromInput(el, cb){     const f = el.files?.[0]; if(!f) return;     const url = URL.createObjectURL(f);     const img = new Image();     img.onload = ()=>{ cb(img, url); URL.revokeObjectURL(url); draw(); };     img.src = url;   }   document.getElementById('filePlayer').addEventListener('change', e=> loadImgFromInput(e.target, (img)=> player.img = img ));   document.getElementById('fileNPC').addEventListener('change', e=> loadImgFromInput(e.target, (img)=> npc.img = img ));   document.getElementById('fileNet').addEventListener('change', e=> loadImgFromInput(e.target, (img)=> netImage = img ));   document.querySelectorAll('.fileSim').forEach(inp=>{     inp.addEventListener('change', e=>{       const id = Number(inp.dataset.id);       loadImgFromInput(e.target, (img,url)=>{ types[id].img = img; types[id].src = url; draw(); });     });   });   document.getElementById('btnOpenSettings').addEventListener('click', ()=>show('settings', true));   document.getElementById('btnCloseSettings').addEventListener('click', ()=>show('settings', false));   document.getElementById('btnSettings').addEventListener('click', ()=>show('settings', true));   // -------- SimDex --------   function buildDex(){     const grid = document.getElementById('dexGrid'); grid.innerHTML = '';     const keys = Object.keys(simdex);     if(!keys.length){ grid.innerHTML = '<p style="opacity:.8">No Simitaurs caught yet.</p>'; return; }     keys.forEach(k=>{       const d = simdex[k];       const el = document.createElement('div'); el.className = 'dexCard rarity-' + (d.rarity || 'Common');       const img = document.createElement('img'); img.src = d.src || '';       const info = document.createElement('div'); info.innerHTML = `<b>${d.name}</b><br>Rarity:${d.rarity}<br>HP:${d.hp}`;       el.appendChild(img); el.appendChild(info);       el.addEventListener('click', ()=> alert(`${d.name}\nRarity: ${d.rarity}\nHP: ${d.hp}\nSize: ${d.size}\nWeight: ${d.weight}`));       grid.appendChild(el);     });   }   document.getElementById('btnOpenDexPanel').addEventListener('click', ()=>{ buildDex(); show('dex', true); });   document.getElementById('btnDex').addEventListener('click', ()=>{ buildDex(); show('dex', true); });   document.getElementById('btnCloseDex').addEventListener('click', ()=>show('dex', false));   // -------- Music toggle --------   document.getElementById('btnMusic').addEventListener('click', ()=>{     musicOn = !musicOn;     document.getElementById('btnMusic').textContent = 'Music: ' + (musicOn ? 'On' : 'Off');     if(musicOn) startMusic(); else musicToken++;   });   // -------- Encounters --------   function checkTileInteraction(){     // NPC     if(player.x === npc.x && player.y === npc.y){       currentEncounter = 'npc';       show('encounterPanel', true);       document.getElementById('encounterTitle').textContent = 'Charcoal: Talk or Battle?';       document.getElementById('btnTalk').style.display = 'inline-block';       document.getElementById('btnFight').style.display = 'inline-block';       document.getElementById('btnCatchSim').style.display = 'none';       return;     }     // Wild     const wild = sims.find(s => s.x === player.x && s.y === player.y);     if(wild){       currentEncounter = wild;       show('encounterPanel', true);       document.getElementById('encounterTitle').textContent = `A wild ${wild.type.name} (${wild.rarity}) appears!`;       document.getElementById('btnTalk').style.display = 'none';       document.getElementById('btnFight').style.display = 'inline-block';       document.getElementById('btnCatchSim').style.display = 'inline-block';       return;     }     currentEncounter = null;   }   // Encounter buttons   function wire(id, fn){ const el=document.getElementById(id); el.addEventListener('click', fn); el.addEventListener('touchstart', e=>{ e.preventDefault(); fn(); }); }   wire('btnRun', ()=>{ currentEncounter = null; show('encounterPanel', false); });   wire('btnTalk', ()=>{ if(currentEncounter === 'npc'){ alert('Charcoal: Welcome! Catch Simitaurs and train them — some are rare!'); show('encounterPanel', false); currentEncounter = null; }});   // Choose team sim before battle   function openChooseSim(cb){     const list = document.getElementById('chooseSimList'); list.innerHTML = '';     if(player.sims.length===0){ alert('No sims in your team! You will use a starter.'); cb(null); return; }     player.sims.forEach((s,i)=>{       const el = document.createElement('button'); el.className='btn'; el.textContent = `${s.type.name} (HP:${s.hp})`;       el.addEventListener('click', ()=>{ document.getElementById('chooseSimPanel').classList.remove('show'); cb(s); });       list.appendChild(el);     });     document.getElementById('btnCancelChoose').onclick = ()=>{ document.getElementById('chooseSimPanel').classList.remove('show'); cb(null); };     show('chooseSimPanel', true);   }   document.getElementById('btnFight').onclick = ()=>{     show('encounterPanel', false);     openChooseSim((chosen)=>{       if(currentEncounter==='npc'){         const npcSim = { type: types[Math.floor(Math.random()*types.length)], hp: 30+Math.floor(Math.random()*50), maxHp: 30+Math.floor(Math.random()*50), attacks:[{name:'Smash',dmg:8},{name:'Roar',dmg:10}], rarity:'Rare', size:2, weight:3 };         startBattleWithChosen(chosen || starter(), npcSim);       } else if(currentEncounter){         startBattleWithChosen(chosen || starter(), currentEncounter);       }     });   };   function starter(){ return { type: types[0], hp:40, maxHp:40, attacks:[{name:'Punch',dmg:10},{name:'Jab',dmg:7}], rarity:'Common', size:1, weight:1 }; }   // Catch button   wire('btnCatchSim', ()=>{ if(currentEncounter && currentEncounter !== 'npc') runCatchSequence(currentEncounter); });   // Catch animation & logic   function captureChanceByRarity(r){     switch(r){ case 'Common': return 70; case 'Uncommon': return 55; case 'Rare': return 38; case 'Legendary': return 20; case 'Mythic': return 12; case 'Exotic': return 6; default: return 50; }   }   function runCatchSequence(sim){     show('encounterPanel', false);     const dur = 720; const start = performance.now(); const cx = cvs.width/2, cy = cvs.height/2;     function anim(now){       const t = Math.min(1,(now-start)/dur);       draw();       ctx.save();       const sx = cx, sy = cy - 40 * Math.sin(t*Math.PI);       if(netImage){         const s = 1 + 1.2*t;         ctx.drawImage(netImage, sx-48*s, sy-48*s, 96*s, 96*s);       } else {         ctx.strokeStyle='white'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(sx, sy, 36 + 30*t, Math.PI*0.2, Math.PI*0.8); ctx.stroke();       }       ctx.restore();       if(t<1) requestAnimationFrame(anim);       else {         ensureAudio(); sfxCatch();         const chance = captureChanceByRarity(sim.rarity);         if(Math.random()*100 < chance){           const id = sim.type.name + '-' + Date.now();           simdex[id] = { name: sim.type.name, rarity: sim.rarity, hp: sim.hp, size: sim.size, weight: sim.weight, src: sim.type.src || '' };           const idx = sims.indexOf(sim); if(idx>=0) sims.splice(idx,1);           player.sims.push({ type: sim.type, hp: sim.hp, maxHp: sim.maxHp, attacks: sim.attacks, rarity: sim.rarity, size: sim.size, weight: sim.weight });           player.xp = (player.xp||0)+10;           if(document.getElementById('rememberMe').checked) saveGame();           buildDex();           alert(`Caught ${sim.type.name} (${sim.rarity})!`);         } else alert(`${sim.type.name} escaped!`);       }     }     requestAnimationFrame(anim);   }   // -------- Battle system (turn-based) --------   function startBattleWithChosen(playerSim, enemySimSource){     battleEnemySim = { ...enemySimSource, hp: enemySimSource.hp, maxHp: enemySimSource.maxHp, attacks: enemySimSource.attacks ? enemySimSource.attacks.slice() : (enemySimSource.attacks || []) };     battlePlayerSim = playerSim;     mode = 'battle';     show('battlePanel', true);     populateBattleUI();   }   function populateBattleUI(){     document.getElementById('battleTitle').textContent = `Battle vs ${battleEnemySim.type ? battleEnemySim.type.name : 'Enemy'}`;     document.getElementById('playerLabel').textContent = player.name || 'You';     document.getElementById('enemyLabel').textContent = battleEnemySim.type ? battleEnemySim.type.name : 'Enemy';     updateHPbars();     const div = document.getElementById('battleButtons'); div.innerHTML = '';     (battlePlayerSim.attacks || []).forEach(a=>{       const b = document.createElement('button'); b.className='btn'; b.textContent=a.name;       b.addEventListener('click', ()=> playerUseAttack(a));       b.addEventListener('touchstart', e=>{ e.preventDefault(); playerUseAttack(a); });       div.appendChild(b);     });     document.getElementById('btnRunBattle').onclick = ()=>{ show('battlePanel', false); mode = 'world'; battleEnemySim = null; battlePlayerSim = null; };   }   function updateHPbars(){     if(battlePlayerSim) document.getElementById('hpYou').style.width = Math.max(0,(battlePlayerSim.hp/battlePlayerSim.maxHp*100))+'%';     if(battleEnemySim) document.getElementById('hpEnemy').style.width = Math.max(0,(battleEnemySim.hp/battleEnemySim.maxHp*100))+'%';   }   function playerUseAttack(a){     if(!battleEnemySim||!battlePlayerSim) return;     ensureAudio(); sfxAtk();     const base = a.dmg || (8+Math.floor(Math.random()*6));     const dmg = Math.max(1, base + Math.floor((Math.random()-0.5)*4));     battleEnemySim.hp = Math.max(0, battleEnemySim.hp - dmg);     updateHPbars();     if(battleEnemySim.hp<=0){ setTimeout(()=>{ sfxWin(); onBattleWin(); }, 220); return; }     setTimeout(()=> enemyTurn(), 420);   }   function enemyTurn(){     if(!battleEnemySim||!battlePlayerSim) return;     const atk = (battleEnemySim.attacks && battleEnemySim.attacks.length) ? battleEnemySim.attacks[Math.floor(Math.random()*battleEnemySim.attacks.length)] : {name:'Tackle',dmg:6};     ensureAudio(); sfxAtk();     const dmg = Math.max(1, atk.dmg + Math.floor((Math.random()-0.5)*4));     battlePlayerSim.hp = Math.max(0, battlePlayerSim.hp - dmg);     updateHPbars();     if(battlePlayerSim.hp<=0){ setTimeout(()=> onBattleLose(), 220); }   }   function onBattleWin(){     show('battlePanel', false);     if(currentEncounter && currentEncounter !== 'npc'){       player.xp = (player.xp||0)+12;       const idx = sims.indexOf(currentEncounter); if(idx>=0) sims.splice(idx,1);       simdex[currentEncounter.type.name + '-' + Date.now()] = { name: currentEncounter.type.name, rarity: currentEncounter.rarity, hp: currentEncounter.hp, size: currentEncounter.size, weight: currentEncounter.weight, src: currentEncounter.type.src || '' };       player.sims.push({ type: currentEncounter.type, hp: currentEncounter.hp, maxHp: currentEncounter.maxHp, attacks: currentEncounter.attacks, rarity: currentEncounter.rarity, size: currentEncounter.size, weight: currentEncounter.weight });       if(document.getElementById('rememberMe').checked) saveGame();       buildDex();       alert(`Victory! Claimed ${currentEncounter.type.name} and added to SimDex + team.`);       currentEncounter = null;     } else { player.xp = (player.xp||0)+18; alert('You won the NPC battle! XP gained.'); }     battleEnemySim = null; battlePlayerSim = null; mode = 'world';   }   function onBattleLose(){     show('battlePanel', false);     alert('You lost. Your Sim recovers to half HP.');     if(player.sims[0]) player.sims[0].hp = Math.max(1, Math.floor(player.sims[0].maxHp * 0.5));     battleEnemySim = null; battlePlayerSim = null; mode = 'world';   }   // -------- Helpers / Panels --------   // open/close panels from HUD   document.getElementById('btnOpenSettings').onclick = ()=>show('settings', true);   document.getElementById('btnCloseSettings').onclick = ()=>show('settings', false);   document.getElementById('btnOpenDexPanel').onclick = ()=>{ buildDex(); show('dex', true); };   document.getElementById('btnCloseDex').onclick = ()=>show('dex', false);   // -------- Render loop (keeps sparkle lively) --------   (function renderLoop(){     if(mode==='world') draw();     requestAnimationFrame(renderLoop);   })();   // Debug hook if needed   window.Simitaur = { spawnSims, sims, player, simdex, types }; })(); // IIFE end </script> </body> </html>
