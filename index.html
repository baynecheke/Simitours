<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Simitaur RPG — Adventure — Quests • Coins • Shop • Mini-Map</title>
<style>

  :root{
    --bg:#071018;                      /* deep night blue */
    --panel:rgba(6,8,6,.88);
    --card:#0f1b1a;                     /* dark parchment-like card */
    --accent:#c9a34a;                   /* warm gold accent */
    --btn:#2b475d;                      /* steel blue buttons */
    --btn-h:#375f7a;                    /* hover */
    --danger:#d85757;
    --ink:#f7f3e9;                      /* warm cream text */
    --ring:#3b5a6b;
    --glass:rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, system-ui, -apple-system, Arial;background:linear-gradient(180deg,#041018 0%, #072029 100%);color:var(--ink);-webkit-font-smoothing:antialiased}
  .wrap{max-width:1100px;margin:12px auto;padding:10px}
  canvas#game{
    display:block;margin:8px auto;border-radius:14px;border:4px solid rgba(255,255,255,0.04);
    background:linear-gradient(180deg,#7cc57a 0%, #5ea86a 100%);box-shadow:0 20px 40px rgba(2,6,10,0.6);
    image-rendering:pixelated;image-rendering:crisp-edges;touch-action:none
  }
  /* HUD */
  #hud{position:fixed;top:18px;left:18px;right:18px;display:flex;gap:10px;z-index:60;flex-wrap:wrap;align-items:center}
  .pill{background:linear-gradient(180deg,var(--btn),var(--btn-h));border:none;color:var(--ink);border-radius:999px;padding:9px 14px;font-weight:800;cursor:pointer;box-shadow:0 6px 0 rgba(0,0,0,0.48), inset 0 -2px 0 rgba(0,0,0,0.12);transition:transform .08s ease,box-shadow .08s;}
  .pill:active{transform:translateY(2px);box-shadow:0 3px 0 rgba(0,0,0,0.6)}
  .pill.secondary{background:linear-gradient(180deg,#2a3946,#202f3a)}
  .stat{display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));border:1px solid var(--ring);border-radius:999px;padding:8px 12px;font-weight:800;backdrop-filter:blur(4px)}
  .stat img{width:18px;height:18px}
  #coinGain{position:fixed;top:18px;right:22px;font-weight:900;color:var(--accent);text-shadow:0 2px 0 rgba(0,0,0,0.6);pointer-events:none;z-index:70;opacity:0;transition:transform .45s ease,opacity .45s ease}
  /* DPad */
  #dpad{
    position:fixed;left:18px;bottom:18px;display:grid;
    grid-template-columns:56px 56px;grid-template-rows:56px 56px 56px;gap:10px;z-index:60
  }
  #dpad button{width:56px;height:56px;border-radius:12px;border:none;background:linear-gradient(180deg,#1b3b4d,#173141);color:var(--ink);font-weight:900;box-shadow:0 6px 0 rgba(0,0,0,0.5);font-size:18px;user-select:none}
  #dpad .ghost{opacity:.75}
  /* Panels / Modals */
  .panel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,6,10,0.6), rgba(0,0,0,0.7));backdrop-filter:blur(6px);z-index:80}
  .panel.show{display:flex}
  .box{background:linear-gradient(180deg,var(--card), rgba(10,12,10,0.98));border:1px solid rgba(255,255,255,0.03);border-radius:12px;padding:18px 22px;box-shadow:0 20px 50px rgba(0,0,0,.6);max-width:94vw;color:var(--ink)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  button.btn{background:linear-gradient(180deg,var(--btn),var(--btn-h));border:none;border-radius:10px;padding:10px 14px;color:var(--ink);font-weight:800;cursor:pointer;box-shadow:0 8px 0 rgba(0,0,0,0.48)}
  button.btn:hover{transform:translateY(-1px)}
  .danger{background:linear-gradient(180deg,#c94b4b,#a83b3b)}
  .hp{width:260px;height:16px;background:linear-gradient(90deg,#0b1a12,#081412);border-radius:8px;overflow:hidden;border:1px solid rgba(0,0,0,0.6)}
  .fill{height:100%;background:linear-gradient(90deg,#ff6b6b,#ffd166);width:100%;transition:width .18s linear;box-shadow:inset 0 -3px 8px rgba(0,0,0,0.35)}
  .label{font-weight:900;margin-bottom:6px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);border-radius:6px;padding:4px 8px}
  .note{font-size:13px;opacity:.9;color:rgba(255,255,255,0.85)}
  /* Draggable windows (Shop/Settings/Quests) */
  .float{position:fixed;top:80px;left:60px;z-index:85;background:linear-gradient(180deg,var(--card),rgba(8,14,12,0.96));border:1px solid rgba(255,255,255,0.03);border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.6);display:none;min-width:320px;max-width:90vw}
  .float.show{display:block}
  .float .titlebar{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.02);cursor:move;border-radius:14px 14px 0 0;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}
  .float .content{padding:14px;max-height:60vh;overflow:auto}
  .closeX{background:linear-gradient(180deg,#2b475d,#202f3a);border:1px solid rgba(255,255,255,0.02);color:var(--ink);border-radius:8px;padding:6px 10px;cursor:pointer}
  /* Shop list */
  .healRow{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid rgba(255,255,255,0.03);border-radius:10px;margin-bottom:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03))}
  .bar{height:10px;background:linear-gradient(90deg,#0f2418,#08140f);border-radius:999px;overflow:hidden;border:1px solid rgba(0,0,0,0.6)}
  .bar > i{display:block;height:100%;background:linear-gradient(90deg,#24d17b,#9be7a5);width:50%;transition:width .25s ease}
  /* Mini-map */
  #minimapWrap{position:fixed;right:18px;bottom:18px;z-index:65;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  #minimap{width:160px;height:160px;border-radius:10px;border:2px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,#041017,#071621);image-rendering:pixelated}
  #btnMini{background:linear-gradient(180deg,#162e3b,#10313a);border:1px solid rgba(255,255,255,0.02);border-radius:8px;color:var(--ink);padding:8px 12px;cursor:pointer}
  /* Suit shop in settings */
  .suitSlot{display:flex;gap:12px;align-items:center;border:1px solid rgba(255,255,255,0.02);padding:10px;border-radius:10px;margin-top:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03))}
  .suitSlot img{width:56px;height:56px;object-fit:cover;border-radius:8px;background:rgba(0,0,0,0.2)}
  .suitSlot .meta{flex:1}
  .suitSlot .meta .name{font-weight:900}
  .suitSlot .meta .owned{font-size:12px;opacity:.95}
  /* small screens */
  @media (max-width:860px){
    canvas#game{width:94vw;height:auto;border-radius:10px}
    #dpad{left:50%;transform:translateX(-50%);grid-template-columns:64px 64px;grid-template-rows:64px 64px 64px}
    #dpad button{width:64px;height:64px;border-radius:14px;font-size:22px}
    #hud{left:8px;right:8px;justify-content:center}
  }
  /* Boss Active glow style */
  .bossActive {
    color:var(--accent);
    text-shadow:0 0 10px rgba(201,163,74,0.85), 0 0 24px rgba(201,163,74,0.45);
    font-weight:900;
  }

</style>
</head>
<body>
<div class="wrap">
  <canvas id="game" width="640" height="640"></canvas>
</div>

<!-- HUD -->
<div id="hud" style="display:none">
  <div class="stat" title="Coins"><svg width="18" height="18" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#ffd166"/><circle cx="12" cy="12" r="6" fill="#d8a800"/></svg><span id="coinLabel">0</span></div>

  <!-- SAPPHIRE stat (mirrors coin UI) -->
  <div class="stat" title="Sapphires" style="background:#102033;border:1px solid #2a4b6a;">
    <svg width="18" height="18" viewBox="0 0 24 24" style="filter:drop-shadow(0 1px 0 rgba(0,0,0,.6));">
      <path d="M12 2 L20 9 L14 22 L6 22 L0 9 Z" fill="#4fd1c5"></path>
      <path d="M12 2 L4 9 L10 22 L18 22 L24 9 Z" fill="#3ab8a9" opacity=".9"></path>
    </svg>
    <span id="sapphireLabel">0</span>
  </div>

  <button id="btnSettings" class="pill">Settings</button>
  <button id="btnDex" class="pill">SimDex</button>
  <button id="btnShop" class="pill">Shop</button>
  <button id="btnQuests" class="pill">Quests</button>
  <button id="btnMusic" class="pill">Music: On</button>
  <button id="btnSignOut" class="pill secondary">Sign Out</button>
</div>
<div id="coinGain">+5</div>

<!-- Dpad -->
<div id="dpad" style="display:none">
  <button id="padUp" class="ghost">▲</button>
  <button id="padLeft">◀</button>
  <button id="padRight">▶</button>
  <button id="padDown" class="ghost">▼</button>
</div>

<!-- MENU -->
<div id="menu" class="panel show">
  <div class="box" style="text-align:center;max-width:520px">
    <h1 style="margin:6px 0 2px">Simitaur RPG — Adventure</h1>
    <p class="muted" style="margin:0 0 10px">Explore, catch, and battle Simitaurs. Upload sprites in <b>Settings</b>. Catching grants coins. Boss spawns every 24 hours — beat it for sapphires!</p>
    <div id="signin-area">
      <input id="playerName" placeholder="Player name" style="padding:10px;width:86%;margin:6px;border-radius:8px;border:1px solid #274f34;background:#0f1b13;color:#eafff0"><br>
      <input id="playerPass" placeholder="Password" type="password" style="padding:10px;width:86%;margin:6px;border-radius:8px;border:1px solid #274f34;background:#0f1b13;color:#eafff0"><br>
      <label style="display:flex;align-items:center;justify-content:center;margin-top:4px"><input id="rememberMe" type="checkbox" style="margin-right:8px"> Remember Me</label>
      <div class="row" style="justify-content:center;margin-top:12px">
        <button id="btnSignIn" class="btn">Sign In</button>
        <button id="btnGuest" class="btn">Play as Guest</button>
      </div>
    </div>
    <div id="menu-main" style="display:none;margin-top:10px" class="row">
      <button id="btnStart" class="btn" style="padding:10px 16px">Start Game</button>
      <button id="btnOpenSettings" class="btn">Settings</button>
      <button id="btnOpenDexPanel" class="btn">SimDex</button>
    </div>
    <p class="note">Controls: <span class="kbd">Arrow Keys / WASD</span> or on-screen D-Pad • Walk onto sims to interact</p>
  </div>
</div>

<!-- Settings (draggable) -->
<div id="settingsWin" class="float" style="top:96px;left:80px">
  <div class="titlebar"><b>Settings & Uploads</b><button class="closeX" data-close="#settingsWin">Close</button></div>
  <div class="content">
    <div class="row" style="gap:14px">
      <div>
        <label>Player Sprite (file)</label><input id="filePlayer" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">Player Sprite URL</label><div style="display:flex;gap:6px"><input id="urlPlayer" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button id="loadUrlPlayer" class="btn">Load</button></div>
      </div>
      <div>
        <label>Charcoal (NPC) Sprite (file)</label><input id="fileNPC" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">NPC Sprite URL</label><div style="display:flex;gap:6px"><input id="urlNPC" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button id="loadUrlNPC" class="btn">Load</button></div>
      </div>
      <div>
        <label>SimNet (catch image) (file)</label><input id="fileNet" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">SimNet URL</label><div style="display:flex;gap:6px"><input id="urlNet" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button id="loadUrlNet" class="btn">Load</button></div>
      </div>
    </div>
    <div style="height:8px"></div>
    <div class="row" style="gap:14px;flex-wrap:wrap">
      <!-- 7 sim slots now -->
      <div style="min-width:220px">
        <label>Sim Sprite Slot 1 (file)</label><input class="fileSim" data-id="0" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">Slot 1 URL</label><div style="display:flex;gap:6px"><input class="urlSim" data-id="0" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button class="loadUrlSim btn" data-id="0">Load</button></div>
      </div>
      <div style="min-width:220px">
        <label>Sim Sprite Slot 2 (file)</label><input class="fileSim" data-id="1" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">Slot 2 URL</label><div style="display:flex;gap:6px"><input class="urlSim" data-id="1" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button class="loadUrlSim btn" data-id="1">Load</button></div>
      </div>
      <div style="min-width:220px">
        <label>Sim Sprite Slot 3 (file)</label><input class="fileSim" data-id="2" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">Slot 3 URL</label><div style="display:flex;gap:6px"><input class="urlSim" data-id="2" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button class="loadUrlSim btn" data-id="2">Load</button></div>
      </div>
      <div style="min-width:220px">
        <label>Sim Sprite Slot 4 (file)</label><input class="fileSim" data-id="3" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">Slot 4 URL</label><div style="display:flex;gap:6px"><input class="urlSim" data-id="3" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button class="loadUrlSim btn" data-id="3">Load</button></div>
      </div>
      <div style="min-width:220px">
        <label>Sim Sprite Slot 5 (file)</label><input class="fileSim" data-id="4" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">Slot 5 URL</label><div style="display:flex;gap:6px"><input class="urlSim" data-id="4" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button class="loadUrlSim btn" data-id="4">Load</button></div>
      </div>
      <div style="min-width:220px">
        <label>Sim Sprite Slot 6 (file)</label><input class="fileSim" data-id="5" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">Slot 6 URL</label><div style="display:flex;gap:6px"><input class="urlSim" data-id="5" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button class="loadUrlSim btn" data-id="5">Load</button></div>
      </div>
      <div style="min-width:220px">
        <label>Sim Sprite Slot 7 (file)</label><input class="fileSim" data-id="6" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">Slot 7 URL</label><div style="display:flex;gap:6px"><input class="urlSim" data-id="6" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button class="loadUrlSim btn" data-id="6">Load</button></div>
      </div>
    </div>

    <!-- SUIT SHOP (5 suits) -->
    <div style="height:10px"></div>
    <h3 style="margin:6px 0">Cosmetic Suits (500 sapphires each)</h3>
    <p class="note">Upload a suit image or paste a URL. Buy to unlock with 500 sapphires, then equip it. Suits overlay on top of the player sprite.</p>
    <div id="suitArea"></div>

    <div style="height:8px"></div>
    <div class="row" style="justify-content:space-between;margin-top:12px;align-items:center">
      <div>
        <label style="display:flex;gap:8px;align-items:center"><input id="toggleMusic" type="checkbox" checked> Music</label>
        <label style="display:flex;gap:8px;align-items:center;margin-top:6px"><input id="toggleSfx" type="checkbox" checked> Sound Effects</label>
        <div class="note" style="margin-top:6px">Tip: upload square-ish images or paste URLs. "Remember Me" saves your team, SimDex, coins & settings.</div>
      </div>
    </div>
  </div>
</div>

<!-- SimDex (modal) -->
<div id="dex" class="panel">
  <div class="box" style="max-width:980px">
    <h2 style="margin-top:0">Your SimDex</h2>
    <div id="dexGrid"></div>
    <div style="text-align:center;margin-top:10px"><button id="btnCloseDex" class="btn">Close</button></div>
  </div>
</div>

<!-- Shop (draggable) -->
<div id="shopWin" class="float" style="top:140px;left:120px">
  <div class="titlebar"><b>Shop — Heals & Items</b><button class="closeX" data-close="#shopWin">Close</button></div>
  <div class="content">
    <div id="shopCoins" class="note" style="margin-bottom:10px">Coins: 0</div>
    <div id="healList"></div>

    <div style="height:8px"></div>
    <div style="text-align:center">
      <button id="btnHealAny" class="btn">Heal any Sim (10)</button>
    </div>

    <hr style="margin:12px 0;border-color:#213a2a">

    <!-- SAPPHIRE Shop (real money packs) -->
    <h3 style="margin:6px 0">Sapphire Packs (real money)</h3>
    <p class="note">Click to purchase. These buttons currently simulate an instant purchase — integrate a real payment provider for actual money transactions.</p>
    <div class="row" style="justify-content:center;gap:8px;margin-top:8px">
      <button class="btn" id="buy100">100 sapphires — $0.25</button>
      <button class="btn" id="buy1000">1,000 sapphires — $1</button>
      <button class="btn" id="buy100k">100,000 sapphires — $5</button>
      <button class="btn" id="buy200k">200,000 sapphires — $7</button>
      <button class="btn" id="buy500k">500,000 sapphires — $10</button>
    </div>
  </div>
</div>

<!-- Quests (draggable) -->
<div id="questWin" class="float" style="top:180px;left:160px">
  <div class="titlebar"><b>Quests</b><button class="closeX" data-close="#questWin">Close</button></div>
  <div class="content">
    <div id="questList"></div>
    <div style="height:10px"></div>
    <div id="bossCountdownWrap" style="text-align:center">
      <div id="bossCountdown" class="note">Next Boss: --</div>
    </div>
  </div>
</div>

<!-- Encounter panel -->
<div id="encounterPanel" class="panel">
  <div class="box">
    <h2 id="encounterTitle" style="margin-top:0">Encounter</h2>
    <div class="row" style="justify-content:center">
      <button id="btnFight" class="btn">Battle</button>
      <button id="btnCatchSim" class="btn">Catch (SimNet)</button>
      <button id="btnRun" class="btn danger">Run</button>
    </div>
  </div>
</div>

<!-- Boss encounter panel -->
<div id="bossPanel" class="panel">
  <div class="box">
    <h2 id="bossTitle" style="margin-top:0">World Boss</h2>
    <div id="bossInfo" style="text-align:center;margin-top:6px"></div>
    <div class="row" style="justify-content:center;margin-top:10px">
      <button id="btnBossFight" class="btn">Battle Boss</button>
      <button id="btnBossInspect" class="btn">Inspect</button>
      <button id="btnBossRun" class="btn danger">Leave</button>
    </div>
  </div>
</div>

<!-- Choose Sim for battle -->
<div id="chooseSimPanel" class="panel">
  <div class="box" style="max-width:620px">
    <h2 style="margin-top:0">Choose a Sim to battle</h2>
    <div id="chooseSimList" class="row" style="justify-content:center"></div>
    <div style="text-align:center;margin-top:8px"><button id="btnCancelChoose" class="btn">Cancel</button></div>
  </div>
</div>

<!-- Choose Sim to heal from SimDex -->
<div id="chooseHealPanel" class="panel">
  <div class="box" style="max-width:620px">
    <h2 style="margin-top:0">Choose a Sim to Heal (10 coins)</h2>
    <div id="chooseHealList" class="row" style="justify-content:center;gap:8px;flex-wrap:wrap"></div>
    <div style="text-align:center;margin-top:8px"><button id="btnCancelHeal" class="btn">Cancel</button></div>
  </div>
</div>

<!-- Battle panel -->
<div id="battlePanel" class="panel">
  <div class="box">
    <h2 id="battleTitle" style="margin-top:0">Battle</h2>
    <div class="row" style="justify-content:center;gap:26px">
      <div style="text-align:center">
        <div id="playerLabel" class="label">You</div>
        <div class="hp"><div id="hpYou" class="fill"></div></div>
      </div>
      <div style="text-align:center">
        <div id="enemyLabel" class="label">Enemy</div>
        <div class="hp"><div id="hpEnemy" class="fill"></div></div>
      </div>
    </div>
    <div id="battleButtons" class="row" style="justify-content:center;margin-top:10px"></div>
    <div style="text-align:center;margin-top:10px"><button id="btnRunBattle" class="btn danger">Run</button></div>
  </div>
</div>

<!-- Mini-map -->
<div id="minimapWrap">
  <canvas id="minimap" width="160" height="160"></canvas>
  <button id="btnMini">Hide Mini-Map</button>
</div>

<script>
/* ===========================================================
   Simitaur RPG — Adventure — Updated build with:
    - Boss countdown timer in Quests
    - Boss glow on mini-map (pulse)
    - 5 cosmetic suits (upload + URL + buy for 500 sapphires + equip toggle)
   Preserves original logic and features.
   =========================================================== */

(() => {
  // ----- Canvas & world settings -----
  const cvs = document.getElementById('game'), ctx = cvs.getContext('2d');
  const mini = document.getElementById('minimap'), mctx = mini.getContext('2d');
  const TILE = 64, VIEW_W = 10, VIEW_H = 10;
  // Expanded map
  const MAP_W = 1000, MAP_H = 1000;

  // ----- State -----
  let mode = 'menu'; // menu, world, battle
  const player = {
    x: Math.floor(MAP_W/2), y: Math.floor(MAP_H/2),
    hp:100, maxHp:100, img: null, sims: [], xp:0, name:'', pass:''
  };
  const npc = { x: Math.floor(MAP_W/2) + 3, y: Math.floor(MAP_H/2), img: null, name: 'Charcoal' };
  let netImage = null;

  // Economy / Quests / Sapphires
  let coins = 0;
  let sapphires = 0;
  const quests = [
    { id:'q1', name:'Catch 5 Simitaurs', goal:5, progress:0, reward:25, done:false },
    { id:'q2', name:'Catch 1 Exotic', goal:1, progress:0, reward:50, done:false },
  ];

  // World sims
  let sims = [];            // visible wild sims positions
  let simdex = {};          // caught index {id: {name,rarity,hp,maxHp,size,weight,src}}
  let currentEncounter = null; // sim object
  let battlePlayerSim = null, battleEnemySim = null;

  // Boss object (null when none)
  let worldBoss = null; // {type, x,y, hp, maxHp, attacks, spawnedAt}
  // next spawn timestamp stored in localStorage under 'simitaur_boss_next'

  // Suits (5)
  let suits = [
    { id:0, name:'Suit 1', src:'', img:null, owned:false },
    { id:1, name:'Suit 2', src:'', img:null, owned:false },
    { id:2, name:'Suit 3', src:'', img:null, owned:false },
    { id:3, name:'Suit 4', src:'', img:null, owned:false },
    { id:4, name:'Suit 5', src:'', img:null, owned:false }
  ];
  let equippedSuit = null; // suit id or null

  // Audio toggles
  let musicOn = true, sfxOn = true;

  // Prevent spam: per-battle action lock
  let canPlayerAct = true;

  // ----- Types & rarities (7 types) -----
  const types = [
    { id:0, name:'Frostaur', img:null, src:'images/12E0BB61-32BA-4A5D-95A9-EEC144F9769F.jpg', baseRarityWeights:[60,25,10,3,1,1] },
    { id:1, name:'Rockaur',  img:null, src:'', baseRarityWeights:[40,30,18,8,3,1] },
    { id:2, name:'Leafaur',  img:null, src:'', baseRarityWeights:[30,30,20,12,6,2] },
    { id:3, name:'Stormaur', img:null, src:'', baseRarityWeights:[36,28,20,10,5,1] },
    { id:4, name:'Flametaur',img:null, src:'', baseRarityWeights:[42,30,16,8,3,1] },
    { id:5, name:'Aquataur', img:null, src:'', baseRarityWeights:[34,30,20,10,5,1] },
    { id:6, name:'Shadeaur', img:null, src:'', baseRarityWeights:[50,28,12,6,3,1] } // new 7th type
  ];
  const RARITIES = ['Common','Uncommon','Rare','Legendary','Mythic','Exotic'];

  // ----- Audio (procedural; self-contained) -----
  const AC = window.AudioContext || window.webkitAudioContext;
  const audio = new AC();
  let musicToken = 0;
  function ensureAudio(){ if(audio.state === 'suspended') audio.resume(); }
  function tone(freq, dur=0.12, type='square', vol=0.06){
    if(!sfxOn) return;
    const t0 = audio.currentTime;
    const o = audio.createOscillator(), g = audio.createGain();
    o.type = type; o.frequency.value = freq; g.gain.value = vol;
    o.connect(g); g.connect(audio.destination);
    o.start(t0);
    const a=0.004, r=0.03;
    g.gain.setValueAtTime(0, t0);
    g.gain.linearRampToValueAtTime(vol, t0+a);
    g.gain.linearRampToValueAtTime(0.0001, t0+dur-r);
    o.stop(t0+dur);
  }
  const sfx = {
    step(){ tone(220+Math.random()*20, .06, 'triangle', .04); },
    atk(){ tone(740, .09, 'square', .07); tone(620, .06, 'square', .06); },
    battleStart(){ tone(330,.08,'square',.07); setTimeout(()=>tone(660,.12,'square',.07),80); },
    catch(){ tone(520,.18,'square',.07); setTimeout(()=>tone(880,.12,'square',.06),140); },
    win(){ tone(880,.14,'sawtooth',.08); setTimeout(()=>tone(660,.12,'square',.05),120); },
    escape(){ tone(180,.12,'triangle',.05); },
    coin(){ tone(1400,.08,'triangle',.05); },
    heal(){ tone(520,.06,'sine',.05); setTimeout(()=>tone(620,.06,'sine',.05),70); setTimeout(()=>tone(740,.06,'sine',.05),140); }
  };
  function startMusic(){
    if(!musicOn) return;
    ensureAudio();
    const token = ++musicToken;
    const key = [196,220,247,262,294,330,349,392];
    const tempo = 112;
    const spb = 60/tempo;
    let step = 0;
    (function loop(){
      if(!musicOn || token !== musicToken) return;
      const t0 = audio.currentTime + 0.02;
      scheduleBass([98,98,110,123,98,110,130,147][step%8], t0, spb);
      const chord = [[key[0],key[2],key[4]],[key[1],key[3],key[5]],[key[2],key[4],key[6]],[key[3],key[5],key[7]]][(Math.floor(step/2))%4];
      scheduleArp(chord, t0, spb); schedulePerc(t0+spb*0.5);
      step++; setTimeout(loop, spb*1000*2);
    })();
  }
  function scheduleBass(freq,t0,spb){ const o=audio.createOscillator(), g=audio.createGain(); o.type='square'; o.frequency.value=freq; g.gain.value=0.06; o.connect(g); g.connect(audio.destination); const a=0.005; g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(0.08,t0+a); g.gain.linearRampToValueAtTime(0.03,t0+0.08); g.gain.linearRampToValueAtTime(0.0001,t0+spb*2-0.06); o.start(t0); o.stop(t0+spb*2); }
  function scheduleArp(notes,t0,spb){ [0, spb*0.5, spb*1.0, spb*1.5].forEach((off,i)=>{ const o=audio.createOscillator(), g=audio.createGain(); o.type='triangle'; o.frequency.value = notes[i%notes.length]; g.gain.value=0.05; o.connect(g); g.connect(audio.destination); g.gain.setValueAtTime(0,t0+off); g.gain.linearRampToValueAtTime(0.06,t0+off+0.005); g.gain.linearRampToValueAtTime(0.0001,t0+off+spb*0.45-0.03); o.start(t0+off); o.stop(t0+off+spb*0.5); }); }
  function schedulePerc(t){ const n=audio.createBufferSource(); const len=2200; const buf=audio.createBuffer(1,len,audio.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<len;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/len,2); n.buffer=buf; const g=audio.createGain(); g.gain.value=0.06; n.connect(g); g.connect(audio.destination); n.start(t); }

  // ----- Save / Load -----
  const SAVE_KEY = 'simitaur_save_v5';
  function saveGame(){
    try{
      const store = {
        player:{ name:player.name, pass:player.pass,
          sims: player.sims.map(s=>({typeId:s.type.id,hp:s.hp,maxHp:s.maxHp,attacks:s.attacks,rarity:s.rarity,size:s.size,weight:s.weight})) },
        simdex,
        typesMeta: types.map(t=>({id:t.id,src:t.src||''})),
        npcSrc: npc.img?.src || '',
        playerSrc: player.img?.src || '',
        netSrc: netImage?.src || '',
        coins,
        sapphires,
        quests,
        suits: suits.map(s=>({id:s.id,name:s.name,src:s.src,owned:s.owned})),
        equippedSuit
      };
      localStorage.setItem(SAVE_KEY, JSON.stringify(store));
    }catch(e){ console.warn('save failed', e); }
  }
  function loadGame(){
    try{
      const raw = localStorage.getItem(SAVE_KEY); if(!raw) return false;
      const obj = JSON.parse(raw);
      if(obj.player?.name){
        player.name = obj.player.name; player.pass = obj.player.pass || '';
        player.sims = (obj.player.sims||[]).map(d=>({type: types.find(t=>t.id===d.typeId)||types[0], hp:d.hp, maxHp:d.maxHp, attacks:d.attacks||[{name:'Punch',dmg:10}], rarity:d.rarity, size:d.size, weight:d.weight}));
        simdex = obj.simdex || {};
        (obj.typesMeta||[]).forEach(m=>{ const t = types.find(x=>x.id===m.id); if(t && m.src){ t.src=m.src; const img=new Image(); img.crossOrigin='anonymous'; img.src=m.src; t.img=img; }});
        if(obj.npcSrc){ npc.img=new Image(); npc.img.crossOrigin='anonymous'; npc.img.src=obj.npcSrc; }
        if(obj.playerSrc){ player.img=new Image(); player.img.crossOrigin='anonymous'; player.img.src=obj.playerSrc; }
        if(obj.netSrc){ netImage=new Image(); netImage.crossOrigin='anonymous'; netImage.src=obj.netSrc; }
        coins = obj.coins ?? 0;
        sapphires = obj.sapphires ?? 0;
        if(Array.isArray(obj.quests)) obj.quests.forEach(q=>{ const loc=quests.find(x=>x.id===q.id); if(loc) Object.assign(loc,q); });
        if(Array.isArray(obj.suits)){
          obj.suits.forEach(s=>{
            const target = suits.find(x=>x.id===s.id);
            if(target){ target.src = s.src || target.src; target.name = s.name || target.name; target.owned = !!s.owned; if(target.src){ const im=new Image(); im.crossOrigin='anonymous'; im.src = target.src; target.img = im; } }
          });
        }
        if(typeof obj.equippedSuit !== 'undefined'){ equippedSuit = obj.equippedSuit; }
        return true;
      }
    }catch(e){ console.warn('load fail', e); return false; }
    return false;
  }
  if(loadGame()){
    document.getElementById('playerName').value = player.name;
    document.getElementById('menu-main').style.display = 'flex';
    document.getElementById('signin-area').style.display = 'none';
  }

  // ----- Utility -----
  function weightedRarity(weights){ const sum=weights.reduce((a,b)=>a+b,0); let r=Math.random()*sum; for(let i=0;i<weights.length;i++){ if(r<weights[i]) return i; r-=weights[i]; } return weights.length-1; }

  // Spawn sims count - sparse relative to large map:
  function spawnSims(){
    sims = [];
    // density control: fewer sims per map tile area to keep sparse
    const count = Math.max(250, Math.floor((MAP_W * MAP_H) / 2000)); // e.g. 1000k/2000 = 500
    for(let i=0;i<count;i++){
      let tries = 0;
      while(true){
        tries++;
        let x=Math.floor(Math.random()*MAP_W), y=Math.floor(Math.random()*MAP_H);
        if((x===player.x&&y===player.y)||(x===npc.x&&y===npc.y)) { if(tries>10) break; continue; }
        // ok spawn
        const t = types[Math.floor(Math.random()*types.length)];
        const idx = weightedRarity(t.baseRarityWeights.slice());
        const rarity = RARITIES[idx];
        const hp = 24 + Math.floor(Math.random()*60);
        const size = 1 + Math.floor(Math.random()*3);
        const weight = 1 + Math.floor(Math.random()*5);
        const attacksPool = [{name:'Tackle',dmg:6+Math.floor(Math.random()*8)},{name:'Bite',dmg:6+Math.floor(Math.random()*10)},{name:'Swipe',dmg:7+Math.floor(Math.random()*9)},{name:'Headbutt',dmg:8+Math.floor(Math.random()*8)}];
        const attacks = [attacksPool[Math.floor(Math.random()*attacksPool.length)], attacksPool[Math.floor(Math.random()*attacksPool.length)]];
        sims.push({x,y,type:t,hp,maxHp:hp,attacks,rarity,size,weight});
        break;
      }
    }
  }
  spawnSims();

  // ----- Camera -----
  let camX = player.x, camY = player.y;

  // ----- Drawing -----
  let sparklePhase = 0;
  function draw(){
    // Smooth camera that eases toward the player but keeps them visually centered.
    // We ease the camera toward the player's coordinates, then snap if the difference
    // becomes negligibly small to avoid perpetual tiny offsets.
    const ease = 0.18;                      // smoothing factor (0 = no move, 1 = instant)
    const dx = player.x - camX;
    const dy = player.y - camY;
    camX += dx * ease;
    camY += dy * ease;
    // Snap if extremely close to avoid tiny persistent offsets
    if (Math.abs(dx) < 0.002) camX = player.x;
    if (Math.abs(dy) < 0.002) camY = player.y;
    const worldLeft = Math.floor(camX - VIEW_W/2);
    const worldTop  = Math.floor(camY - VIEW_H/2);
    ctx.clearRect(0,0,cvs.width,cvs.height);
    // tiles
    for(let ty=0; ty<VIEW_H; ty++){
      for(let tx=0; tx<VIEW_W; tx++){
        const gx = worldLeft + tx, gy = worldTop + ty;
        ctx.fillStyle = ((gx+gy)&1) ? '#7cc57a' : '#67b86a';
        const px = (gx - camX + VIEW_W/2) * TILE;
        const py = (gy - camY + VIEW_H/2) * TILE;
        ctx.fillRect(px, py, TILE, TILE);
        // flowers removed entirely (no flora/animation)
      }
    }
    // NPC
    const nx = npc.x - camX + VIEW_W/2, ny = npc.y - camY + VIEW_W/2;
    if(nx>-1 && nx<VIEW_W+1 && ny>-1 && ny<VIEW_H+1){
      const sx = nx*TILE, sy = ny*TILE;
      if(npc.img) ctx.drawImage(npc.img, sx, sy, TILE, TILE); else { ctx.fillStyle='#f4a261'; ctx.fillRect(sx, sy, TILE, TILE); }
      ctx.fillStyle='rgba(0,0,0,0.45)'; ctx.fillRect(sx, sy-18, TILE, 18);
      ctx.fillStyle='#ffd166'; ctx.font='12px monospace'; ctx.fillText(npc.name, sx+6, sy-6);
    }
    // boss (draw separately so it's prominent)
    if(worldBoss){
      const sxB = worldBoss.x - camX + VIEW_W/2, syB = worldBoss.y - camY + VIEW_H/2;
      if(sxB>=-1 && sxB<VIEW_W+1 && syB>=-1 && syB<VIEW_H+1){
        const dx = sxB*TILE, dy = syB*TILE;
        // boss visual (big)
        ctx.fillStyle = '#5eead4'; ctx.fillRect(dx, dy, TILE, TILE);
        ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fillRect(dx, dy-18, TILE, 18);
        ctx.fillStyle='#052b27'; ctx.font='12px monospace'; ctx.fillText('WORLD BOSS', dx+6, dy-6);
      }
    }
    // sims
    sims.forEach(s=>{
      const sx = s.x - camX + VIEW_W/2, sy = s.y - camY + VIEW_W/2;
      if(sx>=-1 && sx<VIEW_W+1 && sy>=-1 && sy<VIEW_H+1){
        const dx = sx*TILE, dy=sy*TILE;
        if(s.type.img) ctx.drawImage(s.type.img, dx, dy, TILE, TILE);
        else {
          const cols=['#ff595e','#8ac926','#1982c4','#ffd166','#6c5ce7','#00cec9','#b392ff']; ctx.fillStyle=cols[s.type.id%cols.length]; ctx.fillRect(dx,dy,TILE,TILE);
        }
        drawRarityFX(s, sx, sy);
      }
    });
    // player
    const px = (player.x - camX + VIEW_W/2)*TILE, py = (player.y - camY + VIEW_W/2)*TILE;
    if(player.img) ctx.drawImage(player.img, px, py, TILE, TILE); else { ctx.fillStyle='#1d3557'; ctx.fillRect(px, py, TILE, TILE); }
    // suit overlay (if equipped & loaded)
    if(equippedSuit !== null && suits[equippedSuit] && suits[equippedSuit].img){
      try{
        ctx.drawImage(suits[equippedSuit].img, px, py, TILE, TILE);
      }catch(e){ /* ignore if image not ready */ }
    }
    sparklePhase += 0.08;
  }
  function drawRarityFX(s, sx, sy){
    const x=sx*TILE, y=sy*TILE; ctx.save();
    const p=sparklePhase + s.x*0.5 + s.y*0.3;
    const sparkle=(color,count=2)=>{ for(let i=0;i<count;i++){ const ox=Math.floor((Math.sin(p*3+i*1.7)*0.5+0.5)*(TILE-18))+8; const oy=Math.floor((Math.cos(p*2+i*2.3)*0.5+0.5)*(TILE-18))+8; ctx.fillStyle=color; ctx.globalAlpha=0.6+0.4*Math.sin(p*4+i); ctx.fillRect(x+ox,y+oy,5,5);} ctx.globalAlpha=1; };
    switch(s.rarity){
      case 'Common': sparkle('#53a9ff',2); ctx.strokeStyle='rgba(120,180,255,0.35)'; ctx.lineWidth=2; ctx.strokeRect(x+3,y+3,TILE-6,TILE-6); break;
      case 'Uncommon': sparkle('#a0a7ad',3); ctx.strokeStyle='#a0a7ad'; ctx.lineWidth=2; ctx.strokeRect(x+3,y+3,TILE-6,TILE-6); break;
      case 'Rare': sparkle('#a56cff',3); ctx.strokeStyle='#a56cff'; ctx.lineWidth=3; ctx.strokeRect(x+2,y+2,TILE-4,TILE-4); break;
      case 'Legendary': sparkle('#ffd166',3); ctx.strokeStyle=`rgba(255,215,0,${0.4 + Math.abs(Math.sin(p))*0.5})`; ctx.lineWidth=3; ctx.strokeRect(x+2,y+2,TILE-4,TILE-4); break;
      case 'Mythic': sparkle('#66ccff',2); sparkle('#b388ff',2); ctx.strokeStyle='rebeccapurple'; ctx.lineWidth=3; ctx.strokeRect(x+2,y+2,TILE-4,TILE-4); break;
      case 'Exotic': const colors=['#ff0000','#ff7f00','#ffff00','#00ff00','#0000ff','#4b0082','#8f00ff']; const c=colors[Math.floor((p*10)%colors.length)]; sparkle(c,4); ctx.strokeStyle=c; ctx.lineWidth=4; ctx.strokeRect(x+2,y+2,TILE-4,TILE-4); break;
    }
    ctx.restore();
  }

  // ----- Movement and input -----
  function move(dx,dy){
    if(mode === 'battle') return;
    ensureAudio();
    const nx = Math.max(0, Math.min(MAP_W-1, player.x + dx));
    const ny = Math.max(0, Math.min(MAP_H-1, player.y + dy));
    if(nx === player.x && ny === player.y) return;
    player.x = nx; player.y = ny;
    sfx.step();
    checkTileInteraction();
    draw(); drawMini();
  }
  function wirePad(id,dx,dy){
    const el = document.getElementById(id);
    let intv;
    const down = (e)=>{ e?.preventDefault(); move(dx,dy); intv=setInterval(()=>move(dx,dy), 160); };
    const up = ()=>{ clearInterval(intv); };
    el.addEventListener('mousedown', down); el.addEventListener('touchstart', down, {passive:false});
    el.addEventListener('mouseup', up); el.addEventListener('touchend', up);
    el.addEventListener('mouseleave', up); el.addEventListener('click', e=>e.preventDefault());
  }
  wirePad('padUp',0,-1); wirePad('padDown',0,1); wirePad('padLeft',-1,0); wirePad('padRight',1,0);
  window.addEventListener('keydown', e=>{ const k=e.key.toLowerCase(); if(k==='arrowup'||k==='w') move(0,-1); if(k==='arrowdown'||k==='s') move(0,1); if(k==='arrowleft'||k==='a') move(-1,0); if(k==='arrowright'||k==='d') move(1,0); });

  // ----- UI wiring: sign in, menu, settings, windows -----
  function panel(id, show){ document.querySelectorAll('.panel').forEach(p=>p.classList.remove('show')); if(show) document.getElementById(id).classList.add('show'); }
  function wire(id, fn){ const el=document.getElementById(id); el.addEventListener('click', fn); el.addEventListener('touchstart', e=>{ e.preventDefault(); fn(); }, {passive:false}); }
  function showWin(sel){ document.querySelector(sel).classList.add('show'); }
  function hideWin(sel){ document.querySelector(sel).classList.remove('show'); }
  document.querySelectorAll('.closeX').forEach(btn=>btn.addEventListener('click', ()=>{ hideWin(btn.dataset.close); }));

  wire('btnSignIn', ()=>{ const n=document.getElementById('playerName').value.trim(); const p=document.getElementById('playerPass').value; if(!n||!p) return alert('Enter name and password'); player.name=n; player.pass=p; if(document.getElementById('rememberMe').checked) saveGame(); document.getElementById('signin-area').style.display='none'; document.getElementById('menu-main').style.display='flex'; });
  wire('btnGuest', ()=>{ player.name='Guest'; document.getElementById('signin-area').style.display='none'; document.getElementById('menu-main').style.display='flex'; });
  wire('btnStart', ()=>{ mode='world'; document.getElementById('menu').style.display='none'; // Force hide menu
  panel('menu', false); document.getElementById('hud').style.display='flex'; document.getElementById('dpad').style.display = isTouch() ? 'grid' : 'none'; draw(); drawMini(); if(musicOn) startMusic(); updateCoinsUI(); buildShop(); buildQuests(); checkBossSpawnOnLoad(); startBossCountdownTimer(); buildSuitUI(); });
  wire('btnOpenSettings', ()=>showWin('#settingsWin'));
  wire('btnSettings', ()=>showWin('#settingsWin'));
  wire('btnDex', ()=>{ buildDex(); panel('dex', true); });
  wire('btnOpenDexPanel', ()=>{ buildDex(); panel('dex', true); });
  wire('btnCloseDex', ()=>panel('dex', false));
  wire('btnShop', ()=>{ buildShop(); showWin('#shopWin'); });
  wire('btnQuests', ()=>{ buildQuests(); showWin('#questWin'); });
  wire('btnMusic', ()=>{ musicOn=!musicOn; document.getElementById('btnMusic').textContent='Music: '+(musicOn?'On':'Off'); document.getElementById('toggleMusic').checked=musicOn; if(musicOn) startMusic(); else musicToken++; });

  wire('btnSignOut', ()=>{ localStorage.removeItem(SAVE_KEY); localStorage.removeItem('simitaur_boss_next'); location.reload(); });

  // ----- Uploads & URL loaders -----
  function loadImgFromInput(el, cb){ const f=el.files?.[0]; if(!f) return; const url=URL.createObjectURL(f); const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ cb(img,url); draw(); drawMini(); }; img.src=url; }
  function loadImgFromURL(url, cb){
    if(!url) return alert('Enter a URL');
    const img = new Image(); img.crossOrigin='anonymous';
    img.onload = ()=>{ cb(img,url); draw(); drawMini(); };
    img.onerror = ()=> alert('Failed to load image from URL.');
    img.src = url;
  }

  // File inputs
  document.getElementById('filePlayer').addEventListener('change', e=> loadImgFromInput(e.target,(img,url)=>{ player.img=img; if(document.getElementById('rememberMe').checked) saveGame(); }));
  document.getElementById('fileNPC').addEventListener('change', e=> loadImgFromInput(e.target,(img,url)=>{ npc.img=img; if(document.getElementById('rememberMe').checked) saveGame(); }));
  document.getElementById('fileNet').addEventListener('change', e=> loadImgFromInput(e.target,(img,url)=>{ netImage=img; if(document.getElementById('rememberMe').checked) saveGame(); }));
  document.querySelectorAll('.fileSim').forEach(inp=>{ inp.addEventListener('change', e=>{ const id=Number(inp.dataset.id); loadImgFromInput(e.target,(img,url)=>{ types[id].img=img; types[id].src=url; if(document.getElementById('rememberMe').checked) saveGame(); }); }); });

  // URL load buttons
  document.getElementById('loadUrlPlayer').addEventListener('click', ()=> loadImgFromURL(document.getElementById('urlPlayer').value.trim(), (img,url)=>{ player.img=img; if(document.getElementById('rememberMe').checked) saveGame(); }));
  document.getElementById('loadUrlNPC').addEventListener('click', ()=> loadImgFromURL(document.getElementById('urlNPC').value.trim(), (img,url)=>{ npc.img=img; if(document.getElementById('rememberMe').checked) saveGame(); }));
  document.getElementById('loadUrlNet').addEventListener('click', ()=> loadImgFromURL(document.getElementById('urlNet').value.trim(), (img,url)=>{ netImage=img; if(document.getElementById('rememberMe').checked) saveGame(); }));

  document.querySelectorAll('.loadUrlSim').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = Number(btn.dataset.id);
      const inp = document.querySelector('.urlSim[data-id="'+id+'"]');
      if(!inp) return;
      loadImgFromURL(inp.value.trim(), (img,url)=>{ types[id].img=img; types[id].src=url; if(document.getElementById('rememberMe').checked) saveGame(); });
    });
  });

  document.getElementById('toggleMusic').addEventListener('change', e=>{ musicOn=e.target.checked; document.getElementById('btnMusic').textContent='Music: '+(musicOn?'On':'Off'); if(musicOn) startMusic(); else musicToken++; });
  document.getElementById('toggleSfx').addEventListener('change', e=> sfxOn=e.target.checked);

  // ----- SUIT UI BUILD & HANDLERS -----
  function buildSuitUI(){
    const container = document.getElementById('suitArea'); container.innerHTML = '';
    suits.forEach(s=>{
      const slot = document.createElement('div'); slot.className='suitSlot';
      const thumb = document.createElement('div'); thumb.style.width='48px'; thumb.style.height='48px'; thumb.style.borderRadius='6px'; thumb.style.background='#0b150e'; thumb.style.display='flex'; thumb.style.alignItems='center'; thumb.style.justifyContent='center';
      if(s.img) { const im=document.createElement('img'); im.src=s.src; im.width=48; im.height=48; im.style.borderRadius='6px'; thumb.innerHTML=''; thumb.appendChild(im); } else { thumb.textContent = s.name; thumb.style.fontSize='11px'; }
      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<div class="name">${s.name}</div><div class="owned">${s.owned ? 'Unlocked' : 'Locked — 500 sapphires'}</div>`;
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.flexDirection='column'; actions.style.gap='6px';
      // file, url, buy/equip
      const fileIn = document.createElement('input'); fileIn.type='file'; fileIn.accept='image/*'; fileIn.style.display='block';
      fileIn.addEventListener('change', ev=>{ const f=ev.target.files?.[0]; if(!f) return; const url=URL.createObjectURL(f); const im=new Image(); im.crossOrigin='anonymous'; im.onload=()=>{ s.img = im; s.src = url; meta.querySelector('.owned').textContent = s.owned ? 'Unlocked' : 'Locked — 500 sapphires'; buildSuitUI(); maybeSave(); }; im.src = url; });
      const urlBox = document.createElement('div'); urlBox.style.display='flex'; urlBox.style.gap='6px';
      const urlIn = document.createElement('input'); urlIn.placeholder='Suit URL'; urlIn.style.flex='1'; urlIn.style.padding='6px'; urlIn.style.borderRadius='6px'; urlIn.style.background='#0f1b13'; urlIn.style.border='1px solid #274f34'; urlIn.style.color='#eafff0';
      const loadBtn = document.createElement('button'); loadBtn.className='btn'; loadBtn.textContent='Load';
      loadBtn.addEventListener('click', ()=>{ if(!urlIn.value) return alert('Enter URL'); const im=new Image(); im.crossOrigin='anonymous'; im.onload=()=>{ s.img=im; s.src=urlIn.value; meta.querySelector('.owned').textContent = s.owned ? 'Unlocked' : 'Locked — 500 sapphires'; buildSuitUI(); maybeSave(); }; im.onerror=()=>alert('Failed to load suit URL'); im.src=urlIn.value; });
      urlBox.appendChild(urlIn); urlBox.appendChild(loadBtn);
      const buyEquipBtn = document.createElement('button'); buyEquipBtn.className='btn'; buyEquipBtn.style.minWidth='110px';
      function updateBuyEquip(){
        if(s.owned){
          if(equippedSuit === s.id) buyEquipBtn.textContent='Unequip';
          else buyEquipBtn.textContent='Equip';
        } else {
          buyEquipBtn.textContent = 'Buy (500)';
        }
      }
      buyEquipBtn.addEventListener('click', ()=>{
        if(!s.owned){
          if(sapphires < 500) return alert('Not enough sapphires!'); if(!confirm(`Spend 500 sapphires to unlock ${s.name}?`)) return;
          sapphires -= 500; s.owned = true; updateCoinsUI(); maybeSave(); buildSuitUI(); alert(`${s.name} unlocked!`);
        } else {
          if(equippedSuit === s.id){ equippedSuit = null; alert(`${s.name} unequipped.`); }
          else { equippedSuit = s.id; alert(`${s.name} equipped.`); }
          updateCoinsUI(); maybeSave(); buildSuitUI();
        }
      });
      updateBuyEquip();
      actions.appendChild(fileIn);
      actions.appendChild(urlBox);
      actions.appendChild(buyEquipBtn);
      slot.appendChild(thumb);
      slot.appendChild(meta);
      slot.appendChild(actions);
      container.appendChild(slot);
    });
  }

  // ----- SimDex -----
  function buildDex(){
    const grid=document.getElementById('dexGrid'); grid.innerHTML='';
    const keys=Object.keys(simdex);
    if(!keys.length){ grid.innerHTML='<p style="opacity:.8">No Simitaurs caught yet.</p>'; return; }
    keys.forEach(k=>{
      const d=simdex[k];
      const el=document.createElement('div'); el.className='dexCard rarity-'+(d.rarity||'Common');
      const img=document.createElement('div'); img.style.width='64px'; img.style.height='64px'; img.style.borderRadius='8px';
      img.style.background = '#203425'; img.style.display='flex'; img.style.alignItems='center'; img.style.justifyContent='center'; img.style.fontSize='12px';
      if(d.src){ const im=document.createElement('img'); im.src=d.src; im.style.width='64px'; im.style.height='64px'; im.style.objectFit='cover'; im.style.borderRadius='8px'; img.innerHTML=''; img.appendChild(im); } else { img.textContent = d.name[0] || '?'; }
      const info=document.createElement('div');
      info.innerHTML=`<b>${d.name}</b><br>Rarity: ${d.rarity}<br>HP: ${d.hp}/${d.maxHp}`;
      el.appendChild(img); el.appendChild(info);
      el.addEventListener('click', ()=> alert(`${d.name}\nRarity: ${d.rarity}\nHP: ${d.hp}/${d.maxHp}\nSize: ${d.size}\nWeight: ${d.weight}`));
      grid.appendChild(el);
    });
  }

  // ----- Encounters -----
  function checkTileInteraction(){
    // first: boss tile
    if(worldBoss && player.x === worldBoss.x && player.y === worldBoss.y){
      panel('bossPanel', true);
      document.getElementById('bossTitle').textContent = `World Boss — ${worldBoss.type.name}`;
      document.getElementById('bossInfo').innerHTML = `HP: ${worldBoss.hp}/${worldBoss.maxHp}`;
      return;
    }
    const wild = sims.find(s=> s.x===player.x && s.y===player.y);
    if(wild){
      currentEncounter = wild;
      panel('encounterPanel', true);
      document.getElementById('encounterTitle').textContent = `A wild ${wild.type.name} (${wild.rarity}) appears!`;
      return;
    }
    currentEncounter = null;
  }
  wire('btnRun', ()=>{ currentEncounter=null; panel('encounterPanel', false); sfx.escape(); });

  // boss buttons
  wire('btnBossRun', ()=>{ panel('bossPanel', false); sfx.escape(); });
  wire('btnBossInspect', ()=>{ if(!worldBoss) return alert('No boss present.'); alert(`${worldBoss.type.name}\nHP: ${worldBoss.hp}/${worldBoss.maxHp}\nWeakness: Exotic sims deal more damage.`); });
  wire('btnBossFight', ()=>{ panel('bossPanel', false); openChooseSim((chosen)=>{ if(!chosen) return; // start boss battle with chosen sim
    battlePlayerSim = chosen;
    const bossEnemy = { type: worldBoss.type, hp: worldBoss.hp, maxHp: worldBoss.maxHp, attacks: worldBoss.attacks, isBoss:true };
    startBattleWithChosen(battlePlayerSim, bossEnemy, true);
  }); });

  // Fight: pick sim -> battle (non-boss)
  wire('btnFight', ()=>{
    panel('encounterPanel', false);
    openChooseSim((chosen)=>{
      if(!chosen){ currentEncounter=null; return; }
      battlePlayerSim = chosen;
      const e = currentEncounter || randomNpcSim();
      startBattleWithChosen(battlePlayerSim, e, false);
    });
  });

  // Catch button
  wire('btnCatchSim', ()=>{ if(currentEncounter) runCatchSequence(currentEncounter); });

  function randomNpcSim(){
    const t=types[Math.floor(Math.random()*types.length)];
    const hp=40+Math.floor(Math.random()*60);
    const attacks=[{name:'Smash',dmg:8+Math.floor(Math.random()*6)},{name:'Roar',dmg:10+Math.floor(Math.random()*6)}];
    return { type:t, hp, maxHp:hp, attacks, rarity:'Rare', size:2, weight:3, x:player.x, y:player.y };
  }

  // Capture odds
  function captureChanceByRarity(r){
    switch(r){
      case 'Common': return 78;
      case 'Uncommon': return 58;
      case 'Rare': return 38;
      case 'Legendary': return 20;
      case 'Mythic': return 12;
      case 'Exotic': return 6;
      default: return 50;
    }
  }

  // Replacement spawn (spawn another of same type elsewhere)
  function spawnReplacement(typeObj){
    let tries = 0;
    while(tries < 50){
      tries++;
      const x = Math.floor(Math.random()*MAP_W);
      const y = Math.floor(Math.random()*MAP_H);
      if((x===player.x&&y===player.y)||(x===npc.x&&y===npc.y)) continue;
      const idx = weightedRarity(typeObj.baseRarityWeights.slice());
      const rarity = RARITIES[idx];
      const hp = 24 + Math.floor(Math.random()*60);
      const size = 1 + Math.floor(Math.random()*3);
      const weight = 1 + Math.floor(Math.random()*5);
      const attacksPool = [{name:'Tackle',dmg:6+Math.floor(Math.random()*8)},{name:'Bite',dmg:6+Math.floor(Math.random()*10)},{name:'Swipe',dmg:7+Math.floor(Math.random()*9)},{name:'Headbutt',dmg:8+Math.floor(Math.random()*8)}];
      const attacks = [attacksPool[Math.floor(Math.random()*attacksPool.length)], attacksPool[Math.floor(Math.random()*attacksPool.length)]];
      sims.push({x,y,type:typeObj,hp,maxHp:hp,attacks,rarity,size,weight});
      return;
    }
    // fallback: spawn random
    if(tries>=50){
      const t = types[Math.floor(Math.random()*types.length)];
      const x = Math.floor(Math.random()*MAP_W);
      const y = Math.floor(Math.random()*MAP_H);
      sims.push({x,y,type:t,hp:40,maxHp:40,attacks:[{name:'Tackle',dmg:6}],rarity:'Common',size:1,weight:1});
    }
  }

  // Catch sequence with swoop
  function runCatchSequence(sim){
    panel('encounterPanel', false);
    const dur = 900; const start = performance.now();
    const cx = cvs.width/2, cy = cvs.height/2;
    function anim(now){
      const t=Math.min(1,(now-start)/dur);
      draw();
      ctx.save(); ctx.globalAlpha=0.9;
      const nx=lerp(-120,cx,easeOutQuad(t)), ny=lerp(-120,cy-40,easeInOutCubic(t));
      const scale=0.6+1.3*t;
      if(netImage){ ctx.drawImage(netImage, nx-48*scale, ny-48*scale, 96*scale, 96*scale); }
      else { ctx.strokeStyle='#fff'; ctx.lineWidth=4; ctx.beginPath(); ctx.ellipse(nx, ny, 36*scale, 22*scale, Math.PI*0.1, 0, Math.PI*2); ctx.stroke(); }
      ctx.restore();
      if(t<1) requestAnimationFrame(anim); else finishCatch();
    }
    requestAnimationFrame(anim);

    function finishCatch(){
      sfx.catch();
      const chance = captureChanceByRarity(sim.rarity);
      if(Math.random()*100 < chance){
        const id = sim.type.name + '-' + Date.now();
        simdex[id] = { name: sim.type.name, rarity: sim.rarity, hp: sim.hp, maxHp: sim.maxHp, size: sim.size, weight: sim.weight, src: sim.type.src || '' };
        const idx = sims.indexOf(sim); if(idx>=0) sims.splice(idx,1);
        player.sims.push({ type: sim.type, hp: sim.hp, maxHp: sim.maxHp, attacks: sim.attacks, rarity: sim.rarity, size: sim.size, weight: sim.weight });
        awardCoins(sim.rarity==='Exotic'?50:5);
        progressQuest('q1',1);
        if(sim.rarity==='Exotic') progressQuest('q2',1);
        maybeSave();
        buildDex(); buildShop(); buildQuests(); drawMini();
        alert(`Caught ${sim.type.name} (${sim.rarity})!`);
        // spawn replacement of same type
        spawnReplacement(sim.type);
      } else {
        alert(`${sim.type.name} escaped!`);
      }
      currentEncounter = null;
    }
  }

  // Battle system: now supports boss battles (isBoss flag)
  function startBattleWithChosen(playerSim, enemySource, isBoss){
    // enemySource: {type, hp, maxHp, attacks, ...}
    battleEnemySim = { ...enemySource, hp: enemySource.hp, maxHp: enemySource.maxHp, attacks: (enemySource.attacks||[]).slice() };
    if(!playerSim){
      if(player.sims.length === 0){
        player.sims.push({ type: types[0], hp:40, maxHp:40, attacks:[{name:'Punch',dmg:10}], rarity:'Common', size:1, weight:1 });
      }
      playerSim = player.sims[0];
    }
    battlePlayerSim = playerSim;
    panel('battlePanel', true);
    populateBattleUI(isBoss);
    mode='battle';
    canPlayerAct = true;
    sfx.battleStart();
  }
  function populateBattleUI(isBoss){
    document.getElementById('battleTitle').textContent = `Battle vs ${battleEnemySim.type ? battleEnemySim.type.name : 'Enemy'}`;
    document.getElementById('playerLabel').textContent = player.name || 'You';
    document.getElementById('enemyLabel').textContent = battleEnemySim.type ? battleEnemySim.type.name : 'Enemy';
    updateHPbars();
    const div=document.getElementById('battleButtons'); div.innerHTML='';
    // create attack buttons but enforce single-click per-turn via canPlayerAct
    (battlePlayerSim.attacks || []).forEach(a=>{
      const b=document.createElement('button'); b.className='btn'; b.textContent=a.name;
      b.addEventListener('click', ()=> {
        if(!canPlayerAct) return; // lock
        canPlayerAct = false;
        playerUseAttack(a, isBoss);
      });
      b.addEventListener('touchstart', e=>{ e.preventDefault(); if(!canPlayerAct) return; canPlayerAct=false; playerUseAttack(a, isBoss); }, {passive:false});
      div.appendChild(b);
    });
    document.getElementById('btnRunBattle').onclick = ()=>{ panel('battlePanel', false); mode='world'; battleEnemySim=null; battlePlayerSim=null; sfx.escape(); };
  }
  function updateHPbars(){ if(battlePlayerSim) document.getElementById('hpYou').style.width=Math.max(0,(battlePlayerSim.hp/battlePlayerSim.maxHp*100))+'%'; if(battleEnemySim) document.getElementById('hpEnemy').style.width=Math.max(0,(battleEnemySim.hp/battleEnemySim.maxHp*100))+'%'; }
  function playerUseAttack(a, isBoss){
    if(!battleEnemySim || !battlePlayerSim) { canPlayerAct = true; return; }
    ensureAudio(); sfx.atk();
    let base=a.dmg || (8+Math.floor(Math.random()*6));
    let dmg=Math.max(1, base + Math.floor((Math.random()-0.5)*4));
    // if boss and player sim is Exotic, extra damage
    if(isBoss && battlePlayerSim.rarity === 'Exotic'){
      dmg = Math.round(dmg * 1.4); // 40% extra
    }
    // apply damage
    battleEnemySim.hp=Math.max(0,battleEnemySim.hp-dmg);
    updateHPbars();
    if(battleEnemySim.hp<=0){ setTimeout(()=>{ sfx.win(); onBattleWin(isBoss); }, 260); return; }
    // enemy turn after small delay; keep canPlayerAct false until enemy turn finishes
    setTimeout(()=> enemyTurn(isBoss), 400);
  }
  function enemyTurn(isBoss){
    if(!battleEnemySim || !battlePlayerSim) { canPlayerAct = true; return; }
    const atk=(battleEnemySim.attacks && battleEnemySim.attacks.length)? battleEnemySim.attacks[Math.floor(Math.random()*battleEnemySim.attacks.length)] : {name:'Tackle',dmg:6};
    ensureAudio(); sfx.atk();
    const dmg=Math.max(1, atk.dmg + Math.floor((Math.random()-0.5)*4));
    battlePlayerSim.hp=Math.max(0,battlePlayerSim.hp-dmg); updateHPbars();
    if(battlePlayerSim.hp<=0){ setTimeout(()=> onBattleLose(), 260); return; }
    // end enemy turn -> allow player to act
    canPlayerAct = true;
  }
  function onBattleWin(isBoss){
    panel('battlePanel', false);
    if(isBoss){
      // finalize boss defeat: award sapphires, remove boss and set next spawn
      awardSapphires(2);
      alert(`You defeated the World Boss! You received 2 sapphires.`);
      // set next boss spawn 24 hours from now
      const next = Date.now() + 24*60*60*1000;
      localStorage.setItem('simitaur_boss_next', String(next));
      worldBoss = null;
      maybeSave();
      buildShop();
      drawMini();
    } else if(currentEncounter){
      // claim sim (auto-catch on win)
      const s=currentEncounter;
      simdex[s.type.name + '-' + Date.now()] = { name:s.type.name, rarity:s.rarity, hp:s.hp, maxHp:s.maxHp, size:s.size, weight:s.weight, src:s.type.src||'' };
      const idx=sims.indexOf(s); if(idx>=0) sims.splice(idx,1);
      player.sims.push({ type:s.type, hp:s.hp, maxHp:s.maxHp, attacks:s.attacks, rarity:s.rarity, size:s.size, weight:s.weight });
      awardCoins(s.rarity==='Exotic'?50:5);
      progressQuest('q1',1); if(s.rarity==='Exotic') progressQuest('q2',1);
      maybeSave();
      buildDex(); buildShop(); buildQuests(); drawMini();
      alert(`Victory! Claimed ${s.type.name} and added to SimDex + team.`);
      // spawn replacement
      spawnReplacement(s.type);
      currentEncounter=null;
    } else {
      alert('You won! (NPC spar)');
    }
    battleEnemySim=null; battlePlayerSim=null; mode='world';
    canPlayerAct = true;
  }
  function onBattleLose(){
    panel('battlePanel', false);
    alert('You lost. Your Sim recovers to half HP.');
    if(player.sims[0]) player.sims[0].hp=Math.max(1, Math.floor(player.sims[0].maxHp*0.5));
    battleEnemySim=null; battlePlayerSim=null; mode='world';
    canPlayerAct = true;
  }

  // Choose sim for battle
  function openChooseSim(cb){
    const list=document.getElementById('chooseSimList'); list.innerHTML='';
    if(player.sims.length===0){ alert('No sims in your team!'); cb(null); return; }
    player.sims.forEach((s,i)=>{ const el=document.createElement('button'); el.className='btn'; el.textContent=`${s.type.name} (HP:${s.hp}/${s.maxHp})`; el.addEventListener('click', ()=>{ document.getElementById('chooseSimPanel').classList.remove('show'); cb(s); }); list.appendChild(el); });
    document.getElementById('btnCancelChoose').onclick=()=>{ document.getElementById('chooseSimPanel').classList.remove('show'); cb(null); };
    panel('chooseSimPanel', true);
  }

  // ----- Coins + sapphires + animations -----
  function updateCoinsUI(){ document.getElementById('coinLabel').textContent = coins; document.getElementById('shopCoins').textContent = 'Coins: '+coins; document.getElementById('sapphireLabel').textContent = sapphires; }
  function awardCoins(n){
    coins += n; updateCoinsUI(); sfx.coin();
    const cg=document.getElementById('coinGain'); cg.textContent = (n>0?'+':'') + n; cg.style.opacity='1'; cg.style.transform='translateY(0)'; cg.getBoundingClientRect(); cg.style.transform='translateY(-20px)'; cg.style.opacity='0';
  }
  function awardSapphires(n){
    sapphires += n; updateCoinsUI();
    // visual feedback
    const el = document.getElementById('sapphireLabel');
    el.animate([{transform:'scale(1)'},{transform:'scale(1.16)'},{transform:'scale(1)'}],{duration:360});
    maybeSave();
  }

  // ----- Quests -----
  function progressQuest(id, amt){
    const q=quests.find(x=>x.id===id); if(!q || q.done) return;
    q.progress = Math.min(q.goal, q.progress + amt);
    if(q.progress>=q.goal && !q.done){ q.done=true; awardCoins(q.reward); }
  }
  function buildQuests(){
    const ql=document.getElementById('questList'); ql.innerHTML='';
    quests.forEach(q=>{
      const row=document.createElement('div'); row.className='healRow';
      const left=document.createElement('div'); left.innerHTML=`<b>${q.name}</b><br><span class="note">${q.progress}/${q.goal} • Reward: ${q.reward} coins</span>`;
      const bar=document.createElement('div'); bar.className='bar'; const i=document.createElement('i'); i.style.width=(q.progress/q.goal*100)+'%'; bar.appendChild(i);
      const status=document.createElement('div'); status.textContent=q.done?'Done':'Active';
      row.appendChild(left); row.appendChild(bar); row.appendChild(status);
      ql.appendChild(row);
    });
    // update countdown text when the quest window rebuilds
    updateBossCountdownDisplay();
  }

  // ----- Shop (heals & sapphire purchase handling) -----
  function buildShop(){
    const root=document.getElementById('healList'); root.innerHTML='';
    if(player.sims.length===0){ root.innerHTML='<p class="note">No sims in team yet. Catch some first!</p>'; return; }
    player.sims.forEach((s,idx)=>{
      const row=document.createElement('div'); row.className='healRow';
      const d=document.createElement('div'); d.innerHTML=`<b>${s.type.name}</b><br><span class="note">HP ${s.hp}/${s.maxHp} • ${s.rarity}</span>`;
      const bar=document.createElement('div'); bar.className='bar'; const i=document.createElement('i'); i.style.width=(s.hp/s.maxHp*100)+'%'; bar.appendChild(i);
      const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Full Heal (10)';
      btn.onclick=()=>{
        if(coins<10) return alert('Not enough coins!');
        coins-=10; s.hp=s.maxHp; sfx.heal(); updateCoinsUI(); i.style.width='100%'; pulse(btn); maybeSave(); buildShop();
      };
      row.appendChild(d); row.appendChild(bar); row.appendChild(btn);
      root.appendChild(row);
    });
  }
  function pulse(el){ el.animate([{transform:'scale(1)'},{transform:'scale(1.06)'},{transform:'scale(1)'}],{duration:260}); }

  // Heal any Sim (SimDex) flow
  document.getElementById('btnHealAny').addEventListener('click', ()=>{
    const keys = Object.keys(simdex);
    if(keys.length === 0) return alert('Your SimDex is empty — catch some Simitaurs first.');
    openChooseHeal((id)=>{
      if(!id) return;
      if(coins < 10) return alert('Not enough coins!');
      coins -= 10; updateCoinsUI(); sfx.heal(); pulse(document.getElementById('btnHealAny'));
      // heal simdex entry
      const d = simdex[id];
      if(d){ d.hp = d.maxHp; }
      // if sim is also in player.sims, heal them too
      player.sims.forEach(s=>{ if(s.type.name === d.name && s.maxHp === d.maxHp){ s.hp = s.maxHp; } });
      maybeSave(); buildDex(); buildShop();
      alert(`${d.name} healed to full!`);
    });
  });

  function openChooseHeal(cb){
    const list=document.getElementById('chooseHealList'); list.innerHTML='';
    const keys = Object.keys(simdex);
    if(!keys.length){ alert('No entries in SimDex'); cb(null); return; }
    keys.forEach(k=>{
      const d = simdex[k];
      const btn = document.createElement('button'); btn.className='btn'; btn.style.minWidth='160px';
      btn.innerHTML = `<div style="text-align:left"><b>${d.name}</b><div class="note">HP ${d.hp}/${d.maxHp} • ${d.rarity}</div></div>`;
      btn.addEventListener('click', ()=>{ document.getElementById('chooseHealPanel').classList.remove('show'); cb(k); });
      list.appendChild(btn);
    });
    document.getElementById('btnCancelHeal').onclick = ()=>{ document.getElementById('chooseHealPanel').classList.remove('show'); cb(null); };
    panel('chooseHealPanel', true);
  }

  // ----- Minimap (with boss glow) -----
  let miniVisible = true;
  document.getElementById('btnMini').addEventListener('click', ()=>{
    miniVisible = !miniVisible;
    document.getElementById('minimap').style.display = miniVisible?'block':'none';
    document.getElementById('btnMini').textContent = miniVisible?'Hide Mini-Map':'Show Mini-Map';
  });

  function drawMini(){
    if(!miniVisible) return;
    const w=mini.width, h=mini.height;
    mctx.clearRect(0,0,w,h);
    mctx.fillStyle='#0b140c'; mctx.fillRect(0,0,w,h);
    // grid background
    for(let y=0;y<h;y+=8){ for(let x=0;x<w;x+=8){ mctx.fillStyle= ((x+y)/8)&1 ? '#0f1c13' : '#0d1812'; mctx.fillRect(x,y,8,8); } }
    // sims (exclude caught — only world sims)
    sims.forEach(s=>{
      const x=Math.floor(s.x/MAP_W*w), y=Math.floor(s.y/MAP_H*h);
      if(s.rarity==='Exotic') { mctx.fillStyle='#ff7ab6'; mctx.fillRect(x-1,y-1,3,3); }
      else { mctx.fillStyle='#4fd1c5'; mctx.fillRect(x,y,2,2); }
    });
    // npc
    { const x=Math.floor(npc.x/MAP_W*w), y=Math.floor(npc.y/MAP_H*h); mctx.fillStyle='#ffd166'; mctx.fillRect(x-1,y-1,3,3); }
    // boss (glowing pulsing cyan)
    if(worldBoss){
      const x=Math.floor(worldBoss.x/MAP_W*w), y=Math.floor(worldBoss.y/MAP_H*h);
      // pulse by time
      const t = performance.now()/600;
      const radius = 6 + Math.sin(t)*3;
      const g = mctx.createRadialGradient(x,y,radius*0.2,x,y,radius);
      g.addColorStop(0,'rgba(94,234,212,0.95)');
      g.addColorStop(0.5,'rgba(94,234,212,0.45)');
      g.addColorStop(1,'rgba(94,234,212,0.02)');
      mctx.fillStyle = g;
      mctx.beginPath(); mctx.arc(x,y,radius,0,Math.PI*2); mctx.fill();
      // center marker
      mctx.fillStyle = '#052b27'; mctx.fillRect(x-2,y-2,5,5);
    }
    // player
    { const x=Math.floor(player.x/MAP_W*w), y=Math.floor(player.y/MAP_H*h); mctx.fillStyle='#00ff85'; mctx.fillRect(x-2,y-2,5,5); }
    mctx.strokeStyle='#274f34'; mctx.strokeRect(0,0,w,h);
  }

  // ----- Boss spawn logic -----
  function spawnWorldBoss(){
    // choose random sim type to be boss variant (but scaled)
    const t=types[Math.floor(Math.random()*types.length)];
    const x = Math.floor(Math.random()*MAP_W), y = Math.floor(Math.random()*MAP_H);
    const hp = 150;
    // boss attacks are lower damage but consistent
    const attacks = [{name:'Heavy Swipe', dmg:9}, {name:'Stomp', dmg:7}, {name:'Gnaw', dmg:8}];
    worldBoss = { type: t, x, y, hp: hp, maxHp: hp, attacks, spawnedAt: Date.now() };
    // ensure a next spawn is scheduled only when boss is defeated; we keep the timer authoritative in localStorage
    drawMini();
    maybeSave();
  }

  function checkBossSpawnOnLoad(){
    // If a boss exists in memory (rare) we keep it; otherwise check next spawn timestamp
    const next = Number(localStorage.getItem('simitaur_boss_next') || '0');
    if(worldBoss) return;
    if(!next || Date.now() >= next){
      // spawn immediately
      spawnWorldBoss();
      // if there was no next value, set next to far future until defeated
      localStorage.setItem('simitaur_boss_next', String(Date.now() + 24*60*60*1000));
    } else {
      // not yet time — do nothing; we'll spawn once timer expires while the page is active
      // set an interval to check every minute while the page is active
      const checkInt = setInterval(()=>{
        const n2 = Number(localStorage.getItem('simitaur_boss_next') || '0');
        if(Date.now() >= n2){
          clearInterval(checkInt);
          spawnWorldBoss();
        }
      }, 60*1000);
    }
  }

  // ----- Boss countdown timer (in quest UI) -----
  let bossCountdownInterval = null;
  function startBossCountdownTimer(){
    if(bossCountdownInterval) clearInterval(bossCountdownInterval);
    bossCountdownInterval = setInterval(updateBossCountdownDisplay, 1000);
    updateBossCountdownDisplay();
  }
  function updateBossCountdownDisplay(){
    const el = document.getElementById('bossCountdown');
    if(worldBoss){
      el.innerHTML = '<span class="bossActive">Boss Active!</span>';
      return;
    }
    const next = Number(localStorage.getItem('simitaur_boss_next') || '0');
    if(!next || next <= 0){
      el.textContent = 'Next Boss: Ready to spawn';
      return;
    }
    const rem = next - Date.now();
    if(rem <= 0){
      el.textContent = 'Spawn imminent...';
      // trigger spawn
      spawnWorldBoss();
      return;
    }
    const s = Math.floor(rem/1000)%60;
    const m = Math.floor(rem/60000)%60;
    const h = Math.floor(rem/3600000);
    el.textContent = `Next Boss: ${h}h ${m}m ${s}s`;
  }

  // ----- Render loop -----
  (function renderLoop(){ if(mode==='world'){ draw(); } requestAnimationFrame(renderLoop); })();

  // ----- Helpers -----
  function isTouch(){ return /Mobi|Android|iPhone|iPad|iPod|Tablet/i.test(navigator.userAgent); }
  cvs.addEventListener('click', (ev)=>{ const rect=cvs.getBoundingClientRect(); const cx=ev.clientX-rect.left, cy=ev.clientY-rect.top; const wx=Math.floor(camX - VIEW_W/2 + (cx/TILE)), wy=Math.floor(camY - VIEW_H/2 + (cy/TILE)); const dx=Math.sign(wx-player.x), dy=Math.sign(wy-player.y); move(dx,dy); });

  // draggable windows
  makeDraggable('#settingsWin'); makeDraggable('#shopWin'); makeDraggable('#questWin');
  function makeDraggable(sel){
    const win=document.querySelector(sel); const bar=win.querySelector('.titlebar');
    let grab=false, sx=0, sy=0, ox=0, oy=0;
    bar.addEventListener('mousedown',e=>{ grab=true; sx=e.clientX; sy=e.clientY; const r=win.getBoundingClientRect(); ox=r.left; oy=r.top; });
    window.addEventListener('mousemove',e=>{ if(!grab) return; const nx=ox+(e.clientX-sx), ny=oy+(e.clientY-sy); win.style.left=Math.max(6,Math.min(window.innerWidth-win.offsetWidth-6,nx))+'px'; win.style.top=Math.max(6,Math.min(window.innerHeight-win.offsetHeight-6,ny))+'px'; });
    window.addEventListener('mouseup',()=>grab=false);
    // touch
    bar.addEventListener('touchstart',e=>{ const t=e.touches[0]; grab=true; sx=t.clientX; sy=t.clientY; const r=win.getBoundingClientRect(); ox=r.left; oy=r.top; },{passive:false});
    window.addEventListener('touchmove',e=>{ if(!grab) return; const t=e.touches[0]; const nx=ox+(t.clientX-sx), ny=oy+(t.clientY-sy); win.style.left=Math.max(6,Math.min(window.innerWidth-win.offsetWidth-6,nx))+'px'; win.style.top=Math.max(6,Math.min(window.innerHeight-win.offsetHeight-6,ny))+'px'; },{passive:false});
    window.addEventListener('touchend',()=>grab=false);
  }

  // easing
  function lerp(a,b,t){ return a + (b-a)*t; }
  function easeOutQuad(t){ return t*(2-t); }
  function easeInOutCubic(t){ return t<0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2; }
  function maybeSave(){ if(document.getElementById('rememberMe')?.checked) saveGame(); }

  // ----- UI boot -----
  function refreshAll(){ updateCoinsUI(); buildShop(); buildQuests(); draw(); drawMini(); buildSuitUI(); }
  refreshAll();

  // ----- Shop purchase handlers (simulate payments) -----
  function simulatePurchase(amount, sappCount){
    const confirmMsg = `Simulate purchase: pay $${amount} to receive ${sappCount} sapphires?`;
    if(!confirm(confirmMsg)) return;
    awardSapphires(sappCount);
    alert(`Purchase successful — credited ${sappCount} sapphires.`);
    maybeSave();
  }
  document.getElementById('buy100').addEventListener('click', ()=> simulatePurchase(0.25, 100));
  document.getElementById('buy1000').addEventListener('click', ()=> simulatePurchase(1, 1000));
  document.getElementById('buy100k').addEventListener('click', ()=> simulatePurchase(5, 100000));
  document.getElementById('buy200k').addEventListener('click', ()=> simulatePurchase(7, 200000));
  document.getElementById('buy500k').addEventListener('click', ()=> simulatePurchase(10, 500000));

  // ----- Persist boss inside save? (light) -----
  // We keep boss state ephemeral; next spawn time is authoritative. If you wish to persist
  // live boss state across reloads, you can store worldBoss in localStorage too.

  // Kick off countdown if starting from menu later
  // Also periodically draw mini to animate boss glow
  setInterval(()=>{ if(mode==='world') drawMini(); }, 120);

  // Expose a save on page hide
  window.addEventListener('beforeunload', ()=>{ saveGame(); });

})();
</script>

<!-- Loading Screen -->
<div id="loadingScreen">
  <div class="loadingContent">
    <img id="loadingImage" src="images/your-image.png" alt="Simitaur Logo" />
    <h1>Simitaur RPG — Loading...</h1>
    <div class="loadingCircle"></div>
  </div>
</div>

<style>
#loadingScreen {
  position: fixed;
  inset: 0;
  background: linear-gradient(180deg, #041018 0%, #072029 100%);
  color: #f7f3e9;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 9999;
  font-family: Inter, "Segoe UI", Roboto, system-ui, Arial;
}
.loadingContent {
  text-align: center;
}
#loadingImage {
  width: 240px;
  max-width: 60%;
  border-radius: 16px;
  margin-bottom: 24px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
  object-fit: contain;
}
.loadingContent h1 {
  margin-bottom: 40px;
  font-weight: 900;
  letter-spacing: 1px;
}
.loadingCircle {
  position: fixed;
  bottom: 40px;
  right: 50px;
  width: 40px;
  height: 40px;
  border: 4px solid rgba(255,255,255,0.2);
  border-top-color: #c9a34a;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<script>
window.addEventListener("load", () => {
  const loader = document.getElementById("loadingScreen");
  const menu = document.getElementById("menu");
  if (menu) menu.style.display = "none";

  const img = document.getElementById("loadingImage");
  img.onerror = () => { img.style.display = "none"; };

  setTimeout(() => {
    loader.style.opacity = "0";
    loader.style.transition = "opacity 0.6s ease";
    setTimeout(() => {
      loader.remove();
      if (menu) menu.style.display = "flex";
    }, 600);
  }, 7000);
});
</script>
<canvas id="gameCanvas" width="800" height="600" style="border:1px solid #000;"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // Firebase setup
  const firebaseConfig = {
    apiKey: "AIzaSyCxyW86qYBD41T_6PdM0mMtg233sQfCbAM",
    authDomain: "simitaurs.firebaseapp.com",
    databaseURL: "https://simitaurs-default-rtdb.firebaseio.com",
    projectId: "simitaurs",
    storageBucket: "simitaurs.firebasestorage.app",
    messagingSenderId: "415340567485",
    appId: "1:415340567485:web:99538c93559940f7c890d4",
    measurementId: "G-T6K30LZTLK"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Canvas
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  // Player setup
  const playerId = "player_" + Math.floor(Math.random() * 999999);
  const roomId = "world1";
  const playerRef = db.ref(`rooms/${roomId}/players/${playerId}`);
  const player = { x: 100, y: 100, size: 40 };

  // Add player to Firebase
  playerRef.set({ x: player.x, y: player.y, hp: 100, online: true });
  playerRef.onDisconnect().remove();

  // Track all players
  let allPlayers = {};

  db.ref(`rooms/${roomId}/players`).on("value", snapshot => {
    allPlayers = snapshot.val() || {};
  });

  // Update your real player position
  function updatePlayerPosition(x, y) {
    playerRef.update({ x, y });
  }

  // Movement (example: arrow keys)
  document.addEventListener("keydown", e => {
    if (e.key === "ArrowRight") player.x += 5;
    if (e.key === "ArrowLeft") player.x -= 5;
    if (e.key === "ArrowUp") player.y -= 5;
    if (e.key === "ArrowDown") player.y += 5;

    updatePlayerPosition(player.x, player.y);
  });

  // 🔹 Function to calculate distance
  function distance(p1, p2) {
    return Math.hypot(p1.x - p2.x, p1.y - p2.y);
  }

  // Render loop
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw your player
    ctx.beginPath();
    ctx.arc(player.x + 20, player.y + 20, 20, 0, Math.PI * 2);
    ctx.fillStyle = "blue";
    ctx.fill();
    ctx.stroke();
    ctx.closePath();
    ctx.fillStyle = "white";
    ctx.font = "12px Arial";
    ctx.textAlign = "center";
    ctx.fillText("You", player.x + 20, player.y + 25);

    // Draw other players **only if close enough**
    const visibleDistance = 100; // change this to adjust how close they need to be
    for (const id in allPlayers) {
      if (id === playerId) continue; // skip yourself
      const p = allPlayers[id];
      if (distance(player, p) <= visibleDistance) {
        ctx.beginPath();
        ctx.arc(p.x + 20, p.y + 20, 20, 0, Math.PI * 2);
        ctx.fillStyle = "red";
        ctx.fill();
        ctx.stroke();
        ctx.closePath();
        ctx.fillStyle = "white";
        ctx.fillText("Player", p.x + 20, p.y + 25);
      }
    }

    requestAnimationFrame(draw);
  }

  draw();
</script>




  


</body>
</html>

