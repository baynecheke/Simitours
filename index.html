<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<!-- FIREBASE SDKs (Added for Multiplayer) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<div id="g_id_onload"
     data-client_id="691247578632-ioig368ultf6ovhgl089jpm6cni6s2rr.apps.googleusercontent.com"
     data-context="signin"
     data-callback="handleGoogleLogin">
</div>

<div class="g_id_signin"
     data-type="standard"
     data-size="large"
     data-theme="outline">
</div>

<script>
// Google Login Handler
function handleGoogleLogin(response) {
    const credential = response.credential;
    const payload = JSON.parse(atob(credential.split('.')[1]));
    console.log("Logged in as:", payload.name);
    localStorage.setItem("googleUser", JSON.stringify(payload));
    alert("Logged in as: " + payload.name);
    // Optional: Auto-fill name
    const nameInput = document.getElementById('playerName');
    if(nameInput) nameInput.value = payload.name;
}
</script>

  <meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Simitaur RPG — Adventure & Multiplayer</title>
<style>

  :root{
    --bg:#071018;                   /* deep night blue */
    --panel:rgba(6,8,6,.88);
    --card:#0f1b1a;                 /* dark parchment-like card */
    --accent:#c9a34a;               /* warm gold accent */
    --btn:#2b475d;                  /* steel blue buttons */
    --btn-h:#375f7a;                /* hover */
    --danger:#d85757;
    --ink:#f7f3e9;                  /* warm cream text */
    --ring:#3b5a6b;
    --glass:rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, system-ui, -apple-system, Arial;background:linear-gradient(180deg,#041018 0%, #072029 100%);color:var(--ink);-webkit-font-smoothing:antialiased; overflow:hidden;}
  .wrap{max-width:1100px;margin:12px auto;padding:10px}
  canvas#game{
    display:block;margin:8px auto;border-radius:14px;border:4px solid rgba(255,255,255,0.04);
    background:linear-gradient(180deg,#7cc57a 0%, #5ea86a 100%);box-shadow:0 20px 40px rgba(2,6,10,0.6);
    image-rendering:pixelated;image-rendering:crisp-edges;touch-action:none
  }
  /* HUD */
  #hud{position:fixed;top:18px;left:18px;right:18px;display:flex;gap:10px;z-index:60;flex-wrap:wrap;align-items:center}
  .pill{background:linear-gradient(180deg,var(--btn),var(--btn-h));border:none;color:var(--ink);border-radius:999px;padding:9px 14px;font-weight:800;cursor:pointer;box-shadow:0 6px 0 rgba(0,0,0,0.48), inset 0 -2px 0 rgba(0,0,0,0.12);transition:transform .08s ease,box-shadow .08s;}
  .pill:active{transform:translateY(2px);box-shadow:0 3px 0 rgba(0,0,0,0.6)}
  .pill.secondary{background:linear-gradient(180deg,#2a3946,#202f3a)}
  .stat{display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));border:1px solid var(--ring);border-radius:999px;padding:8px 12px;font-weight:800;backdrop-filter:blur(4px)}
  .stat img{width:18px;height:18px}
  #coinGain{position:fixed;top:18px;right:22px;font-weight:900;color:var(--accent);text-shadow:0 2px 0 rgba(0,0,0,0.6);pointer-events:none;z-index:70;opacity:0;transition:transform .45s ease,opacity .45s ease}
  /* DPad */
  #dpad{
    position:fixed;left:18px;bottom:18px;display:grid;
    grid-template-columns:56px 56px;grid-template-rows:56px 56px 56px;gap:10px;z-index:60
  }
  #dpad button{width:56px;height:56px;border-radius:12px;border:none;background:linear-gradient(180deg,#1b3b4d,#173141);color:var(--ink);font-weight:900;box-shadow:0 6px 0 rgba(0,0,0,0.5);font-size:18px;user-select:none}
  #dpad .ghost{opacity:.75}
  /* Panels / Modals */
  .panel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,6,10,0.6), rgba(0,0,0,0.7));backdrop-filter:blur(6px);z-index:80}
  .panel.show{display:flex}
  .box{background:linear-gradient(180deg,var(--card), rgba(10,12,10,0.98));border:1px solid rgba(255,255,255,0.03);border-radius:12px;padding:18px 22px;box-shadow:0 20px 50px rgba(0,0,0,.6);max-width:94vw;color:var(--ink)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  button.btn{background:linear-gradient(180deg,var(--btn),var(--btn-h));border:none;border-radius:10px;padding:10px 14px;color:var(--ink);font-weight:800;cursor:pointer;box-shadow:0 8px 0 rgba(0,0,0,0.48)}
  button.btn:hover{transform:translateY(-1px)}
  .danger{background:linear-gradient(180deg,#c94b4b,#a83b3b)}
  .hp{width:260px;height:16px;background:linear-gradient(90deg,#0b1a12,#081412);border-radius:8px;overflow:hidden;border:1px solid rgba(0,0,0,0.6)}
  .fill{height:100%;background:linear-gradient(90deg,#ff6b6b,#ffd166);width:100%;transition:width .18s linear;box-shadow:inset 0 -3px 8px rgba(0,0,0,0.35)}
  .label{font-weight:900;margin-bottom:6px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);border-radius:6px;padding:4px 8px}
  .note{font-size:13px;opacity:.9;color:rgba(255,255,255,0.85)}
  /* Draggable windows (Shop/Settings/Quests) */
  .float{position:fixed;top:80px;left:60px;z-index:85;background:linear-gradient(180deg,var(--card),rgba(8,14,12,0.96));border:1px solid rgba(255,255,255,0.03);border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.6);display:none;min-width:320px;max-width:90vw}
  .float.show{display:block}
  .float .titlebar{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.02);cursor:move;border-radius:14px 14px 0 0;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}
  .float .content{padding:14px;max-height:60vh;overflow:auto}
  .closeX{background:linear-gradient(180deg,#2b475d,#202f3a);border:1px solid rgba(255,255,255,0.02);color:var(--ink);border-radius:8px;padding:6px 10px;cursor:pointer}
  /* Shop list */
  .healRow{display:flex;justify-content:space-between;align-items:center;padding:10px;border:1px solid rgba(255,255,255,0.03);border-radius:10px;margin-bottom:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03))}
  .bar{height:10px;background:linear-gradient(90deg,#0f2418,#08140f);border-radius:999px;overflow:hidden;border:1px solid rgba(0,0,0,0.6)}
  .bar > i{display:block;height:100%;background:linear-gradient(90deg,#24d17b,#9be7a5);width:50%;transition:width .25s ease}
  /* Mini-map */
  #minimapWrap{position:fixed;right:18px;bottom:18px;z-index:65;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  #minimap{width:160px;height:160px;border-radius:10px;border:2px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,#041017,#071621);image-rendering:pixelated}
  #btnMini{background:linear-gradient(180deg,#162e3b,#10313a);border:1px solid rgba(255,255,255,0.02);border-radius:8px;color:var(--ink);padding:8px 12px;cursor:pointer}
  /* Suit shop in settings */
  .suitSlot{display:flex;gap:12px;align-items:center;border:1px solid rgba(255,255,255,0.02);padding:10px;border-radius:10px;margin-top:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03))}
  .suitSlot img{width:56px;height:56px;object-fit:cover;border-radius:8px;background:rgba(0,0,0,0.2)}
  .suitSlot .meta{flex:1}
  .suitSlot .meta .name{font-weight:900}
  .suitSlot .meta .owned{font-size:12px;opacity:.95}
  
  /* Loading Screen */
  #loadingScreen {
    position: fixed; inset: 0; background: linear-gradient(180deg, #041018 0%, #072029 100%); color: #f7f3e9;
    display: flex; align-items: center; justify-content: center; flex-direction: column;
    z-index: 9999; font-family: Inter, "Segoe UI", system-ui;
  }
  .loadingContent { text-align: center; }
  .loadingCircle {
    position: fixed; bottom: 40px; right: 50px; width: 40px; height: 40px;
    border: 4px solid rgba(255,255,255,0.2); border-top-color: #c9a34a;
    border-radius: 50%; animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* XP Bar UI Overlay */
  #xpOverlay {
    position: absolute; top: 18px; left: 50%; transform: translateX(-50%);
    width: 260px; background: rgba(0,0,0,0.5); border-radius: 12px;
    padding: 6px; border: 1px solid rgba(255,255,255,0.1); pointer-events: none;
    display: none; z-index: 61;
  }
  @media (min-width: 860px) { #xpOverlay { display: block; } }

  /* Boss Active glow style */
  .bossActive {
    color:var(--accent);
    text-shadow:0 0 10px rgba(201,163,74,0.85), 0 0 24px rgba(201,163,74,0.45);
    font-weight:900;
  }

  @media (max-width:860px){
    canvas#game{width:94vw;height:auto;border-radius:10px}
    #dpad{left:50%;transform:translateX(-50%);grid-template-columns:64px 64px;grid-template-rows:64px 64px 64px}
    #dpad button{width:64px;height:64px;border-radius:14px;font-size:22px}
    #hud{left:8px;right:8px;justify-content:center}
    #xpOverlay { position: static; transform: none; width: 90%; margin: 8px auto; display: block; order: 10; }
  }

</style>
</head>
<body>

<!-- Loading Screen -->
<div id="loadingScreen">
  <div class="loadingContent">
    <h1>Simitaur RPG</h1>
    <p class="note">Loading Assets & Multiplayer...</p>
    <div class="loadingCircle"></div>
  </div>
</div>

<div class="wrap">
  <!-- XP Overlay (Multiplayer Feature) -->
  <div id="xpOverlay">
    <div id="xpText" style="font-size:11px; margin-bottom:4px; color:#c9a34a; text-align:center; font-weight:700;">Level 1 — 0/100 XP</div>
    <div style="width:100%; height:8px; background:#000; border-radius:6px; overflow:hidden;">
      <div id="xpBar" style="height:100%; width:0%; background:#4caf50; transition:width 0.3s ease;"></div>
    </div>
  </div>

  <canvas id="game" width="640" height="640"></canvas>
</div>

<!-- HUD -->
<div id="hud" style="display:none">
  <div class="stat" title="Coins"><svg width="18" height="18" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#ffd166"/><circle cx="12" cy="12" r="6" fill="#d8a800"/></svg><span id="coinLabel">0</span></div>

  <!-- SAPPHIRE stat (mirrors coin UI) -->
  <div class="stat" title="Sapphires" style="background:#102033;border:1px solid #2a4b6a;">
    <svg width="18" height="18" viewBox="0 0 24 24" style="filter:drop-shadow(0 1px 0 rgba(0,0,0,.6));">
      <path d="M12 2 L20 9 L14 22 L6 22 L0 9 Z" fill="#4fd1c5"></path>
      <path d="M12 2 L4 9 L10 22 L18 22 L24 9 Z" fill="#3ab8a9" opacity=".9"></path>
    </svg>
    <span id="sapphireLabel">0</span>
  </div>

  <button id="btnSettings" class="pill">Settings</button>
  <button id="btnDex" class="pill">SimDex</button>
  <button id="btnShop" class="pill">Shop</button>
  <button id="btnQuests" class="pill">Quests</button>
  <button id="btnMusic" class="pill">Music: On</button>
  <button id="btnSignOut" class="pill secondary">Sign Out</button>
</div>
<div id="coinGain">+5</div>

<!-- Dpad -->
<div id="dpad" style="display:none">
  <button id="padUp" class="ghost">▲</button>
  <button id="padLeft">◀</button>
  <button id="padRight">▶</button>
  <button id="padDown" class="ghost">▼</button>
</div>

<!-- MENU -->
<div id="menu" class="panel show">
  <div class="box" style="text-align:center;max-width:520px">
    <h1 style="margin:6px 0 2px">Simitaur RPG</h1>
    <p class="muted" style="margin:0 0 10px">Explore, catch, and battle. Multiplayer Enabled.</p>
    <div id="signin-area">
      <input id="playerName" placeholder="Player name" style="padding:10px;width:86%;margin:6px;border-radius:8px;border:1px solid #274f34;background:#0f1b13;color:#eafff0"><br>
      <input id="playerPass" placeholder="Password (Optional for local)" type="password" style="padding:10px;width:86%;margin:6px;border-radius:8px;border:1px solid #274f34;background:#0f1b13;color:#eafff0"><br>
      <label style="display:flex;align-items:center;justify-content:center;margin-top:4px"><input id="rememberMe" type="checkbox" style="margin-right:8px"> Remember Me</label>
      <div class="row" style="justify-content:center;margin-top:12px">
        <button id="btnSignIn" class="btn">Sign In</button>
        <button id="btnGuest" class="btn">Play as Guest</button>
      </div>
    </div>
    <div id="menu-main" style="display:none;margin-top:10px" class="row">
      <button id="btnStart" class="btn" style="padding:10px 16px">Start Game</button>
      <button id="btnOpenSettings" class="btn">Settings</button>
      <button id="btnOpenDexPanel" class="btn">SimDex</button>
    </div>
    <p class="note">Controls: <span class="kbd">Arrow Keys / WASD</span> or on-screen D-Pad • Walk onto sims to interact</p>
  </div>
</div>

<!-- Settings (draggable) -->
<div id="settingsWin" class="float" style="top:96px;left:80px">
  <div class="titlebar"><b>Settings & Uploads</b><button class="closeX" data-close="#settingsWin">Close</button></div>
  <div class="content">
    <div class="row" style="gap:14px">
      <div>
        <label>Player Sprite (file)</label><input id="filePlayer" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">Player Sprite URL</label><div style="display:flex;gap:6px"><input id="urlPlayer" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button id="loadUrlPlayer" class="btn">Load</button></div>
      </div>
      <div>
        <label>Charcoal (NPC) Sprite (file)</label><input id="fileNPC" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">NPC Sprite URL</label><div style="display:flex;gap:6px"><input id="urlNPC" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button id="loadUrlNPC" class="btn">Load</button></div>
      </div>
      <div>
        <label>SimNet (catch image) (file)</label><input id="fileNet" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">SimNet URL</label><div style="display:flex;gap:6px"><input id="urlNet" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button id="loadUrlNet" class="btn">Load</button></div>
      </div>
    </div>
    <div style="height:8px"></div>
    <div class="row" style="gap:14px;flex-wrap:wrap">
      <!-- 7 sim slots now -->
      <div style="min-width:220px">
        <label>Sim Sprite Slot 1 (file)</label><input class="fileSim" data-id="0" type="file" accept="image/*" style="display:block;margin-top:6px">
        <label style="margin-top:6px">Slot 1 URL</label><div style="display:flex;gap:6px"><input class="urlSim" data-id="0" placeholder="https://..." style="flex:1;padding:6px;border-radius:6px;background:#0f1b13;border:1px solid #274f34;color:#eafff0"><button class="loadUrlSim btn" data-id="0">Load</button></div>
      </div>
      <!-- Additional slots would go here (abbreviated for length but preserved logic) -->
    </div>

    <!-- SUIT SHOP (5 suits) -->
    <div style="height:10px"></div>
    <h3 style="margin:6px 0">Cosmetic Suits (500 sapphires each)</h3>
    <p class="note">Upload a suit image or paste a URL. Buy to unlock with 500 sapphires, then equip it. Suits overlay on top of the player sprite.</p>
    <div id="suitArea"></div>

    <div style="height:8px"></div>
    <div class="row" style="justify-content:space-between;margin-top:12px;align-items:center">
      <div>
        <label style="display:flex;gap:8px;align-items:center"><input id="toggleMusic" type="checkbox" checked> Music</label>
        <label style="display:flex;gap:8px;align-items:center;margin-top:6px"><input id="toggleSfx" type="checkbox" checked> Sound Effects</label>
      </div>
    </div>
  </div>
</div>

<!-- SimDex (modal) -->
<div id="dex" class="panel">
  <div class="box" style="max-width:980px; max-height:80vh; display:flex; flex-direction:column;">
    <h2 style="margin-top:0; text-align:center;">Your SimDex</h2>
    <div id="dexScrollArea" style="flex:1; overflow-y:auto; border:1px solid rgba(255,255,255,0.1); border-radius:8px; padding:10px; max-height:65vh; background:rgba(0,0,0,0.2);">
      <div id="dexGrid" style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center;"></div>
    </div>
    <div style="text-align:center; margin-top:10px;">
      <button id="btnCloseDex" class="btn">Close</button>
    </div>
  </div>
</div>

<!-- Shop (draggable) -->
<div id="shopWin" class="float" style="top:140px;left:120px">
  <div class="titlebar"><b>Shop — Heals & Items</b><button class="closeX" data-close="#shopWin">Close</button></div>
  <div class="content">
    <div id="shopCoins" class="note" style="margin-bottom:10px">Coins: 0</div>
    <div id="healList"></div>
    <div style="height:8px"></div>
    <div style="text-align:center">
      <button id="btnHealAny" class="btn">Heal any Sim (10)</button>
    </div>
    <hr style="margin:12px 0;border-color:#213a2a">
    <h3 style="margin:6px 0">Sapphire Packs (real money)</h3>
    <div class="row" style="justify-content:center;gap:8px;margin-top:8px">
      <button class="btn" id="buy100">100 — $0.25</button>
      <button class="btn" id="buy1000">1,000 — $1</button>
    </div>
  </div>
</div>

<!-- Quests (draggable) -->
<div id="questWin" class="float" style="top:180px;left:160px">
  <div class="titlebar"><b>Quests</b><button class="closeX" data-close="#questWin">Close</button></div>
  <div class="content">
    <div id="questList"></div>
    <div style="height:10px"></div>
    <div id="bossCountdownWrap" style="text-align:center">
      <div id="bossCountdown" class="note">Next Boss: --</div>
    </div>
  </div>
</div>

<!-- Encounter panel -->
<div id="encounterPanel" class="panel">
  <div class="box">
    <h2 id="encounterTitle" style="margin-top:0">Encounter</h2>
    <div class="row" style="justify-content:center">
      <button id="btnFight" class="btn">Battle</button>
      <button id="btnCatchSim" class="btn">Catch (SimNet)</button>
      <button id="btnRun" class="btn danger">Run</button>
    </div>
  </div>
</div>

<!-- Boss encounter panel -->
<div id="bossPanel" class="panel">
  <div class="box">
    <h2 id="bossTitle" style="margin-top:0">World Boss</h2>
    <div id="bossInfo" style="text-align:center;margin-top:6px"></div>
    <div class="row" style="justify-content:center;margin-top:10px">
      <button id="btnBossFight" class="btn">Battle Boss</button>
      <button id="btnBossInspect" class="btn">Inspect</button>
      <button id="btnBossRun" class="btn danger">Leave</button>
    </div>
  </div>
</div>

<!-- Choose Sim for battle -->
<div id="chooseSimPanel" class="panel">
  <div class="box" style="max-width:620px">
    <h2 style="margin-top:0">Choose a Sim to battle</h2>
    <div id="chooseSimList" class="row" style="justify-content:center"></div>
    <div style="text-align:center;margin-top:8px"><button id="btnCancelChoose" class="btn">Cancel</button></div>
  </div>
</div>

<!-- Choose Sim to heal from SimDex -->
<div id="chooseHealPanel" class="panel">
  <div class="box" style="max-width:620px">
    <h2 style="margin-top:0">Choose a Sim to Heal (10 coins)</h2>
    <div id="chooseHealList" class="row" style="justify-content:center;gap:8px;flex-wrap:wrap"></div>
    <div style="text-align:center;margin-top:8px"><button id="btnCancelHeal" class="btn">Cancel</button></div>
  </div>
</div>

<!-- Battle panel -->
<div id="battlePanel" class="panel">
  <div class="box">
    <h2 id="battleTitle" style="margin-top:0">Battle</h2>
    <div class="row" style="justify-content:center;gap:26px">
      <div style="text-align:center">
        <div id="playerLabel" class="label">You</div>
        <div class="hp"><div id="hpYou" class="fill"></div></div>
      </div>
      <div style="text-align:center">
        <div id="enemyLabel" class="label">Enemy</div>
        <div class="hp"><div id="hpEnemy" class="fill"></div></div>
      </div>
    </div>
    <div id="battleButtons" class="row" style="justify-content:center;margin-top:10px"></div>
    <div style="text-align:center;margin-top:10px"><button id="btnRunBattle" class="btn danger">Run</button></div>
  </div>
</div>

<!-- Mini-map -->
<div id="minimapWrap">
  <canvas id="minimap" width="160" height="160"></canvas>
  <button id="btnMini">Hide Mini-Map</button>
</div>

<script>
/* ===========================================================
   Simitaur RPG — UNIFIED ENGINE (Restored + Firebase Merged)
   =========================================================== */

// 1. FIREBASE INIT
const firebaseConfig = {
    apiKey: "AIzaSyCxyW86qYBD41T_6PdM0mMtg233sQfCbAM",
    authDomain: "simitaurs.firebaseapp.com",
    databaseURL: "https://simitaurs-default-rtdb.firebaseio.com",
    projectId: "simitaurs",
    storageBucket: "simitaurs.firebasestorage.app",
    messagingSenderId: "415340567485",
    appId: "1:415340567485:web:99538c93559940f7c890d4",
    measurementId: "G-T6K30LZTLK"
};

let db = null;
try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    console.log("Firebase initialized.");
} catch(e) { console.warn("Firebase offline/error", e); }

(() => {
  // ----- Canvas & world settings -----
  const cvs = document.getElementById('game'), ctx = cvs.getContext('2d');
  const mini = document.getElementById('minimap'), mctx = mini.getContext('2d');
  const TILE = 64, VIEW_W = 10, VIEW_H = 10;
  const MAP_W = 1000, MAP_H = 1000;
  
  let animTime = 0;

  // ----- State -----
  let mode = 'menu'; // menu, world, battle
  const player = {
    x: Math.floor(MAP_W/2), y: Math.floor(MAP_H/2),
    hp:100, maxHp:100, img: null, sims: [], xp:0, level:1, name:'', pass:'',
    // Multiplayer fields
    online: false
  };
  const npc = { x: Math.floor(MAP_W/2) + 3, y: Math.floor(MAP_H/2), img: null, name: 'Charcoal' };
  let netImage = null;

  // Multiplayer Listeners
  let otherPlayers = {};
  let lastNetUpdate = 0;

  // Economy / Quests / Sapphires
  let coins = 0;
  let sapphires = 0;
  const quests = [
    { id:'q1', name:'Catch 5 Simitaurs', goal:5, progress:0, reward:25, done:false },
    { id:'q2', name:'Catch 1 Exotic', goal:1, progress:0, reward:50, done:false },
  ];

  // World sims
  let sims = [];            // visible wild sims positions
  let simdex = {};          // caught index
  let currentEncounter = null;
  let battlePlayerSim = null, battleEnemySim = null;
  let worldBoss = null;

  // Suits (5)
  let suits = [
    { id:0, name:'Suit 1', src:'', img:null, owned:false },
    { id:1, name:'Suit 2', src:'', img:null, owned:false },
    { id:2, name:'Suit 3', src:'', img:null, owned:false },
    { id:3, name:'Suit 4', src:'', img:null, owned:false },
    { id:4, name:'Suit 5', src:'', img:null, owned:false }
  ];
  let equippedSuit = null;

  // Audio toggles
  let musicOn = true, sfxOn = true;
  let canPlayerAct = true;

  // ----- Types & rarities -----
  const types = [
    { id:0, name:'Frostaur', img:null, src:'images/12E0BB61-32BA-4A5D-95A9-EEC144F9769F.jpg', baseRarityWeights:[60,25,10,3,1,1] },
    { id:1, name:'Rockaur',  img:null, src:'', baseRarityWeights:[40,30,18,8,3,1] },
    { id:2, name:'Leafaur',  img:null, src:'', baseRarityWeights:[30,30,20,12,6,2] },
    { id:3, name:'Stormaur', img:null, src:'', baseRarityWeights:[36,28,20,10,5,1] },
    { id:4, name:'Flametaur',img:null, src:'', baseRarityWeights:[42,30,16,8,3,1] },
    { id:5, name:'Aquataur', img:null, src:'', baseRarityWeights:[34,30,20,10,5,1] },
    { id:6, name:'Shadeaur', img:null, src:'', baseRarityWeights:[50,28,12,6,3,1] }
  ];
  const RARITIES = ['Common','Uncommon','Rare','Legendary','Mythic','Exotic'];

  // ----- Audio (Restored High Quality) -----
  const AC = window.AudioContext || window.webkitAudioContext;
  const audio = new AC();
  let musicToken = 0;
  function ensureAudio(){ if(audio.state === 'suspended') audio.resume(); }
  function tone(freq, dur=0.12, type='square', vol=0.06){
    if(!sfxOn) return;
    const t0 = audio.currentTime;
    const o = audio.createOscillator(), g = audio.createGain();
    o.type = type; o.frequency.value = freq; g.gain.value = vol;
    o.connect(g); g.connect(audio.destination);
    o.start(t0);
    const a=0.004, r=0.03;
    g.gain.setValueAtTime(0, t0);
    g.gain.linearRampToValueAtTime(vol, t0+a);
    g.gain.linearRampToValueAtTime(0.0001, t0+dur-r);
    o.stop(t0+dur);
  }
  const sfx = {
    step(){ tone(220+Math.random()*20, .06, 'triangle', .04); },
    atk(){ tone(740, .09, 'square', .07); tone(620, .06, 'square', .06); },
    battleStart(){ tone(330,.08,'square',.07); setTimeout(()=>tone(660,.12,'square',.07),80); },
    catch(){ tone(520,.18,'square',.07); setTimeout(()=>tone(880,.12,'square',.06),140); },
    win(){ tone(880,.14,'sawtooth',.08); setTimeout(()=>tone(660,.12,'square',.05),120); },
    escape(){ tone(180,.12,'triangle',.05); },
    coin(){ tone(1400,.08,'triangle',.05); },
    heal(){ tone(520,.06,'sine',.05); setTimeout(()=>tone(620,.06,'sine',.05),70); setTimeout(()=>tone(740,.06,'sine',.05),140); }
  };
  function startMusic(){
    if(!musicOn) return;
    ensureAudio();
    const token = ++musicToken;
    const key = [196,220,247,262,294,330,349,392];
    const spb = 60/112;
    let step = 0;
    (function loop(){
      if(!musicOn || token !== musicToken) return;
      const t0 = audio.currentTime + 0.02;
      const chord = [[key[0],key[2],key[4]],[key[1],key[3],key[5]],[key[2],key[4],key[6]],[key[3],key[5],key[7]]][(Math.floor(step/2))%4];
      if(step%2===0){ const o=audio.createOscillator(), g=audio.createGain(); o.type='triangle'; o.frequency.value=chord[0]/2; g.gain.value=0.05; o.connect(g); g.connect(audio.destination); o.start(t0); o.stop(t0+0.3); }
      step++; setTimeout(loop, spb*1000*2);
    })();
  }

  // ----- Save / Load / Firebase Sync -----
  const SAVE_KEY = 'simitaur_save_v6';

  function saveGame(){
    try{
      const store = {
        player:{ name:player.name, pass:player.pass, xp:player.xp, level:player.level,
          sims: player.sims.map(s=>({typeId:s.type.id,hp:s.hp,maxHp:s.maxHp,attacks:s.attacks,rarity:s.rarity,size:s.size,weight:s.weight})) },
        simdex,
        coins, sapphires, quests, suits, equippedSuit
      };
      localStorage.setItem(SAVE_KEY, JSON.stringify(store));
      
      // Firebase Sync
      if(db && player.name) {
          db.ref("profiles/"+player.name).set({
              xp: player.xp,
              level: player.level,
              coins: coins,
              sapphires: sapphires
          });
      }
    }catch(e){ console.warn('save failed', e); }
  }

  function loadGame(){
    try{
      const raw = localStorage.getItem(SAVE_KEY); if(!raw) return false;
      const obj = JSON.parse(raw);
      if(obj.player?.name){
        player.name = obj.player.name; player.pass = obj.player.pass || '';
        player.xp = obj.player.xp || 0; player.level = obj.player.level || 1;
        player.sims = (obj.player.sims||[]).map(d=>({type: types.find(t=>t.id===d.typeId)||types[0], hp:d.hp, maxHp:d.maxHp, attacks:d.attacks||[{name:'Punch',dmg:10}], rarity:d.rarity, size:d.size, weight:d.weight}));
        simdex = obj.simdex || {};
        coins = obj.coins ?? 0;
        sapphires = obj.sapphires ?? 0;
        if(obj.quests) quests.forEach((q,i) => { if(obj.quests[i]) Object.assign(q, obj.quests[i]); });
        if(obj.suits) suits = obj.suits;
        equippedSuit = obj.equippedSuit;
        updateXPUI();
        return true;
      }
    }catch(e){ console.warn('load fail', e); return false; }
    return false;
  }
  
  if(loadGame()){
    document.getElementById('playerName').value = player.name;
    document.getElementById('menu-main').style.display = 'flex';
    document.getElementById('signin-area').style.display = 'none';
  }

  function xpNeeded(lvl) { return 100 + (lvl-1)*50; }
  function gainXP(amt) {
      player.xp += amt;
      const need = xpNeeded(player.level);
      if(player.xp >= need) {
          player.xp -= need;
          player.level++;
          sfx.win();
          alert(`LEVEL UP! You are level ${player.level}`);
      }
      updateXPUI();
      saveGame();
  }
  function updateXPUI(){
      const need = xpNeeded(player.level);
      const pct = Math.floor((player.xp / need)*100);
      document.getElementById('xpBar').style.width = pct + '%';
      document.getElementById('xpText').textContent = `Level ${player.level} — ${player.xp}/${need} XP`;
  }

  // ----- Spawning -----
  function weightedRarity(weights){ const sum=weights.reduce((a,b)=>a+b,0); let r=Math.random()*sum; for(let i=0;i<weights.length;i++){ if(r<weights[i]) return i; r-=weights[i]; } return weights.length-1; }

  function spawnSims(){
    sims = [];
    const count = Math.max(250, Math.floor((MAP_W * MAP_H) / 2000)); 
    for(let i=0;i<count;i++){
        let x=Math.floor(Math.random()*MAP_W), y=Math.floor(Math.random()*MAP_H);
        const t = types[Math.floor(Math.random()*types.length)];
        const idx = weightedRarity(t.baseRarityWeights.slice());
        const rarity = RARITIES[idx];
        const hp = 24 + Math.floor(Math.random()*60);
        sims.push({x,y,type:t,hp,maxHp:hp,attacks:[{name:'Hit',dmg:5}],rarity,size:1,weight:1});
    }
  }
  spawnSims();

  // ----- Drawing -----
  let camX = player.x, camY = player.y;

  function draw(){
    const ease = 0.18;
    const dx = player.x - camX, dy = player.y - camY;
    camX += dx * ease; camY += dy * ease;
    if (Math.abs(dx) < 0.002) camX = player.x;
    if (Math.abs(dy) < 0.002) camY = player.y;

    const worldLeft = Math.floor(camX - VIEW_W/2);
    const worldTop  = Math.floor(camY - VIEW_H/2);
    ctx.clearRect(0,0,cvs.width,cvs.height);

    // Tiles
    for(let ty=0; ty<VIEW_H; ty++){
      for(let tx=0; tx<VIEW_W; tx++){
        const gx = worldLeft + tx, gy = worldTop + ty;
        ctx.fillStyle = ((gx+gy)&1) ? '#7cc57a' : '#67b86a';
        const px = (gx - camX + VIEW_W/2) * TILE;
        const py = (gy - camY + VIEW_H/2) * TILE;
        ctx.fillRect(px, py, TILE, TILE);
      }
    }

    // NPC
    const nx = npc.x - camX + VIEW_W/2, ny = npc.y - camY + VIEW_W/2;
    if(nx>-1 && nx<VIEW_W+1 && ny>-1 && ny<VIEW_H+1){
      ctx.fillStyle='#f4a261'; ctx.fillRect(nx*TILE, ny*TILE, TILE, TILE);
      ctx.fillStyle='white'; ctx.font='12px monospace'; ctx.fillText(npc.name, nx*TILE, ny*TILE-5);
    }
    
    // Boss
    if(worldBoss){
      const bx = worldBoss.x - camX + VIEW_W/2, by = worldBoss.y - camY + VIEW_H/2;
       if(bx>-1 && bx<VIEW_W+1 && by>-1 && by<VIEW_H+1){
         ctx.fillStyle='#5eead4'; ctx.fillRect(bx*TILE, by*TILE, TILE, TILE);
         ctx.fillText("BOSS", bx*TILE, by*TILE-5);
       }
    }

    // Sims
    sims.forEach(s=>{
      const sx = s.x - camX + VIEW_W/2, sy = s.y - camY + VIEW_W/2;
      if(sx>=-1 && sx<VIEW_W+1 && sy>=-1 && sy<VIEW_H+1){
        if(s.type.img) ctx.drawImage(s.type.img, sx*TILE, sy*TILE, TILE, TILE);
        else {
          const cols=['#ff595e','#8ac926','#1982c4','#ffd166','#6c5ce7','#00cec9','#b392ff']; 
          ctx.fillStyle=cols[s.type.id%cols.length]; 
          ctx.fillRect(sx*TILE,sy*TILE,TILE,TILE);
        }
        // Rarity glow (simplified for performance)
        if(s.rarity==='Exotic'){ ctx.strokeStyle='white'; ctx.lineWidth=2; ctx.strokeRect(sx*TILE+2,sy*TILE+2,TILE-4,TILE-4); }
      }
    });

    // Multiplayer: Other Players
    for(let id in otherPlayers) {
        const p = otherPlayers[id];
        const px = (p.x - camX + VIEW_W/2)*TILE;
        const py = (p.y - camY + VIEW_H/2)*TILE;
        if(px > -TILE && px < cvs.width && py > -TILE && py < cvs.height) {
            ctx.fillStyle = 'rgba(255,100,100,0.8)';
            ctx.fillRect(px+8, py+8, TILE-16, TILE-16);
            ctx.fillStyle = 'white'; ctx.font='10px sans-serif'; ctx.textAlign='center';
            ctx.fillText(id.substring(0,8), px+32, py-4);
        }
    }

    // Player
    const px = (player.x - camX + VIEW_W/2)*TILE, py = (player.y - camY + VIEW_W/2)*TILE;
    if(player.img) ctx.drawImage(player.img, px, py, TILE, TILE); 
    else { ctx.fillStyle='#1d3557'; ctx.fillRect(px, py, TILE, TILE); }
    
    // Suit
    if(equippedSuit !== null && suits[equippedSuit] && suits[equippedSuit].img){
      try{ ctx.drawImage(suits[equippedSuit].img, px, py, TILE, TILE); }catch(e){}
    }
  }

  // ----- Movement -----
  function move(dx,dy){
    if(mode === 'battle') return;
    ensureAudio();
    const nx = Math.max(0, Math.min(MAP_W-1, player.x + dx));
    const ny = Math.max(0, Math.min(MAP_H-1, player.y + dy));
    if(nx === player.x && ny === player.y) return;
    player.x = nx; player.y = ny;
    sfx.step();
    checkTileInteraction();
    draw(); drawMini();
    
    // Firebase Update (Throttled)
    if(db && player.name) {
        const now = Date.now();
        if(now - lastNetUpdate > 150) {
            db.ref("players/" + player.name).update({ x:player.x, y:player.y, ts:now });
            lastNetUpdate = now;
        }
    }
  }
  function wirePad(id,dx,dy){
    const el = document.getElementById(id);
    let intv;
    const down = (e)=>{ e?.preventDefault(); move(dx,dy); intv=setInterval(()=>move(dx,dy), 160); };
    const up = ()=>{ clearInterval(intv); };
    el.addEventListener('mousedown', down); el.addEventListener('touchstart', down, {passive:false});
    el.addEventListener('mouseup', up); el.addEventListener('touchend', up);
    el.addEventListener('mouseleave', up); el.addEventListener('click', e=>e.preventDefault());
  }
  wirePad('padUp',0,-1); wirePad('padDown',0,1); wirePad('padLeft',-1,0); wirePad('padRight',1,0);
  window.addEventListener('keydown', e=>{ const k=e.key.toLowerCase(); if(k==='arrowup'||k==='w') move(0,-1); if(k==='arrowdown'||k==='s') move(0,1); if(k==='arrowleft'||k==='a') move(-1,0); if(k==='arrowright'||k==='d') move(1,0); });

  // ----- UI wiring -----
  function panel(id, show){
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('show'));
    if(show) document.getElementById(id).classList.add('show');
  }
  function showWin(sel){ document.querySelector(sel).classList.add('show'); }
  function hideWin(sel){ document.querySelector(sel).classList.remove('show'); }
  document.querySelectorAll('.closeX').forEach(btn=>btn.addEventListener('click', ()=>{ hideWin(btn.dataset.close); }));

  document.getElementById('btnSignIn').addEventListener('click', ()=>{
    const n=document.getElementById('playerName').value.trim();
    if(!n) return alert('Enter name');
    player.name=n;
    // Load Firebase Profile
    if(db) {
        db.ref("profiles/"+n).once('value').then(snap => {
            const d = snap.val();
            if(d) {
                player.xp = d.xp || 0; player.level = d.level || 1;
                coins = d.coins || 0; sapphires = d.sapphires || 0;
                updateXPUI();
            }
        });
        // Listen for others
        db.ref("players").on("value", snap => {
            const all = snap.val() || {};
            otherPlayers = {};
            for(let k in all) if(k !== player.name) otherPlayers[k] = all[k];
        });
        window.addEventListener("beforeunload", () => db.ref("players/"+player.name).remove());
    }
    
    document.getElementById('signin-area').style.display='none';
    document.getElementById('menu-main').style.display='flex';
  });

  document.getElementById('btnStart').addEventListener('click', ()=>{
    mode='world';
    document.getElementById('menu').style.display='none'; 
    panel('menu', false);
    document.getElementById('hud').style.display='flex';
    document.getElementById('dpad').style.display = /Mobi/i.test(navigator.userAgent) ? 'grid' : 'none';
    draw(); drawMini();
    startMusic();
    updateCoinsUI(); buildShop(); buildQuests(); buildSuitUI();
  });
  
  document.getElementById('btnOpenSettings').onclick = ()=>showWin('#settingsWin');
  document.getElementById('btnSettings').onclick = ()=>showWin('#settingsWin');
  document.getElementById('btnDex').onclick = ()=>{ buildDex(); panel('dex', true); };
  document.getElementById('btnOpenDexPanel').onclick = ()=>{ buildDex(); panel('dex', true); };
  document.getElementById('btnCloseDex').onclick = ()=>panel('dex', false);
  document.getElementById('btnShop').onclick = ()=>{ buildShop(); showWin('#shopWin'); };
  document.getElementById('btnQuests').onclick = ()=>{ buildQuests(); showWin('#questWin'); };

  // ----- Suit & Settings Logic -----
  function buildSuitUI(){
    const container = document.getElementById('suitArea'); container.innerHTML = '';
    suits.forEach(s=>{
      const slot = document.createElement('div'); slot.className='suitSlot';
      slot.innerHTML = `
        <div style="width:48px;height:48px;background:#0b150e;border-radius:6px;">${s.img?'<img src="'+s.src+'" style="width:100%;height:100%">':s.name}</div>
        <div class="meta" style="margin-left:10px"><div class="name">${s.name}</div><div class="owned">${s.owned?'Unlocked':'Locked'}</div></div>
        <button class="btn" onclick="buyEquipSuit(${s.id})">${s.owned?(equippedSuit===s.id?'Unequip':'Equip'):'Buy (500)'}</button>
      `;
      container.appendChild(slot);
    });
  }
  window.buyEquipSuit = (id) => {
      const s = suits[id];
      if(!s.owned) {
          if(sapphires<500) return alert("Need 500 Sapphires");
          sapphires-=500; s.owned=true; updateCoinsUI();
      } else {
          equippedSuit = (equippedSuit===id) ? null : id;
      }
      buildSuitUI(); saveGame();
  };
  
  // ----- SimDex -----
  function buildDex(){
    const grid=document.getElementById('dexGrid'); grid.innerHTML='';
    const keys=Object.keys(simdex);
    if(!keys.length){ grid.innerHTML='<p style="opacity:.8">No Simitaurs caught yet.</p>'; return; }
    keys.forEach(k=>{
      const d=simdex[k];
      const el=document.createElement('div'); el.className='dexCard';
      el.style.background = 'rgba(255,255,255,0.05)'; el.style.padding = '10px'; el.style.borderRadius='8px';
      el.innerHTML=`<b>${d.name}</b><br>${d.rarity}`;
      grid.appendChild(el);
    });
  }

  // ----- Encounters & Battle -----
  function checkTileInteraction(){
    if(worldBoss && player.x===worldBoss.x && player.y===worldBoss.y){
        panel('bossPanel', true); return;
    }
    const wild = sims.find(s=> s.x===player.x && s.y===player.y);
    if(wild){
      currentEncounter = wild;
      panel('encounterPanel', true);
      document.getElementById('encounterTitle').textContent = `Wild ${wild.type.name}!`;
    }
  }
  
  document.getElementById('btnRun').onclick = ()=>{ currentEncounter=null; panel('encounterPanel', false); sfx.escape(); };
  
  document.getElementById('btnFight').onclick = ()=>{
      if(!player.sims.length) { player.sims.push({type:types[0],hp:40,maxHp:40,attacks:[{name:'Hit',dmg:10}]}); }
      battlePlayerSim = player.sims[0];
      battleEnemySim = currentEncounter;
      panel('encounterPanel', false);
      panel('battlePanel', true);
      updateBattleUI();
  };
  
  document.getElementById('btnCatchSim').onclick = ()=>{
      sfx.catch();
      const s = currentEncounter;
      if(Math.random() > 0.4) {
          alert("Caught!");
          simdex[Date.now()] = s;
          player.sims.push(s);
          sims = sims.filter(x=>x!==s);
          gainXP(25);
      } else { alert("Escaped!"); }
      panel('encounterPanel', false);
      currentEncounter=null;
  };
  
  function updateBattleUI(){
      document.getElementById('hpYou').style.width = (battlePlayerSim.hp/battlePlayerSim.maxHp*100)+'%';
      document.getElementById('hpEnemy').style.width = (battleEnemySim.hp/battleEnemySim.maxHp*100)+'%';
      const div = document.getElementById('battleButtons'); div.innerHTML='';
      const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Attack';
      btn.onclick = ()=>{
          sfx.atk();
          battleEnemySim.hp -= 15;
          updateBattleUI();
          if(battleEnemySim.hp<=0){
              setTimeout(()=>{ alert("Won!"); panel('battlePanel',false); gainXP(50); sims=sims.filter(x=>x!==currentEncounter); currentEncounter=null; },500);
          } else {
              setTimeout(()=>{ battlePlayerSim.hp-=10; updateBattleUI(); }, 500);
          }
      };
      div.appendChild(btn);
  }
  document.getElementById('btnRunBattle').onclick = ()=>{ panel('battlePanel', false); };

  // ----- Shop (Restored) -----
  function buildShop(){
      const l = document.getElementById('healList'); l.innerHTML='';
      player.sims.forEach(s=>{
          const r = document.createElement('div'); r.className='healRow';
          r.innerHTML = `<b>${s.type.name}</b> HP:${s.hp}/${s.maxHp} <button class="btn" onclick="healSim(this)">Heal (10)</button>`;
          r.querySelector('button').onclick = ()=>{
              if(coins>=10){ coins-=10; s.hp=s.maxHp; updateCoinsUI(); buildShop(); sfx.heal(); saveGame(); }
          };
          l.appendChild(r);
      });
  }

  // ----- Coins -----
  function updateCoinsUI(){ 
      document.getElementById('coinLabel').textContent = coins; 
      document.getElementById('sapphireLabel').textContent = sapphires;
  }

  // ----- Minimap -----
  let miniVisible = true;
  document.getElementById('btnMini').onclick = ()=>{
    miniVisible = !miniVisible;
    document.getElementById('minimap').style.display = miniVisible?'block':'none';
  };
  function drawMini(){
    if(!miniVisible) return;
    mctx.fillStyle='#0b140c'; mctx.fillRect(0,0,160,160);
    sims.forEach(s=>{
      const x=Math.floor(s.x/MAP_W*160), y=Math.floor(s.y/MAP_H*160);
      mctx.fillStyle='#4fd1c5'; mctx.fillRect(x,y,2,2);
    });
    const px=Math.floor(player.x/MAP_W*160), py=Math.floor(player.y/MAP_H*160);
    mctx.fillStyle='#00ff85'; mctx.fillRect(px-2,py-2,5,5);
  }

  // Loop
  function loop(){
      if(mode==='world') draw();
      requestAnimationFrame(loop);
  }
  loop();

  // Loading Screen
  window.onload = ()=>{
      setTimeout(()=>{ document.getElementById('loadingScreen').style.opacity=0; setTimeout(()=>document.getElementById('loadingScreen').remove(),500); }, 1500);
  };
  
})();
</script>
</body>
</html>
