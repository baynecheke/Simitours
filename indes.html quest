<script>
(() => {
  // ===== Extra Game State =====
  let coins = 20;
  const quests = [
    {id:1, text:"Catch 5 Simitaurs (Reward: 50 coins)", goal:5, progress:0, reward:50, type:"simitaur", completed:false},
    {id:2, text:"Catch 1 Exotic Simitaur (Reward: 100 coins)", goal:1, progress:0, reward:100, type:"Exotic", completed:false}
  ];

  // ===== HUD Additions =====
  const hud = document.getElementById('hud');
  const coinBox = document.createElement('div');
  coinBox.id = 'coinBox';
  coinBox.style.cssText = "background:#ffd166;color:#222;font-weight:bold;padding:6px 12px;border-radius:16px;align-self:center;";
  coinBox.textContent = "ðŸ’° " + coins;
  hud.prepend(coinBox);

  const shopBtn = document.createElement('button');
  shopBtn.id = 'btnShop';
  shopBtn.className = 'pill';
  shopBtn.textContent = 'Shop';
  hud.appendChild(shopBtn);

  const questBtn = document.createElement('button');
  questBtn.id = 'btnQuest';
  questBtn.className = 'pill';
  questBtn.textContent = 'Quests';
  hud.appendChild(questBtn);

  // ===== Panels =====
  const shopPanel = document.createElement('div');
  shopPanel.id = 'shopPanel';
  shopPanel.className = 'panel';
  shopPanel.innerHTML = `
    <div class="box" style="max-width:400px">
      <h2>Marketplace</h2>
      <p>Select a Sim to heal (5 coins):</p>
      <div id="simdexList"></div>
      <div style="text-align:center;margin-top:10px"><button id="btnCloseShop" class="btn">Close</button></div>
    </div>`;
  document.body.appendChild(shopPanel);

  const questPanel = document.createElement('div');
  questPanel.id = 'questPanel';
  questPanel.className = 'panel';
  questPanel.innerHTML = `
    <div class="box" style="max-width:500px">
      <h2>Quests</h2>
      <div id="questList"></div>
      <div style="text-align:center;margin-top:10px"><button id="btnCloseQuest" class="btn">Close</button></div>
    </div>`;
  document.body.appendChild(questPanel);

  // ===== Functions =====
  function updateCoins(amount){
    coins += amount;
    document.getElementById('coinBox').textContent = "ðŸ’° " + coins;
  }

  function renderShop(){
    const list = document.getElementById('simdexList');
    list.innerHTML = '';
    if(window.Simitaur?.player?.sims?.length){
      window.Simitaur.player.sims.forEach((sim,i)=>{
        const div = document.createElement('div');
        div.style.marginBottom = '10px';
        div.innerHTML = `<b>${sim.type.name}</b> â€” HP: ${sim.hp}/${sim.maxHp}`;
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = 'Heal (5 coins)';
        btn.onclick = ()=> healSim(sim);
        div.appendChild(btn);
        list.appendChild(div);
      });
    } else {
      list.innerHTML = '<p style="opacity:.8">No Sims in your team.</p>';
    }
  }

  function healSim(sim){
    if(coins < 5) return alert("Not enough coins!");
    if(sim.hp >= sim.maxHp) return alert(sim.type.name + " is already at full HP!");
    coins -= 5;
    sim.hp = sim.maxHp;
    updateCoins(0);
    renderShop();
  }

  function renderQuests(){
    const list = document.getElementById('questList');
    list.innerHTML = '';
    quests.forEach(q=>{
      const div = document.createElement('div');
      div.style.marginBottom = '12px';
      div.innerHTML = `<b>${q.text}</b><br>Progress: ${q.progress}/${q.goal}<br>`;
      if(!q.completed && q.progress >= q.goal){
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = 'Claim Reward';
        btn.onclick = ()=>{
          updateCoins(q.reward);
          q.completed = true;
          renderQuests();
        };
        div.appendChild(btn);
      } else if(q.completed){
        div.innerHTML += `<i>Completed âœ…</i>`;
      }
      list.appendChild(div);
    });
  }

  // ===== Wire Buttons =====
  function panel(id, show){
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('show'));
    if(show) document.getElementById(id).classList.add('show');
  }

  document.getElementById('btnShop').onclick = ()=>{ renderShop(); panel('shopPanel', true); };
  document.getElementById('btnQuest').onclick = ()=>{ renderQuests(); panel('questPanel', true); };
  document.getElementById('btnCloseShop').onclick = ()=>panel('shopPanel', false);
  document.getElementById('btnCloseQuest').onclick = ()=>panel('questPanel', false);

  // ===== Hook into SimDex updates =====
  const oldBuildDex = window.Simitaur ? window.Simitaur.buildDex : null;
  if(oldBuildDex){
    window.Simitaur.buildDex = function(){
      oldBuildDex();
      // update quest progress for "catch" type
      const keys = Object.keys(window.Simitaur.simdex||{});
      quests.forEach(q=>{
        if(q.type.toLowerCase()==='simitaur') q.progress = keys.length;
        if(q.type.toLowerCase()==='exotic'){
          q.progress = keys.filter(k=>window.Simitaur.simdex[k].rarity==='Exotic').length;
        }
      });
    };
  }

  // initial coin display
  updateCoins(0);
})();
</script>

